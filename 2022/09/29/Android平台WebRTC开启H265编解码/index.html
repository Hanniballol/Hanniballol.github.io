<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Android平台WebRTC开启H265编解码 - Hanniballol&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Hanniballol&#039;s Blog"><meta name="msapplication-TileImage" content="/images/avatar.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Hanniballol&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="不像H264，WebRTC已经在内部处理好了相关逻辑，我们只需要稍作修改即可实现H264编解码（硬编只需指定sdp，软编只需打开开关@see 《Android平台WebRTC开启H264软编解码》）。如要实现H265，不仅要增加接口，还需要添加封解RTP包的逻辑。"><meta property="og:type" content="blog"><meta property="og:title" content="Android平台WebRTC开启H265编解码"><meta property="og:url" content="http://hanniballol.github.io/2022/09/29/Android%E5%B9%B3%E5%8F%B0WebRTC%E5%BC%80%E5%90%AFH265%E7%BC%96%E8%A7%A3%E7%A0%81/"><meta property="og:site_name" content="Hanniballol&#039;s Blog"><meta property="og:description" content="不像H264，WebRTC已经在内部处理好了相关逻辑，我们只需要稍作修改即可实现H264编解码（硬编只需指定sdp，软编只需打开开关@see 《Android平台WebRTC开启H264软编解码》）。如要实现H265，不仅要增加接口，还需要添加封解RTP包的逻辑。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://hanniballol.github.io/images/H265_s1.jpg"><meta property="article:published_time" content="2022-09-29T03:41:08.000Z"><meta property="article:modified_time" content="2022-09-30T09:12:54.496Z"><meta property="article:author" content="8MilesRD"><meta property="article:tag" content="Android"><meta property="article:tag" content="shell"><meta property="article:tag" content="C/C++"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/images/H265_s1.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://hanniballol.github.io/2022/09/29/Android%E5%B9%B3%E5%8F%B0WebRTC%E5%BC%80%E5%90%AFH265%E7%BC%96%E8%A7%A3%E7%A0%81/"},"headline":"Android平台WebRTC开启H265编解码","image":["http://hanniballol.github.io/images/H265_s1.jpg"],"datePublished":"2022-09-29T03:41:08.000Z","dateModified":"2022-09-30T09:12:54.496Z","author":{"@type":"Person","name":"8MilesRD"},"publisher":{"@type":"Organization","name":"Hanniballol's Blog","logo":{"@type":"ImageObject","url":"http://hanniballol.github.io/images/favicon.ico"}},"description":"不像H264，WebRTC已经在内部处理好了相关逻辑，我们只需要稍作修改即可实现H264编解码（硬编只需指定sdp，软编只需打开开关@see 《Android平台WebRTC开启H264软编解码》）。如要实现H265，不仅要增加接口，还需要添加封解RTP包的逻辑。"}</script><link rel="canonical" href="http://hanniballol.github.io/2022/09/29/Android%E5%B9%B3%E5%8F%B0WebRTC%E5%BC%80%E5%90%AFH265%E7%BC%96%E8%A7%A3%E7%A0%81/"><link rel="icon" href="/images/avatar.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?3ac5fec66a25a7e2f71b2fe8b0ba53df";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><script data-ad-client="ca-pub-1027133152234043" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/favicon.ico" alt="Hanniballol&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/images/H265_s1.jpg" alt="Android平台WebRTC开启H265编解码"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-09-29T03:41:08.000Z" title="2022/9/29 11:41:08">2022-09-29</time>发表</span><span class="level-item"><time dateTime="2022-09-30T09:12:54.496Z" title="2022/9/30 17:12:54">2022-09-30</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/WebRTC/">WebRTC</a></span><span class="level-item">2 小时读完 (大约16454个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">Android平台WebRTC开启H265编解码</h1><div class="content"><p>不像H264，WebRTC已经在内部处理好了相关逻辑，我们只需要稍作修改即可实现H264编解码（硬编只需指定sdp，软编只需打开开关@see <strong>《Android平台WebRTC开启H264软编解码》</strong>）。如要实现H265，不仅要增加接口，还需要添加封解RTP包的逻辑。</p>
<span id="more"></span>

<h3 id="开启H265编解码"><a href="#开启H265编解码" class="headerlink" title="开启H265编解码"></a>开启H265编解码</h3><h4 id="打开支持"><a href="#打开支持" class="headerlink" title="打开支持"></a>打开支持</h4><ul>
<li>增加sdp支持：</li>
</ul>
<figure class="highlight java"><figcaption><span>sdk/android/api/org/webrtc/HardwareVideoEncoderFactory.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> VideoCodecInfo[] getSupportedCodecs() &#123;<br>...<br>    <span class="hljs-keyword">for</span> (VideoCodecMimeType type : <span class="hljs-keyword">new</span> <span class="hljs-title class_">VideoCodecMimeType</span>[] &#123;<br>         VideoCodecMimeType.VP8, VideoCodecMimeType.VP9, VideoCodecMimeType.H264,<br>		    VideoCodecMimeType.H265&#125;)<br>...<br>    <span class="hljs-keyword">return</span> supportedCodecInfos.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">VideoCodecInfo</span>[supportedCodecInfos.size()]);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>增加sps/pps/vps支持：</li>
</ul>
<figure class="highlight java"><figcaption><span>sdk/android/src/java/org/webrtc/HardwareVideoEncoder.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deliverEncodedImage</span><span class="hljs-params">()</span> &#123;<br>...<br>    <span class="hljs-keyword">final</span> ByteBuffer frameBuffer;<br>    <span class="hljs-keyword">if</span> (isKeyFrame &amp;&amp; (codecType == VideoCodecMimeType.H264<br>                       || codecType == VideoCodecMimeType.H265))<br>          <br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="封包支持"><a href="#封包支持" class="headerlink" title="封包支持"></a>封包支持</h4><ul>
<li>增加解包器初始化入口</li>
</ul>
<figure class="highlight c++"><figcaption><span>modules/rtp_rtcp/source/create_video_rtp_depacketizer.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c++">...<br> <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/rtp_rtcp/source/video_rtp_depacketizer_h265.h&quot;</span></span><br> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>...<br><br> <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>   <span class="hljs-keyword">case</span> kVideoCodecH265:<br>     <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_unique</span>&lt;VideoRtpDepacketizerH265&gt;();<br> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>...<br></code></pre></td></tr></table></figure>

<ul>
<li>foramt基类增加H265支持</li>
</ul>
<figure class="highlight c++"><figcaption><span>modules/rtp_rtcp/source/rtp_format.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c++">...<br> <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/rtp_rtcp/source/rtp_format_h265.h&quot;</span></span><br> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>...<br> <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/video_coding/codecs/h265/include/h265_globals.h&quot;</span></span><br> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>...<br><span class="hljs-function">std::unique_ptr&lt;RtpPacketizer&gt; <span class="hljs-title">RtpPacketizer::Create</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    absl::optional&lt;VideoCodecType&gt; type,</span></span><br><span class="hljs-params"><span class="hljs-function">    rtc::ArrayView&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>&gt; payload,</span></span><br><span class="hljs-params"><span class="hljs-function">    PayloadSizeLimits limits,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-comment">// Codec-specific details.</span></span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> RTPVideoHeader&amp; rtp_video_header)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (!type) &#123;<br>    <span class="hljs-comment">// Use raw packetizer.</span><br>    <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_unique</span>&lt;RtpPacketizerGeneric&gt;(payload, limits);<br>  &#125;<br><br>  <span class="hljs-keyword">switch</span> (*type) &#123;<br>    <span class="hljs-keyword">case</span> kVideoCodecH264: &#123;<br>      <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; h264 =<br>          absl::<span class="hljs-built_in">get</span>&lt;RTPVideoHeaderH264&gt;(rtp_video_header.video_type_header);<br>      <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_unique</span>&lt;RtpPacketizerH264&gt;(payload, limits,<br>                                                 h264.packetization_mode);<br>    &#125;<br> <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>     <span class="hljs-keyword">case</span> kVideoCodecH265: &#123;<br>       <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; h265 =<br>           absl::<span class="hljs-built_in">get</span>&lt;RTPVideoHeaderH265&gt;(rtp_video_header.video_type_header);<br>       <span class="hljs-keyword">return</span> absl::<span class="hljs-built_in">make_unique</span>&lt;RtpPacketizerH265&gt;(<br>           payload, limits, h265.packetization_mode);<br>     &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>...<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>新增H265 format实现类<strong>rtp_format_h265</strong>：</li>
</ul>
<figure class="highlight c++"><figcaption><span>modules/rtp_rtcp/source/rtp_format_h265.cc >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;absl/types/optional.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;absl/types/variant.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h264/h264_common.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_common.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_pps_parser.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_sps_parser.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_vps_parser.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/include/module_common_types.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/rtp_rtcp/source/byte_io.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/rtp_rtcp/source/rtp_format_h265.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/rtp_rtcp/source/rtp_packet_to_send.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/logging.h&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> rtc;<br><br><span class="hljs-keyword">namespace</span> webrtc &#123;<br><span class="hljs-keyword">namespace</span> &#123;<br><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">NaluType</span> &#123;<br>  kTrailN = <span class="hljs-number">0</span>,<br>  kTrailR = <span class="hljs-number">1</span>,<br>  kTsaN = <span class="hljs-number">2</span>,<br>  kTsaR = <span class="hljs-number">3</span>,<br>  kStsaN = <span class="hljs-number">4</span>,<br>  kStsaR = <span class="hljs-number">5</span>,<br>  kRadlN = <span class="hljs-number">6</span>,<br>  kRadlR = <span class="hljs-number">7</span>,<br>  kBlaWLp = <span class="hljs-number">16</span>,<br>  kBlaWRadl = <span class="hljs-number">17</span>,<br>  kBlaNLp = <span class="hljs-number">18</span>,<br>  kIdrWRadl = <span class="hljs-number">19</span>,<br>  kIdrNLp = <span class="hljs-number">20</span>,<br>  kCra = <span class="hljs-number">21</span>,<br>  kVps = <span class="hljs-number">32</span>,<br>  kHevcSps = <span class="hljs-number">33</span>,<br>  kHevcPps = <span class="hljs-number">34</span>,<br>  kHevcAud = <span class="hljs-number">35</span>,<br>  kPrefixSei = <span class="hljs-number">39</span>,<br>  kSuffixSei = <span class="hljs-number">40</span>,<br>  kHevcAp = <span class="hljs-number">48</span>,<br>  kHevcFu = <span class="hljs-number">49</span><br>&#125;;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">   0                   1                   2                   3</span><br><span class="hljs-comment">   0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="hljs-comment">  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment">  |    PayloadHdr (Type=49)       |   FU header   | DONL (cond)   |</span><br><span class="hljs-comment">  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-|</span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">// Unlike H.264, HEVC NAL header is 2-bytes.</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> kHevcNalHeaderSize = <span class="hljs-number">2</span>;<br><span class="hljs-comment">// H.265&#x27;s FU is constructed of 2-byte payload header, and 1-byte FU header</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> kHevcFuHeaderSize = <span class="hljs-number">1</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> kHevcLengthFieldSize = <span class="hljs-number">2</span>;<br><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">HevcNalHdrMasks</span> &#123;<br>  kHevcFBit = <span class="hljs-number">0x80</span>,<br>  kHevcTypeMask = <span class="hljs-number">0x7E</span>,<br>  kHevcLayerIDHMask = <span class="hljs-number">0x1</span>,<br>  kHevcLayerIDLMask = <span class="hljs-number">0xF8</span>,<br>  kHevcTIDMask = <span class="hljs-number">0x7</span>,<br>  kHevcTypeMaskN = <span class="hljs-number">0x81</span>,<br>  kHevcTypeMaskInFuHeader = <span class="hljs-number">0x3F</span><br>&#125;;<br><br><span class="hljs-comment">// Bit masks for FU headers.</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">HevcFuDefs</span> &#123; kHevcSBit = <span class="hljs-number">0x80</span>, kHevcEBit = <span class="hljs-number">0x40</span>, kHevcFuTypeBit = <span class="hljs-number">0x3F</span> &#125;;<br><br>&#125;  <span class="hljs-comment">// namespace</span><br><br>RtpPacketizerH265::<span class="hljs-built_in">RtpPacketizerH265</span>(<br>    rtc::ArrayView&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>&gt; payload,<br>    PayloadSizeLimits limits,<br>    H265PacketizationMode packetization_mode)<br>    : <span class="hljs-built_in">limits_</span>(limits),<br>      <span class="hljs-built_in">num_packets_left_</span>(<span class="hljs-number">0</span>) &#123;<br>  <span class="hljs-comment">// Guard against uninitialized memory in packetization_mode.</span><br>  <span class="hljs-built_in">RTC_CHECK</span>(packetization_mode == H265PacketizationMode::NonInterleaved ||<br>            packetization_mode == H265PacketizationMode::SingleNalUnit);<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; nalu :<br>       H264::<span class="hljs-built_in">FindNaluIndices</span>(payload.<span class="hljs-built_in">data</span>(), payload.<span class="hljs-built_in">size</span>())) &#123;<br>    input_fragments_.<span class="hljs-built_in">push_back</span>(<br>        payload.<span class="hljs-built_in">subview</span>(nalu.payload_start_offset, nalu.payload_size));<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">GeneratePackets</span>(packetization_mode)) &#123;<br>    <span class="hljs-comment">// If failed to generate all the packets, discard already generated</span><br>    <span class="hljs-comment">// packets in case the caller would ignore return value and still try to</span><br>    <span class="hljs-comment">// call NextPacket().</span><br>    num_packets_left_ = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (!packets_.<span class="hljs-built_in">empty</span>()) &#123;<br>      packets_.<span class="hljs-built_in">pop</span>();<br>    &#125;<br>  &#125;<br>&#125;<br><br>RtpPacketizerH265::~<span class="hljs-built_in">RtpPacketizerH265</span>() &#123;&#125;<br><br><span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">RtpPacketizerH265::NumPackets</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> num_packets_left_;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">RtpPacketizerH265::GeneratePackets</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    H265PacketizationMode packetization_mode)</span> </span>&#123;<br>  <span class="hljs-comment">// For HEVC we follow non-interleaved mode for the packetization,</span><br>  <span class="hljs-comment">// and don&#x27;t support single-nalu mode at present.</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; input_fragments_.<span class="hljs-built_in">size</span>();) &#123;<br>    <span class="hljs-type">int</span> fragment_len = input_fragments_[i].<span class="hljs-built_in">size</span>();<br>    <span class="hljs-type">int</span> single_packet_capacity = limits_.max_payload_len;<br>    <span class="hljs-keyword">if</span> (input_fragments_.<span class="hljs-built_in">size</span>() == <span class="hljs-number">1</span>)<br>      single_packet_capacity -= limits_.single_packet_reduction_len;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>)<br>      single_packet_capacity -= limits_.first_packet_reduction_len;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i + <span class="hljs-number">1</span> == input_fragments_.<span class="hljs-built_in">size</span>()) &#123;<br>      <span class="hljs-comment">// Pretend that last fragment is larger instead of making last packet</span><br>      <span class="hljs-comment">// smaller.</span><br>      single_packet_capacity -= limits_.last_packet_reduction_len;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (fragment_len &gt; single_packet_capacity) &#123;<br>      <span class="hljs-built_in">PacketizeFu</span>(i);<br>      ++i;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-built_in">PacketizeSingleNalu</span>(i);<br>      ++i;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">RtpPacketizerH265::PacketizeFu</span><span class="hljs-params">(<span class="hljs-type">size_t</span> fragment_index)</span> </span>&#123;<br>  <span class="hljs-comment">// Fragment payload into packets (FU).</span><br>  <span class="hljs-comment">// Strip out the original header and leave room for the FU header.</span><br>  rtc::ArrayView&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>&gt; fragment = input_fragments_[fragment_index];<br>  PayloadSizeLimits limits = limits_;<br>  limits.max_payload_len -= kHevcFuHeaderSize + kHevcNalHeaderSize;<br><br>  <span class="hljs-comment">// Update single/first/last packet reductions unless it is single/first/last</span><br>  <span class="hljs-comment">// fragment.</span><br>  <span class="hljs-keyword">if</span> (input_fragments_.<span class="hljs-built_in">size</span>() != <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-comment">// if this fragment is put into a single packet, it might still be the</span><br>    <span class="hljs-comment">// first or the last packet in the whole sequence of packets.</span><br>    <span class="hljs-keyword">if</span> (fragment_index == input_fragments_.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>) &#123;<br>      limits.single_packet_reduction_len = limits_.last_packet_reduction_len;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fragment_index == <span class="hljs-number">0</span>) &#123;<br>      limits.single_packet_reduction_len = limits_.first_packet_reduction_len;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      limits.single_packet_reduction_len = <span class="hljs-number">0</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (fragment_index != <span class="hljs-number">0</span>)<br>    limits.first_packet_reduction_len = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> (fragment_index != input_fragments_.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>)<br>    limits.last_packet_reduction_len = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">// Strip out the original header.</span><br>  <span class="hljs-type">size_t</span> payload_left = fragment.<span class="hljs-built_in">size</span>() - kHevcNalHeaderSize;<br>  <span class="hljs-type">int</span> offset = kHevcNalHeaderSize;<br><br>  std::vector&lt;<span class="hljs-type">int</span>&gt; payload_sizes = <span class="hljs-built_in">SplitAboutEqually</span>(payload_left, limits);<br>  <span class="hljs-keyword">if</span> (payload_sizes.<span class="hljs-built_in">empty</span>())<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; payload_sizes.<span class="hljs-built_in">size</span>(); ++i) &#123;<br>    <span class="hljs-type">int</span> packet_length = payload_sizes[i];<br>    <span class="hljs-built_in">RTC_CHECK_GT</span>(packet_length, <span class="hljs-number">0</span>);<br>    <span class="hljs-type">uint16_t</span> header = (fragment[<span class="hljs-number">0</span>] &lt;&lt; <span class="hljs-number">8</span>) | fragment[<span class="hljs-number">1</span>];<br>    packets_.<span class="hljs-built_in">push</span>(<span class="hljs-built_in">PacketUnit</span>(fragment.<span class="hljs-built_in">subview</span>(offset, packet_length),<br>                             <span class="hljs-comment">/*first_fragment=*/</span>i == <span class="hljs-number">0</span>,<br>                             <span class="hljs-comment">/*last_fragment=*/</span>i == payload_sizes.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>,<br>                             <span class="hljs-literal">false</span>, header));<br>    offset += packet_length;<br>    payload_left -= packet_length;<br>  &#125;<br>  num_packets_left_ += payload_sizes.<span class="hljs-built_in">size</span>();<br>  <span class="hljs-built_in">RTC_CHECK_EQ</span>(<span class="hljs-number">0</span>, payload_left);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">RtpPacketizerH265::PacketizeSingleNalu</span><span class="hljs-params">(<span class="hljs-type">size_t</span> fragment_index)</span> </span>&#123;<br>  <span class="hljs-comment">// Add a single NALU to the queue, no aggregation.</span><br>  <span class="hljs-type">size_t</span> payload_size_left = limits_.max_payload_len;<br>  <span class="hljs-keyword">if</span> (input_fragments_.<span class="hljs-built_in">size</span>() == <span class="hljs-number">1</span>)<br>    payload_size_left -= limits_.single_packet_reduction_len;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fragment_index == <span class="hljs-number">0</span>)<br>    payload_size_left -= limits_.first_packet_reduction_len;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fragment_index + <span class="hljs-number">1</span> == input_fragments_.<span class="hljs-built_in">size</span>())<br>    payload_size_left -= limits_.last_packet_reduction_len;<br>  rtc::ArrayView&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>&gt; fragment = input_fragments_[fragment_index];<br>  <span class="hljs-keyword">if</span> (payload_size_left &lt; fragment.<span class="hljs-built_in">size</span>()) &#123;<br>    <span class="hljs-built_in">RTC_LOG</span>(LS_ERROR) &lt;&lt; <span class="hljs-string">&quot;Failed to fit a fragment to packet in SingleNalu &quot;</span><br>                         <span class="hljs-string">&quot;packetization mode. Payload size left &quot;</span><br>                      &lt;&lt; payload_size_left &lt;&lt; <span class="hljs-string">&quot;, fragment length &quot;</span><br>                      &lt;&lt; fragment.<span class="hljs-built_in">size</span>() &lt;&lt; <span class="hljs-string">&quot;, packet capacity &quot;</span><br>                      &lt;&lt; limits_.max_payload_len;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br>  <span class="hljs-built_in">RTC_CHECK_GT</span>(fragment.<span class="hljs-built_in">size</span>(), <span class="hljs-number">0u</span>);<br>  packets_.<span class="hljs-built_in">push</span>(<span class="hljs-built_in">PacketUnit</span>(fragment, <span class="hljs-literal">true</span> <span class="hljs-comment">/* first */</span>, <span class="hljs-literal">true</span> <span class="hljs-comment">/* last */</span>,<br>                           <span class="hljs-literal">false</span> <span class="hljs-comment">/* aggregated */</span>, fragment[<span class="hljs-number">0</span>]));<br>  ++num_packets_left_;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">RtpPacketizerH265::PacketizeAp</span><span class="hljs-params">(<span class="hljs-type">size_t</span> fragment_index)</span> </span>&#123;<br>  <span class="hljs-comment">// Aggregate fragments into one packet (STAP-A).</span><br>  <span class="hljs-type">size_t</span> payload_size_left = limits_.max_payload_len;<br>  <span class="hljs-keyword">if</span> (input_fragments_.<span class="hljs-built_in">size</span>() == <span class="hljs-number">1</span>)<br>    payload_size_left -= limits_.single_packet_reduction_len;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fragment_index == <span class="hljs-number">0</span>)<br>    payload_size_left -= limits_.first_packet_reduction_len;<br>  <span class="hljs-type">int</span> aggregated_fragments = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">size_t</span> fragment_headers_length = <span class="hljs-number">0</span>;<br>  rtc::ArrayView&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>&gt; fragment = input_fragments_[fragment_index];<br>  <span class="hljs-built_in">RTC_CHECK_GE</span>(payload_size_left, fragment.<span class="hljs-built_in">size</span>());<br>  ++num_packets_left_;<br><br>  <span class="hljs-keyword">auto</span> payload_size_needed = [&amp;] &#123;<br>    <span class="hljs-type">size_t</span> fragment_size = fragment.<span class="hljs-built_in">size</span>() + fragment_headers_length;<br>    <span class="hljs-keyword">if</span> (input_fragments_.<span class="hljs-built_in">size</span>() == <span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-comment">// Single fragment, single packet, payload_size_left already adjusted</span><br>      <span class="hljs-comment">// with limits_.single_packet_reduction_len.</span><br>      <span class="hljs-keyword">return</span> fragment_size;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (fragment_index == input_fragments_.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-comment">// Last fragment, so StrapA might be the last packet.</span><br>      <span class="hljs-keyword">return</span> fragment_size + limits_.last_packet_reduction_len;<br>    &#125;<br>    <span class="hljs-keyword">return</span> fragment_size;<br>  &#125;;<br><br>  <span class="hljs-keyword">while</span> (payload_size_left &gt;= <span class="hljs-built_in">payload_size_needed</span>()) &#123;<br>    <span class="hljs-built_in">RTC_CHECK_GT</span>(fragment.<span class="hljs-built_in">size</span>(), <span class="hljs-number">0</span>);<br>    packets_.<span class="hljs-built_in">push</span>(<span class="hljs-built_in">PacketUnit</span>(fragment, aggregated_fragments == <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>,<br>                             fragment[<span class="hljs-number">0</span>]));<br>    payload_size_left -= fragment.<span class="hljs-built_in">size</span>();<br>    payload_size_left -= fragment_headers_length;<br><br>    fragment_headers_length = kHevcLengthFieldSize;<br>    <span class="hljs-comment">// If we are going to try to aggregate more fragments into this packet</span><br>    <span class="hljs-comment">// we need to add the STAP-A NALU header and a length field for the first</span><br>    <span class="hljs-comment">// NALU of this packet.</span><br>    <span class="hljs-keyword">if</span> (aggregated_fragments == <span class="hljs-number">0</span>)<br>      fragment_headers_length += kHevcNalHeaderSize + kHevcLengthFieldSize;<br>    ++aggregated_fragments;<br><br>    <span class="hljs-comment">// Next fragment.</span><br>    ++fragment_index;<br>    <span class="hljs-keyword">if</span> (fragment_index == input_fragments_.<span class="hljs-built_in">size</span>())<br>      <span class="hljs-keyword">break</span>;<br>    fragment = input_fragments_[fragment_index];<br>  &#125;<br>  <span class="hljs-built_in">RTC_CHECK_GT</span>(aggregated_fragments, <span class="hljs-number">0</span>);<br>  packets_.<span class="hljs-built_in">back</span>().last_fragment = <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">return</span> fragment_index;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">RtpPacketizerH265::NextPacket</span><span class="hljs-params">(RtpPacketToSend* rtp_packet)</span> </span>&#123;<br>  <span class="hljs-built_in">RTC_DCHECK</span>(rtp_packet);<br><br>  <span class="hljs-keyword">if</span> (packets_.<span class="hljs-built_in">empty</span>()) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  PacketUnit packet = packets_.<span class="hljs-built_in">front</span>();<br><br>  <span class="hljs-keyword">if</span> (packet.first_fragment &amp;&amp; packet.last_fragment) &#123;<br>    <span class="hljs-comment">// Single NAL unit packet.</span><br>    <span class="hljs-type">size_t</span> bytes_to_send = packet.source_fragment.<span class="hljs-built_in">size</span>();<br>    <span class="hljs-type">uint8_t</span>* buffer = rtp_packet-&gt;<span class="hljs-built_in">AllocatePayload</span>(bytes_to_send);<br>    <span class="hljs-built_in">memcpy</span>(buffer, packet.source_fragment.<span class="hljs-built_in">data</span>(), bytes_to_send);<br>    packets_.<span class="hljs-built_in">pop</span>();<br>    input_fragments_.<span class="hljs-built_in">pop_front</span>();<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (packet.aggregated) &#123;<br>    <span class="hljs-type">bool</span> is_last_packet = num_packets_left_ == <span class="hljs-number">1</span>;<br>    <span class="hljs-built_in">NextAggregatePacket</span>(rtp_packet, is_last_packet);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">NextFragmentPacket</span>(rtp_packet);<br>  &#125;<br>  rtp_packet-&gt;<span class="hljs-built_in">SetMarker</span>(packets_.<span class="hljs-built_in">empty</span>());<br>  --num_packets_left_;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RtpPacketizerH265::NextAggregatePacket</span><span class="hljs-params">(RtpPacketToSend* rtp_packet,</span></span><br><span class="hljs-params"><span class="hljs-function">                                            <span class="hljs-type">bool</span> last)</span> </span>&#123;<br>  <span class="hljs-type">size_t</span> payload_capacity = rtp_packet-&gt;<span class="hljs-built_in">FreeCapacity</span>();<br>  <span class="hljs-built_in">RTC_CHECK_GE</span>(payload_capacity, kHevcNalHeaderSize);<br>  <span class="hljs-type">uint8_t</span>* buffer = rtp_packet-&gt;<span class="hljs-built_in">AllocatePayload</span>(payload_capacity);<br>  <span class="hljs-built_in">RTC_CHECK</span>(buffer);<br>  PacketUnit* packet = &amp;packets_.<span class="hljs-built_in">front</span>();<br>  <span class="hljs-built_in">RTC_CHECK</span>(packet-&gt;first_fragment);<br>  <span class="hljs-type">uint8_t</span> payload_hdr_h = packet-&gt;header &gt;&gt; <span class="hljs-number">8</span>;<br>  <span class="hljs-type">uint8_t</span> payload_hdr_l = packet-&gt;header &amp; <span class="hljs-number">0xFF</span>;<br>  <span class="hljs-type">uint8_t</span> layer_id_h = payload_hdr_h &amp; kHevcLayerIDHMask;<br><br>  payload_hdr_h =<br>      (payload_hdr_h &amp; kHevcTypeMaskN) | (kHevcAp &lt;&lt; <span class="hljs-number">1</span>) | layer_id_h;<br><br>  buffer[<span class="hljs-number">0</span>] = payload_hdr_h;<br>  buffer[<span class="hljs-number">1</span>] = payload_hdr_l;<br>  <span class="hljs-type">int</span> index = kHevcNalHeaderSize;<br>  <span class="hljs-type">bool</span> is_last_fragment = packet-&gt;last_fragment;<br>  <span class="hljs-keyword">while</span> (packet-&gt;aggregated) &#123;<br>    <span class="hljs-comment">// Add NAL unit length field.</span><br>    rtc::ArrayView&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>&gt; fragment = packet-&gt;source_fragment;<br>    ByteWriter&lt;<span class="hljs-type">uint16_t</span>&gt;::<span class="hljs-built_in">WriteBigEndian</span>(&amp;buffer[index], fragment.<span class="hljs-built_in">size</span>());<br>    index += kHevcLengthFieldSize;<br>    <span class="hljs-comment">// Add NAL unit.</span><br>    <span class="hljs-built_in">memcpy</span>(&amp;buffer[index], fragment.<span class="hljs-built_in">data</span>(), fragment.<span class="hljs-built_in">size</span>());<br>    index += fragment.<span class="hljs-built_in">size</span>();<br>    packets_.<span class="hljs-built_in">pop</span>();<br>    input_fragments_.<span class="hljs-built_in">pop_front</span>();<br>    <span class="hljs-keyword">if</span> (is_last_fragment)<br>      <span class="hljs-keyword">break</span>;<br>    packet = &amp;packets_.<span class="hljs-built_in">front</span>();<br>    is_last_fragment = packet-&gt;last_fragment;<br>  &#125;<br>  <span class="hljs-built_in">RTC_CHECK</span>(is_last_fragment);<br>  rtp_packet-&gt;<span class="hljs-built_in">SetPayloadSize</span>(index);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RtpPacketizerH265::NextFragmentPacket</span><span class="hljs-params">(RtpPacketToSend* rtp_packet)</span> </span>&#123;<br>  PacketUnit* packet = &amp;packets_.<span class="hljs-built_in">front</span>();<br>  <span class="hljs-comment">// NAL unit fragmented over multiple packets (FU).</span><br>  <span class="hljs-comment">// We do not send original NALU header, so it will be replaced by the</span><br>  <span class="hljs-comment">// PayloadHdr of the first packet.</span><br>  <span class="hljs-type">uint8_t</span> payload_hdr_h =<br>      packet-&gt;header &gt;&gt; <span class="hljs-number">8</span>;  <span class="hljs-comment">// 1-bit F, 6-bit type, 1-bit layerID highest-bit</span><br>  <span class="hljs-type">uint8_t</span> payload_hdr_l = packet-&gt;header &amp; <span class="hljs-number">0xFF</span>;<br>  <span class="hljs-type">uint8_t</span> layer_id_h = payload_hdr_h &amp; kHevcLayerIDHMask;<br>  <span class="hljs-type">uint8_t</span> fu_header = <span class="hljs-number">0</span>;<br>  <span class="hljs-comment">// S | E |6 bit type.</span><br>  fu_header |= (packet-&gt;first_fragment ? kHevcSBit : <span class="hljs-number">0</span>);<br>  fu_header |= (packet-&gt;last_fragment ? kHevcEBit : <span class="hljs-number">0</span>);<br>  <span class="hljs-type">uint8_t</span> type = (payload_hdr_h &amp; kHevcTypeMask) &gt;&gt; <span class="hljs-number">1</span>;<br>  fu_header |= type;<br>  <span class="hljs-comment">// Now update payload_hdr_h with FU type.</span><br>  payload_hdr_h =<br>      (payload_hdr_h &amp; kHevcTypeMaskN) | (kHevcFu &lt;&lt; <span class="hljs-number">1</span>) | layer_id_h;<br>  rtc::ArrayView&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>&gt; fragment = packet-&gt;source_fragment;<br>  <span class="hljs-type">uint8_t</span>* buffer = rtp_packet-&gt;<span class="hljs-built_in">AllocatePayload</span>(<br>      kHevcFuHeaderSize + kHevcNalHeaderSize + fragment.<span class="hljs-built_in">size</span>());<br>  <span class="hljs-built_in">RTC_CHECK</span>(buffer);<br>  buffer[<span class="hljs-number">0</span>] = payload_hdr_h;<br>  buffer[<span class="hljs-number">1</span>] = payload_hdr_l;<br>  buffer[<span class="hljs-number">2</span>] = fu_header;<br><br>  <span class="hljs-keyword">if</span> (packet-&gt;last_fragment) &#123;<br>    <span class="hljs-built_in">memcpy</span>(buffer + kHevcFuHeaderSize + kHevcNalHeaderSize, fragment.<span class="hljs-built_in">data</span>(),<br>           fragment.<span class="hljs-built_in">size</span>());<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">memcpy</span>(buffer + kHevcFuHeaderSize + kHevcNalHeaderSize, fragment.<span class="hljs-built_in">data</span>(),<br>           fragment.<span class="hljs-built_in">size</span>());<br>  &#125;<br>  packets_.<span class="hljs-built_in">pop</span>();<br>&#125;<br><br>&#125;  <span class="hljs-comment">// namespace webrtc</span><br><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>modules/rtp_rtcp/source/rtp_format_h265.h >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> WEBRTC_MODULES_RTP_RTCP_SOURCE_RTP_FORMAT_H265_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> WEBRTC_MODULES_RTP_RTCP_SOURCE_RTP_FORMAT_H265_H_</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;api/array_view.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/include/module_common_types.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/rtp_rtcp/source/rtp_format.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/rtp_rtcp/source/rtp_packet_to_send.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/rtp_rtcp/source/rtp_format.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/video_coding/codecs/h265/include/h265_globals.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/buffer.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/constructor_magic.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> webrtc &#123;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RtpPacketizerH265</span> : <span class="hljs-keyword">public</span> RtpPacketizer &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-comment">// Initialize with payload from encoder.</span><br>  <span class="hljs-comment">// The payload_data must be exactly one encoded H.265 frame.</span><br>  <span class="hljs-built_in">RtpPacketizerH265</span>(rtc::ArrayView&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>&gt; payload,<br>                    PayloadSizeLimits limits,<br>                    H265PacketizationMode packetization_mode);<br><br>   ~<span class="hljs-built_in">RtpPacketizerH265</span>() <span class="hljs-keyword">override</span>;<br><br>  <span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">NumPackets</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span>;<br><br>  <span class="hljs-comment">// Get the next payload with H.265 payload header.</span><br>  <span class="hljs-comment">// buffer is a pointer to where the output will be written.</span><br>  <span class="hljs-comment">// bytes_to_send is an output variable that will contain number of bytes</span><br>  <span class="hljs-comment">// written to buffer. The parameter last_packet is true for the last packet of</span><br>  <span class="hljs-comment">// the frame, false otherwise (i.e., call the function again to get the</span><br>  <span class="hljs-comment">// next packet).</span><br>  <span class="hljs-comment">// Returns true on success or false if there was no payload to packetize.</span><br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">NextPacket</span><span class="hljs-params">(RtpPacketToSend* rtp_packet)</span> <span class="hljs-keyword">override</span></span>;<br><br> <span class="hljs-keyword">private</span>:<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Packet</span> &#123;<br>    <span class="hljs-built_in">Packet</span>(<span class="hljs-type">size_t</span> offset,<br>           <span class="hljs-type">size_t</span> size,<br>           <span class="hljs-type">bool</span> first_fragment,<br>           <span class="hljs-type">bool</span> last_fragment,<br>           <span class="hljs-type">bool</span> aggregated,<br>           <span class="hljs-type">uint16_t</span> header)<br>        : <span class="hljs-built_in">offset</span>(offset),<br>          <span class="hljs-built_in">size</span>(size),<br>          <span class="hljs-built_in">first_fragment</span>(first_fragment),<br>          <span class="hljs-built_in">last_fragment</span>(last_fragment),<br>          <span class="hljs-built_in">aggregated</span>(aggregated),<br>          <span class="hljs-built_in">header</span>(header) &#123;&#125;<br><br>    <span class="hljs-type">size_t</span> offset;<br>    <span class="hljs-type">size_t</span> size;<br>    <span class="hljs-type">bool</span> first_fragment;<br>    <span class="hljs-type">bool</span> last_fragment;<br>    <span class="hljs-type">bool</span> aggregated;<br>    <span class="hljs-type">uint16_t</span> header;  <span class="hljs-comment">// Different from H264</span><br>  &#125;;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">PacketUnit</span> &#123;<br>    <span class="hljs-built_in">PacketUnit</span>(rtc::ArrayView&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>&gt; source_fragment,<br>               <span class="hljs-type">bool</span> first_fragment,<br>               <span class="hljs-type">bool</span> last_fragment,<br>               <span class="hljs-type">bool</span> aggregated,<br>               <span class="hljs-type">uint16_t</span> header)<br>        : <span class="hljs-built_in">source_fragment</span>(source_fragment),<br>          <span class="hljs-built_in">first_fragment</span>(first_fragment),<br>          <span class="hljs-built_in">last_fragment</span>(last_fragment),<br>          <span class="hljs-built_in">aggregated</span>(aggregated),<br>          <span class="hljs-built_in">header</span>(header) &#123;&#125;<br><br>    rtc::ArrayView&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>&gt; source_fragment;<br>    <span class="hljs-type">bool</span> first_fragment;<br>    <span class="hljs-type">bool</span> last_fragment;<br>    <span class="hljs-type">bool</span> aggregated;<br>    <span class="hljs-type">uint16_t</span> header;<br>  &#125;;<br>  <span class="hljs-keyword">typedef</span> std::queue&lt;Packet&gt; PacketQueue;<br>  std::deque&lt;rtc::ArrayView&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>&gt;&gt; input_fragments_;<br>  std::queue&lt;PacketUnit&gt; packets_;<br><br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">GeneratePackets</span><span class="hljs-params">(H265PacketizationMode packetization_mode)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">PacketizeFu</span><span class="hljs-params">(<span class="hljs-type">size_t</span> fragment_index)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">PacketizeAp</span><span class="hljs-params">(<span class="hljs-type">size_t</span> fragment_index)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">PacketizeSingleNalu</span><span class="hljs-params">(<span class="hljs-type">size_t</span> fragment_index)</span></span>;<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">NextAggregatePacket</span><span class="hljs-params">(RtpPacketToSend* rtp_packet, <span class="hljs-type">bool</span> last)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">NextFragmentPacket</span><span class="hljs-params">(RtpPacketToSend* rtp_packet)</span></span>;<br><br>  <span class="hljs-type">const</span> PayloadSizeLimits limits_;<br>  <span class="hljs-type">size_t</span> num_packets_left_;<br><br>  <span class="hljs-built_in">RTC_DISALLOW_COPY_AND_ASSIGN</span>(RtpPacketizerH265);<br>&#125;;<br>&#125;  <span class="hljs-comment">// namespace webrtc</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>  <span class="hljs-comment">// WEBRTC_MODULES_RTP_RTCP_SOURCE_RTP_FORMAT_H265_H_</span></span><br><br></code></pre></td></tr></table></figure>

<ul>
<li>视频渲染支持,vpx通过picture_id,temporal_id,tl0_pic_id标识Nalu间的关系及是否可连续解码，H26x通过seqnum，是否有sps，pps来判断帧间的解码连续性。故，我们把H265的temporalId置为kNoTemporalIdx即可：</li>
</ul>
<figure class="highlight c++"><figcaption><span>modules/rtp_rtcp/source/rtp_sender_video.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">uint8_t</span> <span class="hljs-title">RTPSenderVideo::GetTemporalId</span><span class="hljs-params">(<span class="hljs-type">const</span> RTPVideoHeader&amp; header)</span> </span>&#123;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TemporalIdGetter</span> &#123;<br>    <span class="hljs-function"><span class="hljs-type">uint8_t</span> <span class="hljs-title">operator</span><span class="hljs-params">()</span><span class="hljs-params">(<span class="hljs-type">const</span> RTPVideoHeaderVP8&amp; vp8)</span> </span>&#123; <span class="hljs-keyword">return</span> vp8.temporalIdx; &#125;<br>    <span class="hljs-function"><span class="hljs-type">uint8_t</span> <span class="hljs-title">operator</span><span class="hljs-params">()</span><span class="hljs-params">(<span class="hljs-type">const</span> RTPVideoHeaderVP9&amp; vp9)</span> </span>&#123;<br>      <span class="hljs-keyword">return</span> vp9.temporal_idx;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-type">uint8_t</span> <span class="hljs-title">operator</span><span class="hljs-params">()</span><span class="hljs-params">(<span class="hljs-type">const</span> RTPVideoHeaderH264&amp;)</span> </span>&#123; <span class="hljs-keyword">return</span> kNoTemporalIdx; &#125;<br> <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>     <span class="hljs-function"><span class="hljs-type">uint8_t</span> <span class="hljs-title">operator</span><span class="hljs-params">()</span><span class="hljs-params">(<span class="hljs-type">const</span> RTPVideoHeaderH265&amp;)</span> </span>&#123; <span class="hljs-keyword">return</span> kNoTemporalIdx; &#125;<br> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>...<br><br>  <span class="hljs-keyword">return</span> absl::<span class="hljs-built_in">visit</span>(<span class="hljs-built_in">TemporalIdGetter</span>(), header.video_type_header);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>RTP头增加H265支持构造函数,注意#ifndef与#ifdef的区别：</li>
</ul>
<figure class="highlight c++"><figcaption><span>modules/rtp_rtcp/source/rtp_video_header.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/video_coding/codecs/h264/include/h264_globals.h&quot;</span></span><br> <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/video_coding/codecs/h265/include/h265_globals.h&quot;</span></span><br> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/video_coding/codecs/vp8/include/vp8_globals.h&quot;</span></span><br><br>... <br><br> <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> DISABLE_H265</span><br><span class="hljs-keyword">using</span> RTPVideoTypeHeader = absl::variant&lt;absl::monostate,<br>                                         RTPVideoHeaderVP8,<br>                                         RTPVideoHeaderVP9,<br>                                         RTPVideoHeaderH264,<br>                                         RTPVideoHeaderLegacyGeneric&gt;;<br> <span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br> <span class="hljs-keyword">using</span> RTPVideoTypeHeader = absl::variant&lt;absl::monostate,<br>                                         RTPVideoHeaderVP8,<br>                                         RTPVideoHeaderVP9,<br>                                         RTPVideoHeaderH264,<br>                                         RTPVideoHeaderH265,<br>                                         RTPVideoHeaderLegacyGeneric&gt;;<br> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<ul>
<li>新增H265解包逻辑<strong>video_rtp_depacketizer_h265</strong>：</li>
</ul>
<figure class="highlight c++"><figcaption><span>modules/rtp_rtcp/source/video_rtp_depacketizer_h265.h >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MODULES_RTP_RTCP_SOURCE_VIDEO_RTP_DEPACKETIZER_H265_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MODULES_RTP_RTCP_SOURCE_VIDEO_RTP_DEPACKETIZER_H265_H_</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;absl/types/optional.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/rtp_rtcp/source/video_rtp_depacketizer.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/copy_on_write_buffer.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> webrtc &#123;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">VideoRtpDepacketizerH265</span> : <span class="hljs-keyword">public</span> VideoRtpDepacketizer &#123;<br> <span class="hljs-keyword">public</span>:<br>  ~<span class="hljs-built_in">VideoRtpDepacketizerH265</span>() <span class="hljs-keyword">override</span> = <span class="hljs-keyword">default</span>;<br><br>  <span class="hljs-function">absl::optional&lt;ParsedRtpPayload&gt; <span class="hljs-title">Parse</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">      rtc::CopyOnWriteBuffer rtp_payload)</span> <span class="hljs-keyword">override</span></span>;<br><br><span class="hljs-keyword">private</span>:<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ParsedPayload</span> &#123;<br>    <span class="hljs-function">RTPVideoHeader&amp; <span class="hljs-title">video_header</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> video; &#125;<br>    <span class="hljs-function"><span class="hljs-type">const</span> RTPVideoHeader&amp; <span class="hljs-title">video_header</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> video; &#125;<br><br>    RTPVideoHeader video;<br><br>    <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* payload;<br>    <span class="hljs-type">size_t</span> payload_length;<br>  &#125;;<br><br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Parse</span><span class="hljs-params">(ParsedPayload* parsed_payload,</span></span><br><span class="hljs-params"><span class="hljs-function">             <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* payload_data,</span></span><br><span class="hljs-params"><span class="hljs-function">             <span class="hljs-type">size_t</span> payload_data_length)</span></span>;<br><br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">ParseFuNalu</span><span class="hljs-params">(ParsedPayload* parsed_payload,</span></span><br><span class="hljs-params"><span class="hljs-function">                   <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* payload_data)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">ProcessApOrSingleNalu</span><span class="hljs-params">(ParsedPayload* parsed_payload,</span></span><br><span class="hljs-params"><span class="hljs-function">                             <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* payload_data)</span></span>;<br><br>  <span class="hljs-type">size_t</span> offset_;<br>  <span class="hljs-type">size_t</span> length_;<br>  std::unique_ptr&lt;rtc::Buffer&gt; modified_buffer_;<br><br>&#125;;<br>&#125;  <span class="hljs-comment">// namespace webrtc</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>  <span class="hljs-comment">// MODULES_RTP_RTCP_SOURCE_VIDEO_RTP_DEPACKETIZER_H265_H_</span></span><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>modules/rtp_rtcp/source/video_rtp_depacketizer_h265.cc >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/rtp_rtcp/source/video_rtp_depacketizer_h265.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstddef&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdint&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utility&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;absl/base/macros.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;absl/types/optional.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;absl/types/variant.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h264/h264_common.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_common.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_pps_parser.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_sps_parser.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_vps_parser.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/rtp_rtcp/source/byte_io.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/rtp_rtcp/source/video_rtp_depacketizer.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/checks.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/copy_on_write_buffer.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/logging.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> webrtc &#123;<br><span class="hljs-keyword">namespace</span> &#123;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">   0                   1                   2                   3</span><br><span class="hljs-comment">   0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="hljs-comment">  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment">  |    PayloadHdr (Type=49)       |   FU header   | DONL (cond)   |</span><br><span class="hljs-comment">  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-|</span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">// Unlike H.264, HEVC NAL header is 2-bytes.</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> kHevcNalHeaderSize = <span class="hljs-number">2</span>;<br><span class="hljs-comment">// H.265&#x27;s FU is constructed of 2-byte payload header, and 1-byte FU header</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> kHevcFuHeaderSize = <span class="hljs-number">1</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> kHevcLengthFieldSize = <span class="hljs-number">2</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> kHevcApHeaderSize =<br>    kHevcNalHeaderSize + kHevcLengthFieldSize;<br><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">HevcNalHdrMasks</span> &#123;<br>  kHevcFBit = <span class="hljs-number">0x80</span>,<br>  kHevcTypeMask = <span class="hljs-number">0x7E</span>,<br>  kHevcLayerIDHMask = <span class="hljs-number">0x1</span>,<br>  kHevcLayerIDLMask = <span class="hljs-number">0xF8</span>,<br>  kHevcTIDMask = <span class="hljs-number">0x7</span>,<br>  kHevcTypeMaskN = <span class="hljs-number">0x81</span>,<br>  kHevcTypeMaskInFuHeader = <span class="hljs-number">0x3F</span><br>&#125;;<br><br><span class="hljs-comment">// Bit masks for FU headers.</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">HevcFuDefs</span> &#123; kHevcSBit = <span class="hljs-number">0x80</span>, kHevcEBit = <span class="hljs-number">0x40</span>, kHevcFuTypeBit = <span class="hljs-number">0x3F</span> &#125;;<br><br><span class="hljs-comment">// TODO(pbos): Avoid parsing this here as well as inside the jitter buffer.</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">ParseApStartOffsets</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* nalu_ptr,</span></span><br><span class="hljs-params"><span class="hljs-function">                         <span class="hljs-type">size_t</span> length_remaining,</span></span><br><span class="hljs-params"><span class="hljs-function">                         std::vector&lt;<span class="hljs-type">size_t</span>&gt;* offsets)</span> </span>&#123;<br>  <span class="hljs-type">size_t</span> offset = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">while</span> (length_remaining &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">// Buffer doesn&#x27;t contain room for additional nalu length.</span><br>    <span class="hljs-keyword">if</span> (length_remaining &lt; <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint16_t</span>))<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">uint16_t</span> nalu_size = ByteReader&lt;<span class="hljs-type">uint16_t</span>&gt;::<span class="hljs-built_in">ReadBigEndian</span>(nalu_ptr);<br>    nalu_ptr += <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint16_t</span>);<br>    length_remaining -= <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint16_t</span>);<br>    <span class="hljs-keyword">if</span> (nalu_size &gt; length_remaining)<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    nalu_ptr += nalu_size;<br>    length_remaining -= nalu_size;<br><br>    offsets-&gt;<span class="hljs-built_in">push_back</span>(offset + kHevcApHeaderSize);<br>    offset += kHevcLengthFieldSize + nalu_size;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br>&#125;  <span class="hljs-comment">// namespace</span><br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">VideoRtpDepacketizerH265::Parse</span><span class="hljs-params">(ParsedPayload* parsed_payload,</span></span><br><span class="hljs-params"><span class="hljs-function">                                <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* payload_data,</span></span><br><span class="hljs-params"><span class="hljs-function">                                <span class="hljs-type">size_t</span> payload_data_length)</span> </span>&#123;<br>  <span class="hljs-built_in">RTC_CHECK</span>(parsed_payload != <span class="hljs-literal">nullptr</span>);<br>  <span class="hljs-keyword">if</span> (payload_data_length == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">RTC_LOG</span>(LS_ERROR) &lt;&lt; <span class="hljs-string">&quot;Empty payload.&quot;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  offset_ = <span class="hljs-number">0</span>;<br>  length_ = payload_data_length;<br>  modified_buffer_.<span class="hljs-built_in">reset</span>();<br><br>  <span class="hljs-type">uint8_t</span> nal_type = (payload_data[<span class="hljs-number">0</span>] &amp; kHevcTypeMask) &gt;&gt; <span class="hljs-number">1</span>;<br>  parsed_payload-&gt;<span class="hljs-built_in">video_header</span>()<br>      .video_type_header.<span class="hljs-built_in">emplace</span>&lt;RTPVideoHeaderH265&gt;();<br><br>  <span class="hljs-keyword">if</span> (nal_type == H265::NaluType::kFU) &#123;<br>    <span class="hljs-comment">// Fragmented NAL units (FU-A).</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ParseFuNalu</span>(parsed_payload, payload_data))<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// We handle STAP-A and single NALU&#x27;s the same way here. The jitter buffer</span><br>    <span class="hljs-comment">// will depacketize the STAP-A into NAL units later.</span><br>    <span class="hljs-comment">// TODO(sprang): Parse STAP-A offsets here and store in fragmentation vec.</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ProcessApOrSingleNalu</span>(parsed_payload, payload_data))<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* payload =<br>      modified_buffer_ ? modified_buffer_-&gt;<span class="hljs-built_in">data</span>() : payload_data;<br><br>  parsed_payload-&gt;payload = payload + offset_;<br>  parsed_payload-&gt;payload_length = length_;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">VideoRtpDepacketizerH265::ProcessApOrSingleNalu</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    ParsedPayload* parsed_payload,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* payload_data)</span> </span>&#123;<br>  parsed_payload-&gt;<span class="hljs-built_in">video_header</span>().width = <span class="hljs-number">0</span>;<br>  parsed_payload-&gt;<span class="hljs-built_in">video_header</span>().height = <span class="hljs-number">0</span>;<br>  parsed_payload-&gt;<span class="hljs-built_in">video_header</span>().codec = kVideoCodecH265;<br>  parsed_payload-&gt;<span class="hljs-built_in">video_header</span>().is_first_packet_in_frame = <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">auto</span>&amp; h265_header = absl::<span class="hljs-built_in">get</span>&lt;RTPVideoHeaderH265&gt;(<br>      parsed_payload-&gt;<span class="hljs-built_in">video_header</span>().video_type_header);<br><br>  <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* nalu_start = payload_data + kHevcNalHeaderSize;<br>  <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> nalu_length = length_ - kHevcNalHeaderSize;<br>  <span class="hljs-type">uint8_t</span> nal_type = (payload_data[<span class="hljs-number">0</span>] &amp; kHevcTypeMask) &gt;&gt; <span class="hljs-number">1</span>;<br>  std::vector&lt;<span class="hljs-type">size_t</span>&gt; nalu_start_offsets;<br>  <span class="hljs-keyword">if</span> (nal_type == H265::NaluType::kAP) &#123;<br>    <span class="hljs-comment">// Skip the StapA header (StapA NAL type + length).</span><br>    <span class="hljs-keyword">if</span> (length_ &lt;= kHevcApHeaderSize) &#123;<br>      <span class="hljs-built_in">RTC_LOG</span>(LS_ERROR) &lt;&lt; <span class="hljs-string">&quot;AP header truncated.&quot;</span>;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ParseApStartOffsets</span>(nalu_start, nalu_length, &amp;nalu_start_offsets)) &#123;<br>      <span class="hljs-built_in">RTC_LOG</span>(LS_ERROR) &lt;&lt; <span class="hljs-string">&quot;AP packet with incorrect NALU packet lengths.&quot;</span>;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    h265_header.packetization_type = kH265AP;<br>    <span class="hljs-comment">// nal_type = (payload_data[kHevcApHeaderSize] &amp; kHevcTypeMask) &gt;&gt; 1;</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    h265_header.packetization_type = kH265SingleNalu;<br>    nalu_start_offsets.<span class="hljs-built_in">push_back</span>(<span class="hljs-number">0</span>);<br>  &#125;<br>  h265_header.nalu_type = nal_type;<br>  parsed_payload-&gt;<span class="hljs-built_in">video_header</span>().frame_type = VideoFrameType::kVideoFrameDelta;<br><br>  nalu_start_offsets.<span class="hljs-built_in">push_back</span>(length_ + kHevcLengthFieldSize);  <span class="hljs-comment">// End offset.</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; nalu_start_offsets.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>; ++i) &#123;<br>    <span class="hljs-type">size_t</span> start_offset = nalu_start_offsets[i];<br>    <span class="hljs-comment">// End offset is actually start offset for next unit, excluding length field</span><br>    <span class="hljs-comment">// so remove that from this units length.</span><br>    <span class="hljs-type">size_t</span> end_offset = nalu_start_offsets[i + <span class="hljs-number">1</span>] - kHevcLengthFieldSize;<br>    <span class="hljs-keyword">if</span> (end_offset - start_offset &lt; kHevcNalHeaderSize) &#123;  <span class="hljs-comment">// Same as H.264.</span><br>      <span class="hljs-built_in">RTC_LOG</span>(LS_ERROR) &lt;&lt; <span class="hljs-string">&quot;AP packet too short&quot;</span>;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    H265NaluInfo nalu;<br>    nalu.type = (payload_data[start_offset] &amp; kHevcTypeMask) &gt;&gt; <span class="hljs-number">1</span>;<br>    nalu.vps_id = <span class="hljs-number">-1</span>;<br>    nalu.sps_id = <span class="hljs-number">-1</span>;<br>    nalu.pps_id = <span class="hljs-number">-1</span>;<br>    start_offset += kHevcNalHeaderSize;<br>    <span class="hljs-keyword">switch</span> (nalu.type) &#123;<br>      <span class="hljs-keyword">case</span> H265::NaluType::kVps: &#123;<br>        absl::optional&lt;H265VpsParser::VpsState&gt; vps = H265VpsParser::<span class="hljs-built_in">ParseVps</span>(<br>            &amp;payload_data[start_offset], end_offset - start_offset);<br>        <span class="hljs-keyword">if</span> (vps) &#123;<br>          nalu.vps_id = vps-&gt;id;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="hljs-string">&quot;Failed to parse VPS id from VPS slice.&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>      <span class="hljs-keyword">case</span> H265::NaluType::kSps: &#123;<br>        <span class="hljs-comment">// Check if VUI is present in SPS and if it needs to be modified to</span><br>        <span class="hljs-comment">// avoid excessive decoder latency.</span><br><br>        <span class="hljs-comment">// Copy any previous data first (likely just the first header).</span><br>        <span class="hljs-function">std::unique_ptr&lt;rtc::Buffer&gt; <span class="hljs-title">output_buffer</span><span class="hljs-params">(<span class="hljs-keyword">new</span> rtc::Buffer())</span></span>;<br>        <span class="hljs-keyword">if</span> (start_offset)<br>          output_buffer-&gt;<span class="hljs-built_in">AppendData</span>(payload_data, start_offset);<br><br>        absl::optional&lt;H265SpsParser::SpsState&gt; sps = H265SpsParser::<span class="hljs-built_in">ParseSps</span>(<br>            &amp;payload_data[start_offset], end_offset - start_offset);<br><br>        <span class="hljs-keyword">if</span> (sps) &#123;<br>          parsed_payload-&gt;<span class="hljs-built_in">video_header</span>().width = sps-&gt;width;<br>          parsed_payload-&gt;<span class="hljs-built_in">video_header</span>().height = sps-&gt;height;<br>          nalu.sps_id = sps-&gt;id;<br>          nalu.vps_id = sps-&gt;vps_id;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING)<br>              &lt;&lt; <span class="hljs-string">&quot;Failed to parse SPS and VPS id from SPS slice.&quot;</span>;<br>        &#125;<br>        parsed_payload-&gt;<span class="hljs-built_in">video_header</span>().frame_type = VideoFrameType::kVideoFrameKey;<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>      <span class="hljs-keyword">case</span> H265::NaluType::kPps: &#123;<br>        <span class="hljs-type">uint32_t</span> pps_id;<br>        <span class="hljs-type">uint32_t</span> sps_id;<br>        <span class="hljs-keyword">if</span> (H265PpsParser::<span class="hljs-built_in">ParsePpsIds</span>(&amp;payload_data[start_offset],<br>                                       end_offset - start_offset, &amp;pps_id,<br>                                       &amp;sps_id)) &#123;<br>          nalu.pps_id = pps_id;<br>          nalu.sps_id = sps_id;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING)<br>              &lt;&lt; <span class="hljs-string">&quot;Failed to parse PPS id and SPS id from PPS slice.&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>      <span class="hljs-keyword">case</span> H265::NaluType::kIdrWRadl:<br>      <span class="hljs-keyword">case</span> H265::NaluType::kIdrNLp:<br>      <span class="hljs-keyword">case</span> H265::NaluType::kCra:<br>        parsed_payload-&gt;<span class="hljs-built_in">video_header</span>().frame_type = VideoFrameType::kVideoFrameKey;<br>        ABSL_FALLTHROUGH_INTENDED;<br>      <span class="hljs-keyword">case</span> H265::NaluType::kTrailN:<br>      <span class="hljs-keyword">case</span> H265::NaluType::kTrailR: &#123;<br>        absl::optional&lt;<span class="hljs-type">uint32_t</span>&gt; pps_id =<br>            H265PpsParser::<span class="hljs-built_in">ParsePpsIdFromSliceSegmentLayerRbsp</span>(<br>                &amp;payload_data[start_offset], end_offset - start_offset,<br>                nalu.type);<br>        <span class="hljs-keyword">if</span> (pps_id) &#123;<br>          nalu.pps_id = *pps_id;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="hljs-string">&quot;Failed to parse PPS id from slice of type: &quot;</span><br>                              &lt;&lt; <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(nalu.type);<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>      <span class="hljs-comment">// Slices below don&#x27;t contain SPS or PPS ids.</span><br>      <span class="hljs-keyword">case</span> H265::NaluType::kAud:<br>      <span class="hljs-keyword">case</span> H265::NaluType::kTsaN:<br>      <span class="hljs-keyword">case</span> H265::NaluType::kTsaR:<br>      <span class="hljs-keyword">case</span> H265::NaluType::kStsaN:<br>      <span class="hljs-keyword">case</span> H265::NaluType::kStsaR:<br>      <span class="hljs-keyword">case</span> H265::NaluType::kRadlN:<br>      <span class="hljs-keyword">case</span> H265::NaluType::kRadlR:<br>      <span class="hljs-keyword">case</span> H265::NaluType::kBlaWLp:<br>      <span class="hljs-keyword">case</span> H265::NaluType::kBlaWRadl:<br>      <span class="hljs-keyword">case</span> H265::NaluType::kPrefixSei:<br>      <span class="hljs-keyword">case</span> H265::NaluType::kSuffixSei:<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> H265::NaluType::kAP:<br>      <span class="hljs-keyword">case</span> H265::NaluType::kFU:<br>        <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="hljs-string">&quot;Unexpected AP or FU received.&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (h265_header.nalus_length == kMaxNalusPerPacket) &#123;<br>      <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING)<br>          &lt;&lt; <span class="hljs-string">&quot;Received packet containing more than &quot;</span> &lt;&lt; kMaxNalusPerPacket<br>          &lt;&lt; <span class="hljs-string">&quot; NAL units. Will not keep track sps and pps ids for all of them.&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      h265_header.nalus[h265_header.nalus_length++] = nalu;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">VideoRtpDepacketizerH265::ParseFuNalu</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    ParsedPayload* parsed_payload,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* payload_data)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (length_ &lt; kHevcFuHeaderSize + kHevcNalHeaderSize) &#123;<br>    <span class="hljs-built_in">RTC_LOG</span>(LS_ERROR) &lt;&lt; <span class="hljs-string">&quot;FU NAL units truncated.&quot;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br>  <span class="hljs-type">uint8_t</span> f = payload_data[<span class="hljs-number">0</span>] &amp; kHevcFBit;<br>  <span class="hljs-type">uint8_t</span> layer_id_h = payload_data[<span class="hljs-number">0</span>] &amp; kHevcLayerIDHMask;<br>  <span class="hljs-type">uint8_t</span> layer_id_l_unshifted = payload_data[<span class="hljs-number">1</span>] &amp; kHevcLayerIDLMask;<br>  <span class="hljs-type">uint8_t</span> tid = payload_data[<span class="hljs-number">1</span>] &amp; kHevcTIDMask;<br><br>  <span class="hljs-type">uint8_t</span> original_nal_type = payload_data[<span class="hljs-number">2</span>] &amp; kHevcTypeMaskInFuHeader;<br>  <span class="hljs-type">bool</span> first_fragment = payload_data[<span class="hljs-number">2</span>] &amp; kHevcSBit;<br>  H265NaluInfo nalu;<br>  nalu.type = original_nal_type;<br>  nalu.vps_id = <span class="hljs-number">-1</span>;<br>  nalu.sps_id = <span class="hljs-number">-1</span>;<br>  nalu.pps_id = <span class="hljs-number">-1</span>;<br>  <span class="hljs-keyword">if</span> (first_fragment) &#123;<br>    offset_ = <span class="hljs-number">1</span>;<br>    length_ -= <span class="hljs-number">1</span>;<br>    absl::optional&lt;<span class="hljs-type">uint32_t</span>&gt; pps_id =<br>        H265PpsParser::<span class="hljs-built_in">ParsePpsIdFromSliceSegmentLayerRbsp</span>(<br>            payload_data + kHevcNalHeaderSize + kHevcFuHeaderSize,<br>            length_ - kHevcFuHeaderSize, nalu.type);<br>    <span class="hljs-keyword">if</span> (pps_id) &#123;<br>      nalu.pps_id = *pps_id;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING)<br>          &lt;&lt; <span class="hljs-string">&quot;Failed to parse PPS from first fragment of FU NAL &quot;</span><br>             <span class="hljs-string">&quot;unit with original type: &quot;</span><br>          &lt;&lt; <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(nalu.type);<br>    &#125;<br>    <span class="hljs-type">uint8_t</span>* payload = <span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">uint8_t</span>*&gt;(payload_data + offset_);<br>    payload[<span class="hljs-number">0</span>] = f | original_nal_type &lt;&lt; <span class="hljs-number">1</span> | layer_id_h;<br>    payload[<span class="hljs-number">1</span>] = layer_id_l_unshifted | tid;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    offset_ = kHevcNalHeaderSize + kHevcFuHeaderSize;<br>    length_ -= (kHevcNalHeaderSize + kHevcFuHeaderSize);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (original_nal_type == H265::NaluType::kIdrWRadl<br>      || original_nal_type == H265::NaluType::kIdrNLp<br>      || original_nal_type == H265::NaluType::kCra) &#123;<br>    parsed_payload-&gt;<span class="hljs-built_in">video_header</span>().frame_type = VideoFrameType::kVideoFrameKey;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    parsed_payload-&gt;<span class="hljs-built_in">video_header</span>().frame_type = VideoFrameType::kVideoFrameDelta;<br>  &#125;<br>  parsed_payload-&gt;<span class="hljs-built_in">video_header</span>().width = <span class="hljs-number">0</span>;<br>  parsed_payload-&gt;<span class="hljs-built_in">video_header</span>().height = <span class="hljs-number">0</span>;<br>  parsed_payload-&gt;<span class="hljs-built_in">video_header</span>().codec = kVideoCodecH265;<br>  parsed_payload-&gt;<span class="hljs-built_in">video_header</span>().is_first_packet_in_frame = first_fragment;<br>  <span class="hljs-keyword">auto</span>&amp; h265_header = absl::<span class="hljs-built_in">get</span>&lt;RTPVideoHeaderH265&gt;(<br>      parsed_payload-&gt;<span class="hljs-built_in">video_header</span>().video_type_header);<br>  h265_header.packetization_type = kH265FU;<br>  h265_header.nalu_type = original_nal_type;<br>  <span class="hljs-keyword">if</span> (first_fragment) &#123;<br>    h265_header.nalus[h265_header.nalus_length] = nalu;<br>    h265_header.nalus_length = <span class="hljs-number">1</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-function">absl::optional&lt;VideoRtpDepacketizer::ParsedRtpPayload&gt;</span><br><span class="hljs-function"><span class="hljs-title">VideoRtpDepacketizerH265::Parse</span><span class="hljs-params">(rtc::CopyOnWriteBuffer rtp_payload)</span> </span>&#123;<br>  <span class="hljs-comment">// borrowed from https://webrtc.googlesource.com/src/+/</span><br>  <span class="hljs-comment">// 07b17df771af20a6dd98b795592acc62a623c56f</span><br>  <span class="hljs-comment">// /modules/rtp_rtcp/source/create_video_rtp_depacketizer.cc</span><br>  ParsedPayload parsed_payload;<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Parse</span>(&amp;parsed_payload, rtp_payload.<span class="hljs-built_in">cdata</span>(), rtp_payload.<span class="hljs-built_in">size</span>())) &#123;<br>    <span class="hljs-keyword">return</span> absl::<span class="hljs-literal">nullopt</span>;<br>  &#125;<br>  <span class="hljs-function">absl::optional&lt;ParsedRtpPayload&gt; <span class="hljs-title">result</span><span class="hljs-params">(absl::in_place)</span></span>;<br>  result-&gt;video_header = parsed_payload.video;<br>  result-&gt;video_payload.<span class="hljs-built_in">SetData</span>(parsed_payload.payload,<br>                                parsed_payload.payload_length);<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br><br>&#125;  <span class="hljs-comment">// namespace webrtc</span><br></code></pre></td></tr></table></figure>

<ul>
<li>将新增4个文件添加到ninja中参与构建，并通过rtc_use_h265打开H265开关：</li>
</ul>
<figure class="highlight js"><figcaption><span>modules/rtp_rtcp/BUILD.gn</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">if</span> (rtc_enable_bwe_test_logging) &#123;<br>   defines = [ <span class="hljs-string">&quot;BWE_TEST_LOGGING_COMPILE_TIME_ENABLE=1&quot;</span> ]<br> &#125; <span class="hljs-keyword">else</span> &#123;<br>   defines = [ <span class="hljs-string">&quot;BWE_TEST_LOGGING_COMPILE_TIME_ENABLE=0&quot;</span> ]<br> &#125;<br><br><span class="hljs-keyword">if</span> (rtc_use_h265) &#123;<br>   sources += [<br>     <span class="hljs-string">&quot;source/rtp_format_h265.cc&quot;</span>,<br>     <span class="hljs-string">&quot;source/rtp_format_h265.h&quot;</span>,<br>     <span class="hljs-string">&quot;source/video_rtp_depacketizer_h265.cc&quot;</span>,<br>     <span class="hljs-string">&quot;source/video_rtp_depacketizer_h265.h&quot;</span>,<br>   ]<br> &#125;<br><br> <span class="hljs-keyword">if</span> (!rtc_use_h265) &#123;<br>   defines += [<span class="hljs-string">&quot;DISABLE_H265&quot;</span>]<br> &#125;<br></code></pre></td></tr></table></figure>

<h4 id="解包支持"><a href="#解包支持" class="headerlink" title="解包支持"></a>解包支持</h4><ul>
<li>增加H265解包支持</li>
</ul>
<figure class="highlight c++"><figcaption><span>modules/video_coding/include/video_codec_interface.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/video_coding/codecs/h264/include/h264_globals.h&quot;</span></span><br> <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/video_coding/codecs/h265/include/h265_globals.h&quot;</span></span><br> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>...<br><br> <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">CodecSpecificInfoH265</span> &#123;<br>   H265PacketizationMode packetization_mode;<br>   <span class="hljs-type">bool</span> idr_frame;<br> &#125;;<br> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-keyword">union</span> <span class="hljs-title class_">CodecSpecificInfoUnion</span> &#123;<br>  CodecSpecificInfoVP8 VP8;<br>  CodecSpecificInfoVP9 VP9;<br>  CodecSpecificInfoH264 H264;<br> <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>   CodecSpecificInfoH265 H265;<br> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br><span class="hljs-built_in">static_assert</span>(std::is_pod&lt;CodecSpecificInfoUnion&gt;::value, <span class="hljs-string">&quot;&quot;</span>);<br></code></pre></td></tr></table></figure>

<ul>
<li>设置codec类型</li>
</ul>
<figure class="highlight c++"><figcaption><span>modules/video_coding/encoded_frame.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">VCMEncodedFrame::CopyCodecSpecific</span><span class="hljs-params">(<span class="hljs-type">const</span> RTPVideoHeader* header)</span> </span>&#123;<br>...<br> <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>      <span class="hljs-keyword">case</span> kVideoCodecH265: &#123;<br>        _codecSpecificInfo.codecType = kVideoCodecH265;<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      <span class="hljs-keyword">default</span>: &#123;<br>        _codecSpecificInfo.codecType = kVideoCodecGeneric;<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>新增tracker 解析vps/sps/pps信息，参考<strong>h264_sps_pps_tracker</strong></li>
</ul>
<figure class="highlight c++"><figcaption><span>modules/video_coding/h265_vps_sps_pps_tracker.cc >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/video_coding/h265_vps_sps_pps_tracker.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utility&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h264/h264_common.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_common.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_pps_parser.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_sps_parser.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_vps_parser.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/video_coding/codecs/h264/include/h264_globals.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/video_coding/codecs/h265/include/h265_globals.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/video_coding/frame_object.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/video_coding/packet_buffer.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/checks.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/logging.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> webrtc &#123;<br><span class="hljs-keyword">namespace</span> video_coding &#123;<br><br><span class="hljs-keyword">namespace</span> &#123;<br><span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> start_code_h265[] = &#123;<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>&#125;;<br>&#125;  <span class="hljs-comment">// namespace</span><br><br><span class="hljs-function">H265VpsSpsPpsTracker::FixedBitstream <span class="hljs-title">H265VpsSpsPpsTracker::CopyAndFixBitstream</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    rtc::ArrayView&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>&gt; bitstream,</span></span><br><span class="hljs-params"><span class="hljs-function">    RTPVideoHeader* video_header)</span> </span>&#123;<br>  <span class="hljs-built_in">RTC_DCHECK</span>(video_header);<br>  <span class="hljs-built_in">RTC_DCHECK</span>(video_header-&gt;codec == kVideoCodecH265);<br><br>  <span class="hljs-keyword">auto</span>&amp; h265_header =<br>      absl::<span class="hljs-built_in">get</span>&lt;RTPVideoHeaderH265&gt;(video_header-&gt;video_type_header);<br><br>  <span class="hljs-type">bool</span> append_vps_sps_pps = <span class="hljs-literal">false</span>;<br>  <span class="hljs-keyword">auto</span> vps = vps_data_.<span class="hljs-built_in">end</span>();<br>  <span class="hljs-keyword">auto</span> sps = sps_data_.<span class="hljs-built_in">end</span>();<br>  <span class="hljs-keyword">auto</span> pps = pps_data_.<span class="hljs-built_in">end</span>();<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; h265_header.nalus_length; ++i) &#123;<br>    <span class="hljs-type">const</span> H265NaluInfo&amp; nalu = h265_header.nalus[i];<br>    <span class="hljs-keyword">switch</span> (nalu.type) &#123;<br>      <span class="hljs-keyword">case</span> H265::NaluType::kVps: &#123;<br>        vps_data_[nalu.vps_id].size = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>      <span class="hljs-keyword">case</span> H265::NaluType::kSps: &#123;<br>        sps_data_[nalu.sps_id].vps_id = nalu.vps_id;<br>        sps_data_[nalu.sps_id].width = video_header-&gt;width;<br>        sps_data_[nalu.sps_id].height = video_header-&gt;height;<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>      <span class="hljs-keyword">case</span> H265::NaluType::kPps: &#123;<br>        pps_data_[nalu.pps_id].sps_id = nalu.sps_id;<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>      <span class="hljs-keyword">case</span> H265::NaluType::kIdrWRadl:<br>      <span class="hljs-keyword">case</span> H265::NaluType::kIdrNLp:<br>      <span class="hljs-keyword">case</span> H265::NaluType::kCra: &#123;<br>        <span class="hljs-comment">// If this is the first packet of an IDR, make sure we have the required</span><br>        <span class="hljs-comment">// SPS/PPS and also calculate how much extra space we need in the buffer</span><br>        <span class="hljs-comment">// to prepend the SPS/PPS to the bitstream with start codes.</span><br>        <span class="hljs-keyword">if</span> (video_header-&gt;is_first_packet_in_frame) &#123;<br>          <span class="hljs-keyword">if</span> (nalu.pps_id == <span class="hljs-number">-1</span>) &#123;<br>            <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="hljs-string">&quot;No PPS id in IDR nalu.&quot;</span>;<br>            <span class="hljs-keyword">return</span> &#123;kRequestKeyframe&#125;;<br>          &#125;<br><br>          pps = pps_data_.<span class="hljs-built_in">find</span>(nalu.pps_id);<br>          <span class="hljs-keyword">if</span> (pps == pps_data_.<span class="hljs-built_in">end</span>()) &#123;<br>            <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING)<br>                &lt;&lt; <span class="hljs-string">&quot;No PPS with id &lt;&lt; &quot;</span> &lt;&lt; nalu.pps_id &lt;&lt; <span class="hljs-string">&quot; received&quot;</span>;<br>            <span class="hljs-keyword">return</span> &#123;kRequestKeyframe&#125;;<br>          &#125;<br><br>          sps = sps_data_.<span class="hljs-built_in">find</span>(pps-&gt;second.sps_id);<br>          <span class="hljs-keyword">if</span> (sps == sps_data_.<span class="hljs-built_in">end</span>()) &#123;<br>            <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING)<br>                &lt;&lt; <span class="hljs-string">&quot;No SPS with id &lt;&lt; &quot;</span> &lt;&lt; pps-&gt;second.sps_id &lt;&lt; <span class="hljs-string">&quot; received&quot;</span>;<br>            <span class="hljs-keyword">return</span> &#123;kRequestKeyframe&#125;;<br>          &#125;<br><br>          vps = vps_data_.<span class="hljs-built_in">find</span>(sps-&gt;second.vps_id);<br>          <span class="hljs-keyword">if</span> (vps == vps_data_.<span class="hljs-built_in">end</span>()) &#123;<br>            <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING)<br>                &lt;&lt; <span class="hljs-string">&quot;No VPS with id &lt;&lt; &quot;</span> &lt;&lt; sps-&gt;second.vps_id &lt;&lt; <span class="hljs-string">&quot; received&quot;</span>;<br>            <span class="hljs-keyword">return</span> &#123;kRequestKeyframe&#125;;<br>          &#125;<br><br>          <span class="hljs-comment">// Since the first packet of every keyframe should have its width and</span><br>          <span class="hljs-comment">// height set we set it here in the case of it being supplied out of</span><br>          <span class="hljs-comment">// band.</span><br>          video_header-&gt;width = sps-&gt;second.width;<br>          video_header-&gt;height = sps-&gt;second.height;<br><br>          <span class="hljs-comment">// If the VPS/SPS/PPS was supplied out of band then we will have saved</span><br>          <span class="hljs-comment">// the actual bitstream in |data|.</span><br>          <span class="hljs-comment">// This branch is not verified.</span><br>          <span class="hljs-keyword">if</span> (vps-&gt;second.data &amp;&amp; sps-&gt;second.data &amp;&amp; pps-&gt;second.data) &#123;<br>            <span class="hljs-built_in">RTC_DCHECK_GT</span>(vps-&gt;second.size, <span class="hljs-number">0</span>);<br>            <span class="hljs-built_in">RTC_DCHECK_GT</span>(sps-&gt;second.size, <span class="hljs-number">0</span>);<br>            <span class="hljs-built_in">RTC_DCHECK_GT</span>(pps-&gt;second.size, <span class="hljs-number">0</span>);<br>            append_vps_sps_pps = <span class="hljs-literal">true</span>;<br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>      <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-built_in">RTC_CHECK</span>(!append_vps_sps_pps ||<br>            (sps != sps_data_.<span class="hljs-built_in">end</span>() &amp;&amp; pps != pps_data_.<span class="hljs-built_in">end</span>()));<br><br>  <span class="hljs-comment">// Calculate how much space we need for the rest of the bitstream.</span><br>  <span class="hljs-type">size_t</span> required_size = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-keyword">if</span> (append_vps_sps_pps) &#123;<br>    required_size += vps-&gt;second.size + <span class="hljs-built_in">sizeof</span>(start_code_h265);<br>    required_size += sps-&gt;second.size + <span class="hljs-built_in">sizeof</span>(start_code_h265);<br>    required_size += pps-&gt;second.size + <span class="hljs-built_in">sizeof</span>(start_code_h265);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (h265_header.packetization_type == kH265AP) &#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* nalu_ptr = bitstream.<span class="hljs-built_in">data</span>() + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">while</span> (nalu_ptr &lt; bitstream.<span class="hljs-built_in">data</span>() + bitstream.<span class="hljs-built_in">size</span>()) &#123;<br>      <span class="hljs-built_in">RTC_DCHECK</span>(video_header-&gt;is_first_packet_in_frame);<br>      required_size += <span class="hljs-built_in">sizeof</span>(start_code_h265);<br><br>      <span class="hljs-comment">// The first two bytes describe the length of a segment.</span><br>      <span class="hljs-type">uint16_t</span> segment_length = nalu_ptr[<span class="hljs-number">0</span>] &lt;&lt; <span class="hljs-number">8</span> | nalu_ptr[<span class="hljs-number">1</span>];<br>      nalu_ptr += <span class="hljs-number">2</span>;<br><br>      required_size += segment_length;<br>      nalu_ptr += segment_length;<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">if</span> (video_header-&gt;is_first_packet_in_frame)<br>      required_size += <span class="hljs-built_in">sizeof</span>(start_code_h265);<br>    required_size += bitstream.<span class="hljs-built_in">size</span>();<br>  &#125;<br><br>  <span class="hljs-comment">// Then we copy to the new buffer.</span><br>  H265VpsSpsPpsTracker::FixedBitstream fixed;<br>  fixed.bitstream.<span class="hljs-built_in">EnsureCapacity</span>(required_size);<br><br>  <span class="hljs-keyword">if</span> (append_vps_sps_pps) &#123;<br>    <span class="hljs-comment">// Insert VPS.</span><br>    fixed.bitstream.<span class="hljs-built_in">AppendData</span>(start_code_h265);<br>    fixed.bitstream.<span class="hljs-built_in">AppendData</span>(vps-&gt;second.data.<span class="hljs-built_in">get</span>(), vps-&gt;second.size);<br><br>    <span class="hljs-comment">// Insert SPS.</span><br>    fixed.bitstream.<span class="hljs-built_in">AppendData</span>(start_code_h265);<br>    fixed.bitstream.<span class="hljs-built_in">AppendData</span>(sps-&gt;second.data.<span class="hljs-built_in">get</span>(), sps-&gt;second.size);<br><br>    <span class="hljs-comment">// Insert PPS.</span><br>    fixed.bitstream.<span class="hljs-built_in">AppendData</span>(start_code_h265);<br>    fixed.bitstream.<span class="hljs-built_in">AppendData</span>(pps-&gt;second.data.<span class="hljs-built_in">get</span>(), pps-&gt;second.size);<br><br>    <span class="hljs-comment">// Update codec header to reflect the newly added SPS and PPS.</span><br>    H265NaluInfo vps_info;<br>    vps_info.type = H265::NaluType::kVps;<br>    vps_info.vps_id = vps-&gt;first;<br>    vps_info.sps_id = <span class="hljs-number">-1</span>;<br>    vps_info.pps_id = <span class="hljs-number">-1</span>;<br>    H265NaluInfo sps_info;<br>    sps_info.type = H265::NaluType::kSps;<br>    sps_info.vps_id = vps-&gt;first;<br>    sps_info.sps_id = sps-&gt;first;<br>    sps_info.pps_id = <span class="hljs-number">-1</span>;<br>    H265NaluInfo pps_info;<br>    pps_info.type = H265::NaluType::kPps;<br>    pps_info.vps_id = vps-&gt;first;<br>    pps_info.sps_id = sps-&gt;first;<br>    pps_info.pps_id = pps-&gt;first;<br>    <span class="hljs-keyword">if</span> (h265_header.nalus_length + <span class="hljs-number">3</span> &lt;= kMaxNalusPerPacket) &#123;<br>      h265_header.nalus[h265_header.nalus_length++] = vps_info;<br>      h265_header.nalus[h265_header.nalus_length++] = sps_info;<br>      h265_header.nalus[h265_header.nalus_length++] = pps_info;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="hljs-string">&quot;Not enough space in H.265 codec header to insert &quot;</span><br>                             <span class="hljs-string">&quot;SPS/PPS provided out-of-band.&quot;</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// Copy the rest of the bitstream and insert start codes.</span><br>  <span class="hljs-keyword">if</span> (h265_header.packetization_type == kH265AP) &#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* nalu_ptr = bitstream.<span class="hljs-built_in">data</span>() + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">while</span> (nalu_ptr &lt; bitstream.<span class="hljs-built_in">data</span>() + bitstream.<span class="hljs-built_in">size</span>()) &#123;<br>      fixed.bitstream.<span class="hljs-built_in">AppendData</span>(start_code_h265);<br><br>      <span class="hljs-comment">// The first two bytes describe the length of a segment.</span><br>      <span class="hljs-type">uint16_t</span> segment_length = nalu_ptr[<span class="hljs-number">0</span>] &lt;&lt; <span class="hljs-number">8</span> | nalu_ptr[<span class="hljs-number">1</span>];<br>      nalu_ptr += <span class="hljs-number">2</span>;<br><br>      <span class="hljs-type">size_t</span> copy_end = nalu_ptr - bitstream.<span class="hljs-built_in">data</span>() + segment_length;<br>      <span class="hljs-keyword">if</span> (copy_end &gt; bitstream.<span class="hljs-built_in">size</span>()) &#123;<br>        <span class="hljs-keyword">return</span> &#123;kDrop&#125;;<br>      &#125;<br><br>      fixed.bitstream.<span class="hljs-built_in">AppendData</span>(nalu_ptr, segment_length);<br>      nalu_ptr += segment_length;<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">if</span> (video_header-&gt;is_first_packet_in_frame) &#123;<br>      fixed.bitstream.<span class="hljs-built_in">AppendData</span>(start_code_h265);<br>    &#125;<br>    fixed.bitstream.<span class="hljs-built_in">AppendData</span>(bitstream.<span class="hljs-built_in">data</span>(), bitstream.<span class="hljs-built_in">size</span>());<br>  &#125;<br><br>  fixed.action = kInsert;<br>  <span class="hljs-keyword">return</span> fixed;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">H265VpsSpsPpsTracker::InsertVpsSpsPpsNalus</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">uint8_t</span>&gt;&amp; vps,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">uint8_t</span>&gt;&amp; sps,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">uint8_t</span>&gt;&amp; pps)</span> </span>&#123;<br>  <span class="hljs-keyword">constexpr</span> <span class="hljs-type">size_t</span> kNaluHeaderOffset = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">if</span> (vps.<span class="hljs-built_in">size</span>() &lt; kNaluHeaderOffset) &#123;<br>    <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="hljs-string">&quot;VPS size  &quot;</span> &lt;&lt; vps.<span class="hljs-built_in">size</span>() &lt;&lt; <span class="hljs-string">&quot; is smaller than &quot;</span><br>                        &lt;&lt; kNaluHeaderOffset;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ((vps[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0x7e</span>) &gt;&gt; <span class="hljs-number">1</span> != H265::NaluType::kSps) &#123;<br>    <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="hljs-string">&quot;SPS Nalu header missing&quot;</span>;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (sps.<span class="hljs-built_in">size</span>() &lt; kNaluHeaderOffset) &#123;<br>    <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="hljs-string">&quot;SPS size  &quot;</span> &lt;&lt; sps.<span class="hljs-built_in">size</span>() &lt;&lt; <span class="hljs-string">&quot; is smaller than &quot;</span><br>                        &lt;&lt; kNaluHeaderOffset;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ((sps[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0x7e</span>) &gt;&gt; <span class="hljs-number">1</span> != H265::NaluType::kSps) &#123;<br>    <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="hljs-string">&quot;SPS Nalu header missing&quot;</span>;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (pps.<span class="hljs-built_in">size</span>() &lt; kNaluHeaderOffset) &#123;<br>    <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="hljs-string">&quot;PPS size  &quot;</span> &lt;&lt; pps.<span class="hljs-built_in">size</span>() &lt;&lt; <span class="hljs-string">&quot; is smaller than &quot;</span><br>                        &lt;&lt; kNaluHeaderOffset;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ((pps[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0x7e</span>) &gt;&gt; <span class="hljs-number">1</span> != H265::NaluType::kPps) &#123;<br>    <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="hljs-string">&quot;SPS Nalu header missing&quot;</span>;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  absl::optional&lt;H265VpsParser::VpsState&gt; parsed_vps = H265VpsParser::<span class="hljs-built_in">ParseVps</span>(<br>      vps.<span class="hljs-built_in">data</span>() + kNaluHeaderOffset, vps.<span class="hljs-built_in">size</span>() - kNaluHeaderOffset);<br>  absl::optional&lt;H265SpsParser::SpsState&gt; parsed_sps = H265SpsParser::<span class="hljs-built_in">ParseSps</span>(<br>      sps.<span class="hljs-built_in">data</span>() + kNaluHeaderOffset, sps.<span class="hljs-built_in">size</span>() - kNaluHeaderOffset);<br>  absl::optional&lt;H265PpsParser::PpsState&gt; parsed_pps = H265PpsParser::<span class="hljs-built_in">ParsePps</span>(<br>      pps.<span class="hljs-built_in">data</span>() + kNaluHeaderOffset, pps.<span class="hljs-built_in">size</span>() - kNaluHeaderOffset);<br><br>  <span class="hljs-keyword">if</span> (!parsed_vps) &#123;<br>    <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="hljs-string">&quot;Failed to parse VPS.&quot;</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (!parsed_sps) &#123;<br>    <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="hljs-string">&quot;Failed to parse SPS.&quot;</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (!parsed_pps) &#123;<br>    <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="hljs-string">&quot;Failed to parse PPS.&quot;</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (!parsed_vps || !parsed_pps || !parsed_sps) &#123;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br><br>  VpsInfo vps_info;<br>  vps_info.size = vps.<span class="hljs-built_in">size</span>();<br>  <span class="hljs-type">uint8_t</span>* vps_data = <span class="hljs-keyword">new</span> <span class="hljs-type">uint8_t</span>[vps_info.size];<br>  <span class="hljs-built_in">memcpy</span>(vps_data, vps.<span class="hljs-built_in">data</span>(), vps_info.size);<br>  vps_info.data.<span class="hljs-built_in">reset</span>(vps_data);<br>  vps_data_[parsed_vps-&gt;id] = std::<span class="hljs-built_in">move</span>(vps_info);<br><br>  SpsInfo sps_info;<br>  sps_info.size = sps.<span class="hljs-built_in">size</span>();<br>  sps_info.width = parsed_sps-&gt;width;<br>  sps_info.height = parsed_sps-&gt;height;<br>  sps_info.vps_id = parsed_sps-&gt;vps_id;<br>  <span class="hljs-type">uint8_t</span>* sps_data = <span class="hljs-keyword">new</span> <span class="hljs-type">uint8_t</span>[sps_info.size];<br>  <span class="hljs-built_in">memcpy</span>(sps_data, sps.<span class="hljs-built_in">data</span>(), sps_info.size);<br>  sps_info.data.<span class="hljs-built_in">reset</span>(sps_data);<br>  sps_data_[parsed_sps-&gt;id] = std::<span class="hljs-built_in">move</span>(sps_info);<br><br>  PpsInfo pps_info;<br>  pps_info.size = pps.<span class="hljs-built_in">size</span>();<br>  pps_info.sps_id = parsed_pps-&gt;sps_id;<br>  <span class="hljs-type">uint8_t</span>* pps_data = <span class="hljs-keyword">new</span> <span class="hljs-type">uint8_t</span>[pps_info.size];<br>  <span class="hljs-built_in">memcpy</span>(pps_data, pps.<span class="hljs-built_in">data</span>(), pps_info.size);<br>  pps_info.data.<span class="hljs-built_in">reset</span>(pps_data);<br>  pps_data_[parsed_pps-&gt;id] = std::<span class="hljs-built_in">move</span>(pps_info);<br><br>  <span class="hljs-built_in">RTC_LOG</span>(LS_INFO) &lt;&lt; <span class="hljs-string">&quot;Inserted SPS id &quot;</span> &lt;&lt; parsed_sps-&gt;id &lt;&lt; <span class="hljs-string">&quot; and PPS id &quot;</span><br>                   &lt;&lt; parsed_pps-&gt;id &lt;&lt; <span class="hljs-string">&quot; (referencing SPS &quot;</span><br>                   &lt;&lt; parsed_pps-&gt;sps_id &lt;&lt; <span class="hljs-string">&quot;)&quot;</span>;<br>&#125;<br><br>&#125;  <span class="hljs-comment">// namespace video_coding</span><br>&#125;  <span class="hljs-comment">// namespace webrtc</span><br><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>modules/video_coding/h265_vps_sps_pps_tracker.h >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MODULES_VIDEO_CODING_H265_VPS_SPS_PPS_TRACKER_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MODULES_VIDEO_CODING_H265_VPS_SPS_PPS_TRACKER_H_</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdint&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;map&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;api/array_view.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/rtp_rtcp/source/rtp_video_header.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/copy_on_write_buffer.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> webrtc &#123;<br><span class="hljs-keyword">namespace</span> video_coding &#123;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">H265VpsSpsPpsTracker</span> &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-keyword">enum</span> <span class="hljs-title class_">PacketAction</span> &#123; kInsert, kDrop, kRequestKeyframe &#125;;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">FixedBitstream</span> &#123;<br>    PacketAction action;<br>    rtc::CopyOnWriteBuffer bitstream;<br>  &#125;;<br><br>  <span class="hljs-comment">// Returns fixed bitstream and modifies |video_header|.</span><br>  <span class="hljs-function">FixedBitstream <span class="hljs-title">CopyAndFixBitstream</span><span class="hljs-params">(rtc::ArrayView&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>&gt; bitstream,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     RTPVideoHeader* video_header)</span></span>;<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InsertVpsSpsPpsNalus</span><span class="hljs-params">(<span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">uint8_t</span>&gt;&amp; vps,</span></span><br><span class="hljs-params"><span class="hljs-function">                            <span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">uint8_t</span>&gt;&amp; sps,</span></span><br><span class="hljs-params"><span class="hljs-function">                            <span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">uint8_t</span>&gt;&amp; pps)</span></span>;<br><br> <span class="hljs-keyword">private</span>:<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">VpsInfo</span> &#123;<br>    <span class="hljs-type">size_t</span> size = <span class="hljs-number">0</span>;<br>    std::unique_ptr&lt;<span class="hljs-type">uint8_t</span>[]&gt; data;<br>  &#125;;<br><br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">PpsInfo</span> &#123;<br>    <span class="hljs-type">int</span> sps_id = <span class="hljs-number">-1</span>;<br>    <span class="hljs-type">size_t</span> size = <span class="hljs-number">0</span>;<br>    std::unique_ptr&lt;<span class="hljs-type">uint8_t</span>[]&gt; data;<br>  &#125;;<br><br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">SpsInfo</span> &#123;<br>    <span class="hljs-type">int</span> vps_id = <span class="hljs-number">-1</span>;<br>    <span class="hljs-type">size_t</span> size = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> width = <span class="hljs-number">-1</span>;<br>    <span class="hljs-type">int</span> height = <span class="hljs-number">-1</span>;<br>    std::unique_ptr&lt;<span class="hljs-type">uint8_t</span>[]&gt; data;<br>  &#125;;<br><br>  std::map&lt;<span class="hljs-type">uint32_t</span>, VpsInfo&gt; vps_data_;<br>  std::map&lt;<span class="hljs-type">uint32_t</span>, PpsInfo&gt; pps_data_;<br>  std::map&lt;<span class="hljs-type">uint32_t</span>, SpsInfo&gt; sps_data_;<br>&#125;;<br><br>&#125;  <span class="hljs-comment">// namespace video_coding</span><br>&#125;  <span class="hljs-comment">// namespace webrtc</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>  <span class="hljs-comment">// MODULES_VIDEO_CODING_H264_SPS_PPS_TRACKER_H_</span></span><br><br></code></pre></td></tr></table></figure>

<ul>
<li>在网络抖动缓存信息中新增枚举：</li>
</ul>
<figure class="highlight c++"><figcaption><span>modules/video_coding/jitter_buffer_common.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">enum</span> &#123; kH264StartCodeLengthBytes = <span class="hljs-number">4</span> &#125;;<br> <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br> <span class="hljs-keyword">enum</span> &#123; kH265StartCodeLengthBytes = <span class="hljs-number">4</span> &#125;;<br> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<ul>
<li><strong>PacketBuffer</strong>RTP包缓冲区增加H265支持：</li>
</ul>
<figure class="highlight c++"><figcaption><span>modules/video_coding/packet_buffer.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h264/h264_common.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_common.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/rtp_rtcp/source/rtp_header_extensions.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/rtp_rtcp/source/rtp_packet_received.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/rtp_rtcp/source/rtp_video_header.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/video_coding/codecs/h264/include/h264_globals.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/video_coding/codecs/h265/include/h265_globals.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/checks.h&quot;</span></span><br><br>...<br><br>std::vector&lt;std::unique_ptr&lt;PacketBuffer::Packet&gt;&gt; PacketBuffer::<span class="hljs-built_in">FindFrames</span>(<br>    <span class="hljs-type">uint16_t</span> seq_num) &#123;<br>  std::vector&lt;std::unique_ptr&lt;PacketBuffer::Packet&gt;&gt; found_frames;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; buffer_.<span class="hljs-built_in">size</span>() &amp;&amp; <span class="hljs-built_in">PotentialNewFrame</span>(seq_num); ++i) &#123;<br>...<br><br>      <span class="hljs-type">bool</span> is_h264_keyframe = <span class="hljs-literal">false</span>;<br>      <span class="hljs-type">bool</span> is_h265 = <span class="hljs-literal">false</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>     is_h265 = buffer_[start_index]-&gt;<span class="hljs-built_in">codec</span>() == kVideoCodecH265;<br>     <span class="hljs-type">bool</span> has_h265_sps = <span class="hljs-literal">false</span>;<br>     <span class="hljs-type">bool</span> has_h265_pps = <span class="hljs-literal">false</span>;<br>     <span class="hljs-type">bool</span> has_h265_idr = <span class="hljs-literal">false</span>;<br>     <span class="hljs-type">bool</span> is_h265_keyframe = <span class="hljs-literal">false</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      <span class="hljs-type">int</span> idr_width = <span class="hljs-number">-1</span>;<br>      <span class="hljs-type">int</span> idr_height = <span class="hljs-number">-1</span>;<br>      <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        ++tested_packets;<br><br>        <span class="hljs-keyword">if</span> (!is_h264 &amp;&amp; !is_h265 &amp;&amp; buffer_[start_index]-&gt;<span class="hljs-built_in">is_first_packet_in_frame</span>())<br>          <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">if</span> (is_h264) &#123;<br>          ...<br>        &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>       <span class="hljs-keyword">if</span> (is_h265 &amp;&amp; !is_h265_keyframe) &#123;<br>         <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>* h265_header = absl::<span class="hljs-built_in">get_if</span>&lt;RTPVideoHeaderH265&gt;(<br>             &amp;buffer_[start_index]-&gt;video_header.video_type_header);<br>         <span class="hljs-keyword">if</span> (!h265_header || h265_header-&gt;nalus_length &gt;= kMaxNalusPerPacket)<br>           <span class="hljs-keyword">return</span> found_frames;<br>         <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> j = <span class="hljs-number">0</span>; j &lt; h265_header-&gt;nalus_length; ++j) &#123;<br>           <span class="hljs-keyword">if</span> (h265_header-&gt;nalus[j].type == H265::NaluType::kSps) &#123;<br>             has_h265_sps = <span class="hljs-literal">true</span>;<br>           &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (h265_header-&gt;nalus[j].type == H265::NaluType::kPps) &#123;<br>             has_h265_pps = <span class="hljs-literal">true</span>;<br>           &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (h265_header-&gt;nalus[j].type == H265::NaluType::kIdrWRadl<br>                      || h265_header-&gt;nalus[j].type == H265::NaluType::kIdrNLp<br>                      || h265_header-&gt;nalus[j].type == H265::NaluType::kCra) &#123;<br>             has_h265_idr = <span class="hljs-literal">true</span>;<br>           &#125;<br>         &#125;<br>         <span class="hljs-keyword">if</span> ((has_h265_sps &amp;&amp; has_h265_pps) || has_h265_idr) &#123;<br>           is_h265_keyframe = <span class="hljs-literal">true</span>;<br>           <span class="hljs-comment">// Store the resolution of key frame which is the packet with</span><br>           <span class="hljs-comment">// smallest index and valid resolution; typically its IDR or SPS</span><br>           <span class="hljs-comment">// packet; there may be packet preceeding this packet, IDR&#x27;s</span><br>           <span class="hljs-comment">// resolution will be applied to them.</span><br>           <span class="hljs-keyword">if</span> (buffer_[start_index]-&gt;<span class="hljs-built_in">width</span>() &gt; <span class="hljs-number">0</span> &amp;&amp;<br>               buffer_[start_index]-&gt;<span class="hljs-built_in">height</span>() &gt; <span class="hljs-number">0</span>) &#123;<br>             idr_width = buffer_[start_index]-&gt;<span class="hljs-built_in">width</span>();<br>             idr_height = buffer_[start_index]-&gt;<span class="hljs-built_in">height</span>();<br>           &#125;<br>         &#125;<br>       &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>...<br><br>      <span class="hljs-keyword">if</span> (is_h264) &#123;<br>        ...<br>      &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>     <span class="hljs-keyword">if</span> (is_h265) &#123;<br>       <span class="hljs-comment">// Warn if this is an unsafe frame.</span><br>       <span class="hljs-keyword">if</span> (has_h265_idr &amp;&amp; (!has_h265_sps || !has_h265_pps)) &#123;<br>         <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING)<br>             &lt;&lt; <span class="hljs-string">&quot;Received H.265-IDR frame &quot;</span><br>             &lt;&lt; <span class="hljs-string">&quot;(SPS: &quot;</span> &lt;&lt; has_h265_sps &lt;&lt; <span class="hljs-string">&quot;, PPS: &quot;</span> &lt;&lt; has_h265_pps<br>             &lt;&lt; <span class="hljs-string">&quot;). Treating as delta frame since &quot;</span><br>             &lt;&lt;  <span class="hljs-string">&quot;WebRTC-SpsPpsIdrIsH265Keyframe is always enabled.&quot;</span>;<br>       &#125;<br><br>       <span class="hljs-comment">// Now that we have decided whether to treat this frame as a key frame</span><br>       <span class="hljs-comment">// or delta frame in the frame buffer, we update the field that</span><br>       <span class="hljs-comment">// determines if the RtpFrameObject is a key frame or delta frame.</span><br>       <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> first_packet_index = start_seq_num % buffer_.<span class="hljs-built_in">size</span>();<br>       <span class="hljs-keyword">if</span> (is_h265_keyframe) &#123;<br>         buffer_[first_packet_index]-&gt;video_header.frame_type =<br>             VideoFrameType::kVideoFrameKey;<br>         <span class="hljs-keyword">if</span> (idr_width &gt; <span class="hljs-number">0</span> &amp;&amp; idr_height &gt; <span class="hljs-number">0</span>) &#123;<br>           <span class="hljs-comment">// IDR frame was finalized and we have the correct resolution for</span><br>           <span class="hljs-comment">// IDR; update first packet to have same resolution as IDR.</span><br>           buffer_[first_packet_index]-&gt;video_header.width = idr_width;<br>           buffer_[first_packet_index]-&gt;video_header.height =<br>               idr_height;<br>         &#125;<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>         buffer_[first_packet_index]-&gt;video_header.frame_type =<br>             VideoFrameType::kVideoFrameDelta;<br>       &#125;<br><br>       <span class="hljs-comment">// If this is not a key frame, make sure there are no gaps in the</span><br>       <span class="hljs-comment">// packet sequence numbers up until this point.</span><br>       <span class="hljs-keyword">if</span> (!is_h265_keyframe &amp;&amp; missing_packets_.<span class="hljs-built_in">upper_bound</span>(start_seq_num) !=<br>                                    missing_packets_.<span class="hljs-built_in">begin</span>()) &#123;<br>         <span class="hljs-keyword">return</span> found_frames;<br>       &#125;<br>     &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>...<br><br>  &#125;<br>  <span class="hljs-keyword">return</span> found_frames;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>packet</strong> insetStartCode增加H265支持：</li>
</ul>
<figure class="highlight c++"><figcaption><span>modules/video_coding/packet.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++">      <span class="hljs-built_in">completeNALU</span>(kNaluIncomplete),<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>     <span class="hljs-built_in">insertStartCode</span>((videoHeader.codec == kVideoCodecH264 || videoHeader.codec == kVideoCodecH265) &amp;&amp;<br>                     videoHeader.is_first_packet_in_frame),<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>     <span class="hljs-built_in">insertStartCode</span>(videoHeader.codec == kVideoCodecH264 &amp;&amp;<br>                     videoHeader.is_first_packet_in_frame),<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      <span class="hljs-built_in">video_header</span>(videoHeader),<br></code></pre></td></tr></table></figure>

<ul>
<li>支持H265包拼接,新增函数<strong>GetH265NaluInfos</strong>：</li>
</ul>
<figure class="highlight c++"><figcaption><span>modules/video_coding/session_info.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs c++">+ <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>+ <span class="hljs-function">std::vector&lt;H265NaluInfo&gt; <span class="hljs-title">VCMSessionInfo::GetH265NaluInfos</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>+  <span class="hljs-keyword">if</span> (packets_.<span class="hljs-built_in">empty</span>() || packets_.<span class="hljs-built_in">front</span>().video_header.codec != kVideoCodecH265)<br>+    <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">vector</span>&lt;H265NaluInfo&gt;();<br>+  std::vector&lt;H265NaluInfo&gt; nalu_infos;<br>+  <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> VCMPacket&amp; packet : packets_) &#123;<br>+    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; h265 =<br>+        absl::<span class="hljs-built_in">get</span>&lt;RTPVideoHeaderH265&gt;(packet.video_header.video_type_header);<br>+    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; h265.nalus_length; ++i) &#123;<br>+      nalu_infos.<span class="hljs-built_in">push_back</span>(h265.nalus[i]);<br>+    &#125;<br>+  &#125;<br>+  <span class="hljs-keyword">return</span> nalu_infos;<br>+ &#125;<br>+ <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>...<br><br><span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">VCMSessionInfo::InsertBuffer</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span>* frame_buffer,</span></span><br><span class="hljs-params"><span class="hljs-function">                                    PacketIterator packet_it)</span> </span>&#123;<br>  ...<br>  <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> kH264NALHeaderLengthInBytes = <span class="hljs-number">1</span>;<br>+ <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>+  <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> kH265NALHeaderLengthInBytes = <span class="hljs-number">2</span>;<br>+  <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>* h265 =<br>+      absl::<span class="hljs-built_in">get_if</span>&lt;RTPVideoHeaderH265&gt;(&amp;packet.video_header.video_type_header);<br>+ <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  ...<br>    <span class="hljs-keyword">return</span> packet.sizeBytes;<br>+ <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>+  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (h265 &amp;&amp; h265-&gt;packetization_type == kH265AP) &#123;<br>+    <span class="hljs-comment">// Similar to H264, for H265 aggregation packets, we rely on jitter buffer</span><br>+    <span class="hljs-comment">// to remove the two length bytes between each NAL unit, and potentially add</span><br>+    <span class="hljs-comment">// start codes.</span><br>+    <span class="hljs-type">size_t</span> required_length = <span class="hljs-number">0</span>;<br>+    <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* nalu_ptr =<br>+        packet_buffer + kH265NALHeaderLengthInBytes;  <span class="hljs-comment">// skip payloadhdr</span><br>+    <span class="hljs-keyword">while</span> (nalu_ptr &lt; packet_buffer + packet.sizeBytes) &#123;<br>+      <span class="hljs-type">size_t</span> length = <span class="hljs-built_in">BufferToUWord16</span>(nalu_ptr);<br>+      required_length +=<br>+          length + (packet.insertStartCode ? kH265StartCodeLengthBytes : <span class="hljs-number">0</span>);<br>+      nalu_ptr += kLengthFieldLength + length;<br>+    &#125;<br>+    <span class="hljs-built_in">ShiftSubsequentPackets</span>(packet_it, required_length);<br>+    nalu_ptr = packet_buffer + kH265NALHeaderLengthInBytes;<br>+    <span class="hljs-type">uint8_t</span>* frame_buffer_ptr = frame_buffer + offset;<br>+    <span class="hljs-keyword">while</span> (nalu_ptr &lt; packet_buffer + packet.sizeBytes) &#123;<br>+      <span class="hljs-type">size_t</span> length = <span class="hljs-built_in">BufferToUWord16</span>(nalu_ptr);<br>+      nalu_ptr += kLengthFieldLength;<br>+      <span class="hljs-comment">// since H265 shares the same start code as H264, use the same Insert</span><br>+      <span class="hljs-comment">// function to handle start code.</span><br>+      frame_buffer_ptr += <span class="hljs-built_in">Insert</span>(nalu_ptr, length, packet.insertStartCode,<br>+                                 <span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">uint8_t</span>*&gt;(frame_buffer_ptr));<br>+      nalu_ptr += length;<br>+    &#125;<br>+    packet.sizeBytes = required_length;<br>+    <span class="hljs-keyword">return</span> packet.sizeBytes;<br>+ <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  &#125;<br>  <span class="hljs-built_in">ShiftSubsequentPackets</span>(<br>      packet_it, packet.sizeBytes +<br>                     (packet.insertStartCode ? kH264StartCodeLengthBytes : <span class="hljs-number">0</span>));<br><br>  packet.sizeBytes =<br>      <span class="hljs-built_in">Insert</span>(packet_buffer, packet.sizeBytes, packet.insertStartCode,<br>             <span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">uint8_t</span>*&gt;(packet.dataPtr));<br>  <span class="hljs-keyword">return</span> packet.sizeBytes;<br>&#125;<br><br>...<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">VCMSessionInfo::InsertPacket</span><span class="hljs-params">(<span class="hljs-type">const</span> VCMPacket&amp; packet,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-type">uint8_t</span>* frame_buffer,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-type">const</span> FrameData&amp; frame_data)</span> </span>&#123;<br><br>...<br><br>+ <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>+  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (packet.<span class="hljs-built_in">codec</span>() == kVideoCodecH265) &#123;<br>+    frame_type_ = packet.video_header.frame_type;<br>+    <span class="hljs-keyword">if</span> (packet.<span class="hljs-built_in">is_first_packet_in_frame</span>() &amp;&amp;<br>+        (first_packet_seq_num_ == <span class="hljs-number">-1</span> ||<br>+         <span class="hljs-built_in">IsNewerSequenceNumber</span>(first_packet_seq_num_, packet.seqNum))) &#123;<br>+      first_packet_seq_num_ = packet.seqNum;<br>+    &#125;<br>+    <span class="hljs-keyword">if</span> (packet.markerBit &amp;&amp;<br>+        (last_packet_seq_num_ == <span class="hljs-number">-1</span> ||<br>+         <span class="hljs-built_in">IsNewerSequenceNumber</span>(packet.seqNum, last_packet_seq_num_))) &#123;<br>+      last_packet_seq_num_ = packet.seqNum;<br>+    &#125;<br>+ <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>...<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(returnLength);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>modules/video_coding/session_info.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++">  <span class="hljs-function">std::vector&lt;NaluInfo&gt; <span class="hljs-title">GetNaluInfos</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br> <span class="hljs-function">std::vector&lt;H265NaluInfo&gt; <span class="hljs-title">GetH265NaluInfos</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<ul>
<li>将新增2个文件添加到ninja中参与构建：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">if</span> (rtc_use_h265) &#123;<br>    sources += [<br>      <span class="hljs-string">&quot;h265_vps_sps_pps_tracker.cc&quot;</span>,<br>      <span class="hljs-string">&quot;h265_vps_sps_pps_tracker.h&quot;</span>,<br>    ]<br>  &#125;<br></code></pre></td></tr></table></figure>

<h4 id="RTP相关支持"><a href="#RTP相关支持" class="headerlink" title="RTP相关支持"></a>RTP相关支持</h4><ul>
<li>配置最小码率枚举，避免编译不通过：</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">absl::optional&lt;DataRate&gt; <span class="hljs-title">GetExperimentalMinVideoBitrate</span><span class="hljs-params">(VideoCodecType type)</span> </span>&#123;<br>    ...<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>     <span class="hljs-keyword">case</span> kVideoCodecH265:<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      <span class="hljs-keyword">case</span> kVideoCodecGeneric:<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>使rtp载荷增加H265支持：</li>
</ul>
<figure class="highlight c++"><figcaption><span>video/rtp_video_stream_receiver.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RtpVideoStreamReceiver::OnReceivedPayloadData</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    rtc::CopyOnWriteBuffer codec_payload,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> RtpPacketReceived&amp; rtp_packet,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> RTPVideoHeader&amp; video)</span> </span>&#123;<br>...<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br> &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (packet-&gt;<span class="hljs-built_in">codec</span>() == kVideoCodecH265) &#123;<br>   <span class="hljs-comment">// Only when we start to receive packets will we know what payload type</span><br>   <span class="hljs-comment">// that will be used. When we know the payload type insert the correct</span><br>   <span class="hljs-comment">// sps/pps into the tracker.</span><br>   <span class="hljs-keyword">if</span> (packet-&gt;payload_type != last_payload_type_) &#123;<br>     last_payload_type_ = packet-&gt;payload_type;<br>     <span class="hljs-built_in">InsertSpsPpsIntoTracker</span>(packet-&gt;payload_type);<br>   &#125;<br><br>   video_coding::H265VpsSpsPpsTracker::FixedBitstream fixed =<br>       h265_tracker_.<span class="hljs-built_in">CopyAndFixBitstream</span>(<br>           rtc::<span class="hljs-built_in">MakeArrayView</span>(codec_payload.<span class="hljs-built_in">cdata</span>(), codec_payload.<span class="hljs-built_in">size</span>()),<br>           &amp;packet-&gt;video_header);<br><br>   <span class="hljs-keyword">switch</span> (fixed.action) &#123;<br>     <span class="hljs-keyword">case</span> video_coding::H265VpsSpsPpsTracker::kRequestKeyframe:<br>       rtcp_feedback_buffer_.<span class="hljs-built_in">RequestKeyFrame</span>();<br>       rtcp_feedback_buffer_.<span class="hljs-built_in">SendBufferedRtcpFeedback</span>();<br>       ABSL_FALLTHROUGH_INTENDED;<br>     <span class="hljs-keyword">case</span> video_coding::H265VpsSpsPpsTracker::kDrop:<br>       <span class="hljs-keyword">return</span>;<br>     <span class="hljs-keyword">case</span> video_coding::H265VpsSpsPpsTracker::kInsert:<br>       packet-&gt;video_payload = std::<span class="hljs-built_in">move</span>(fixed.bitstream);<br>       <span class="hljs-keyword">break</span>;<br>   &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    packet-&gt;video_payload = std::<span class="hljs-built_in">move</span>(codec_payload);<br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>video/rtp_video_stream_receiver.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/video_coding/h265_vps_sps_pps_tracker.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>...<br><br>  std::map&lt;<span class="hljs-type">uint8_t</span>, std::unique_ptr&lt;VideoRtpDepacketizer&gt;&gt; payload_type_map_;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br> video_coding::H265VpsSpsPpsTracker h265_tracker_;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>video/rtp_video_stream_receiver2.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RtpVideoStreamReceiver2::OnReceivedPayloadData</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    rtc::CopyOnWriteBuffer codec_payload,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> RtpPacketReceived&amp; rtp_packet,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> RTPVideoHeader&amp; video)</span> </span>&#123;<br>...<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br> &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (packet-&gt;<span class="hljs-built_in">codec</span>() == kVideoCodecH265) &#123;<br>   <span class="hljs-comment">// Only when we start to receive packets will we know what payload type</span><br>   <span class="hljs-comment">// that will be used. When we know the payload type insert the correct</span><br>   <span class="hljs-comment">// sps/pps into the tracker.</span><br>   <span class="hljs-keyword">if</span> (packet-&gt;payload_type != last_payload_type_) &#123;<br>     last_payload_type_ = packet-&gt;payload_type;<br>     <span class="hljs-built_in">InsertSpsPpsIntoTracker</span>(packet-&gt;payload_type);<br>   &#125;<br><br>   video_coding::H265VpsSpsPpsTracker::FixedBitstream fixed =<br>       h265_tracker_.<span class="hljs-built_in">CopyAndFixBitstream</span>(<br>           rtc::<span class="hljs-built_in">MakeArrayView</span>(codec_payload.<span class="hljs-built_in">cdata</span>(), codec_payload.<span class="hljs-built_in">size</span>()),<br>           &amp;packet-&gt;video_header);<br><br>   <span class="hljs-keyword">switch</span> (fixed.action) &#123;<br>     <span class="hljs-keyword">case</span> video_coding::H265VpsSpsPpsTracker::kRequestKeyframe:<br>       rtcp_feedback_buffer_.<span class="hljs-built_in">RequestKeyFrame</span>();<br>       rtcp_feedback_buffer_.<span class="hljs-built_in">SendBufferedRtcpFeedback</span>();<br>       ABSL_FALLTHROUGH_INTENDED;<br>     <span class="hljs-keyword">case</span> video_coding::H265VpsSpsPpsTracker::kDrop:<br>       <span class="hljs-keyword">return</span>;<br>     <span class="hljs-keyword">case</span> video_coding::H265VpsSpsPpsTracker::kInsert:<br>       packet-&gt;video_payload = std::<span class="hljs-built_in">move</span>(fixed.bitstream);<br>       <span class="hljs-keyword">break</span>;<br>   &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    packet-&gt;video_payload = std::<span class="hljs-built_in">move</span>(codec_payload);<br>  &#125;    <br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>video/rtp_video_stream_receiver2.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;modules/video_coding/h265_vps_sps_pps_tracker.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>...<br><br>  std::map&lt;<span class="hljs-type">uint8_t</span>, std::unique_ptr&lt;VideoRtpDepacketizer&gt;&gt; <span class="hljs-function">payload_type_map_</span><br><span class="hljs-function">      <span class="hljs-title">RTC_GUARDED_BY</span><span class="hljs-params">(worker_task_checker_)</span></span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br> video_coding::H265VpsSpsPpsTracker h265_tracker_;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<ul>
<li>统计支持：</li>
</ul>
<figure class="highlight c++"><figcaption><span>video/send_statistics_proxy.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">HistogramCodecType</span> &#123;<br>  kVideoUnknown = <span class="hljs-number">0</span>,<br>  kVideoVp8 = <span class="hljs-number">1</span>,<br>  kVideoVp9 = <span class="hljs-number">2</span>,<br>  kVideoH264 = <span class="hljs-number">3</span>,<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>  kVideoH265 = <span class="hljs-number">4</span>,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  kVideoMax = <span class="hljs-number">64</span>,<br>&#125;;<br><br><span class="hljs-function">HistogramCodecType <span class="hljs-title">PayloadNameToHistogramCodecType</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> std::string&amp; payload_name)</span> </span>&#123;<br>  VideoCodecType codecType = <span class="hljs-built_in">PayloadStringToCodecType</span>(payload_name);<br>  <span class="hljs-keyword">switch</span> (codecType) &#123;<br>    <span class="hljs-keyword">case</span> kVideoCodecVP8:<br>      <span class="hljs-keyword">return</span> kVideoVp8;<br>    <span class="hljs-keyword">case</span> kVideoCodecVP9:<br>      <span class="hljs-keyword">return</span> kVideoVp9;<br>    <span class="hljs-keyword">case</span> kVideoCodecH264:<br>      <span class="hljs-keyword">return</span> kVideoH264;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>   <span class="hljs-keyword">case</span> kVideoCodecH265:<br>     <span class="hljs-keyword">return</span> kVideoH265;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>      </span><br>    <span class="hljs-keyword">default</span>:<br>      <span class="hljs-keyword">return</span> kVideoUnknown;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>接收流解码器初始化支持：</li>
</ul>
<figure class="highlight c++"><figcaption><span>video/video_receive_stream.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">VideoCodec <span class="hljs-title">CreateDecoderVideoCodec</span><span class="hljs-params">(<span class="hljs-type">const</span> VideoReceiveStream::Decoder&amp; decoder)</span> </span>&#123;<br>  VideoCodec codec;<br>  <span class="hljs-built_in">memset</span>(&amp;codec, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(codec));<br><br>  codec.codecType = <span class="hljs-built_in">PayloadStringToCodecType</span>(decoder.video_format.name);<br><br>...<br><br>    <span class="hljs-keyword">return</span> associated_codec;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br> &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (codec.codecType == kVideoCodecH265) &#123;<br>   *(codec.<span class="hljs-built_in">H265</span>()) = VideoEncoder::<span class="hljs-built_in">GetDefaultH265Settings</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  &#125;<br>...<br><br>  <span class="hljs-keyword">return</span> codec;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>接收流编码器支持：</li>
</ul>
<figure class="highlight c++"><figcaption><span>video/video_stream_encoder.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">RequiresEncoderReset</span><span class="hljs-params">(<span class="hljs-type">const</span> VideoCodec&amp; prev_send_codec,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-type">const</span> VideoCodec&amp; new_send_codec,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-type">bool</span> was_encode_called_since_last_initialization)</span> </span>&#123;<br>...<br>    <span class="hljs-keyword">case</span> kVideoCodecH264:<br>      <span class="hljs-keyword">if</span> (new_send_codec.<span class="hljs-built_in">H264</span>() != prev_send_codec.<span class="hljs-built_in">H264</span>()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>   <span class="hljs-keyword">case</span> kVideoCodecH265:<br>     <span class="hljs-keyword">if</span> (new_send_codec.<span class="hljs-built_in">H265</span>() != prev_send_codec.<span class="hljs-built_in">H265</span>()) &#123;<br>       <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>     &#125;<br>     <span class="hljs-keyword">break</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="编解码器支持"><a href="#编解码器支持" class="headerlink" title="编解码器支持"></a>编解码器支持</h4><ul>
<li>视频数据中增加H265类型：</li>
</ul>
<figure class="highlight c++"><figcaption><span>api/video/encoded_image.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;api/video/video_codec_type.h&quot;</span></span><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>api/video/video_codec_type.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">VideoCodecType</span> &#123;<br>  <span class="hljs-comment">// Java_cpp_enum.py does not allow ifdef in enum class,</span><br>  <span class="hljs-comment">// so we have to create two version of VideoCodecType here </span><br>  kVideoCodecGeneric = <span class="hljs-number">0</span>,<br>  kVideoCodecVP8,<br>  kVideoCodecVP9,<br>  kVideoCodecAV1,<br>  kVideoCodecH264,<br>  kVideoCodecH265,<br>  kVideoCodecMultiplex,<br>&#125;;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">VideoCodecType</span> &#123;<br>  <span class="hljs-comment">// There are various memset(..., 0, ...) calls in the code that rely on</span><br>  <span class="hljs-comment">// kVideoCodecGeneric being zero.</span><br>  kVideoCodecGeneric = <span class="hljs-number">0</span>,<br>  kVideoCodecVP8,<br>  kVideoCodecVP9,<br>  kVideoCodecAV1,<br>  kVideoCodecH264,<br>  kVideoCodecMultiplex,<br>&#125;;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<ul>
<li>codec基本信息支持：</li>
</ul>
<figure class="highlight c++"><figcaption><span>api/video_codecs/video_codec.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">constexpr</span> <span class="hljs-type">char</span> kPayloadNameH264[] = <span class="hljs-string">&quot;H264&quot;</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br><span class="hljs-keyword">constexpr</span> <span class="hljs-type">char</span> kPayloadNameH265[] = <span class="hljs-string">&quot;H265&quot;</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>...<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br><span class="hljs-type">bool</span> VideoCodecH265::<span class="hljs-keyword">operator</span>==(<span class="hljs-type">const</span> VideoCodecH265&amp; other) <span class="hljs-type">const</span> &#123;<br> <span class="hljs-built_in">return</span> (frameDroppingOn == other.frameDroppingOn &amp;&amp;<br>         keyFrameInterval == other.keyFrameInterval &amp;&amp;<br>         vpsLen == other.vpsLen &amp;&amp; spsLen == other.spsLen &amp;&amp;<br>         ppsLen == other.ppsLen &amp;&amp;<br>         (spsLen == <span class="hljs-number">0</span> || <span class="hljs-built_in">memcmp</span>(spsData, other.spsData, spsLen) == <span class="hljs-number">0</span>) &amp;&amp;<br>         (ppsLen == <span class="hljs-number">0</span> || <span class="hljs-built_in">memcmp</span>(ppsData, other.ppsData, ppsLen) == <span class="hljs-number">0</span>));<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>...<br><br><span class="hljs-function"><span class="hljs-type">const</span> VideoCodecH264&amp; <span class="hljs-title">VideoCodec::H264</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-built_in">RTC_DCHECK_EQ</span>(codecType, kVideoCodecH264);<br>  <span class="hljs-keyword">return</span> codec_specific_.H264;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br><span class="hljs-function">VideoCodecH265* <span class="hljs-title">VideoCodec::H265</span><span class="hljs-params">()</span> </span>&#123;<br> <span class="hljs-built_in">RTC_DCHECK_EQ</span>(codecType, kVideoCodecH265);<br> <span class="hljs-keyword">return</span> &amp;codec_specific_.H265;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">const</span> VideoCodecH265&amp; <span class="hljs-title">VideoCodec::H265</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br> <span class="hljs-built_in">RTC_DCHECK_EQ</span>(codecType, kVideoCodecH265);<br> <span class="hljs-keyword">return</span> codec_specific_.H265;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title">CodecTypeToPayloadString</span><span class="hljs-params">(VideoCodecType type)</span> </span>&#123;<br>  ...<br>    <span class="hljs-keyword">case</span> kVideoCodecH264:<br>      <span class="hljs-keyword">return</span> kPayloadNameH264;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>   <span class="hljs-keyword">case</span> kVideoCodecH265:<br>     <span class="hljs-keyword">return</span> kPayloadNameH265;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-keyword">case</span> kVideoCodecMultiplex:<br>      <span class="hljs-keyword">return</span> kPayloadNameMultiplex;<br>    <span class="hljs-keyword">case</span> kVideoCodecGeneric:<br>      <span class="hljs-keyword">return</span> kPayloadNameGeneric;<br>&#125;<br><br><span class="hljs-function">VideoCodecType <span class="hljs-title">PayloadStringToCodecType</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; name)</span> </span>&#123;<br>  ...<br>  <span class="hljs-keyword">if</span> (absl::<span class="hljs-built_in">EqualsIgnoreCase</span>(name, kPayloadNameH264))<br>    <span class="hljs-keyword">return</span> kVideoCodecH264;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br> <span class="hljs-keyword">if</span> (absl::<span class="hljs-built_in">EqualsIgnoreCase</span>(name, kPayloadNameH265))<br>   <span class="hljs-keyword">return</span> kVideoCodecH265;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-keyword">if</span> (absl::<span class="hljs-built_in">EqualsIgnoreCase</span>(name, kPayloadNameMultiplex))<br>    <span class="hljs-keyword">return</span> kVideoCodecMultiplex;<br>  <span class="hljs-keyword">return</span> kVideoCodecGeneric;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>api/video_codecs/video_codec.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">VideoCodecH265</span> &#123;<br>  <span class="hljs-type">bool</span> <span class="hljs-keyword">operator</span>==(<span class="hljs-type">const</span> VideoCodecH265&amp; other) <span class="hljs-type">const</span>;<br>  <span class="hljs-type">bool</span> <span class="hljs-keyword">operator</span>!=(<span class="hljs-type">const</span> VideoCodecH265&amp; other) <span class="hljs-type">const</span> &#123;<br>    <span class="hljs-keyword">return</span> !(*<span class="hljs-keyword">this</span> == other);<br>  &#125;<br>  <span class="hljs-type">bool</span> frameDroppingOn;<br>  <span class="hljs-type">int</span> keyFrameInterval;<br>  <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* vpsData;<br>  <span class="hljs-type">size_t</span> vpsLen;<br>  <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* spsData;<br>  <span class="hljs-type">size_t</span> spsLen;<br>  <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* ppsData;<br>  <span class="hljs-type">size_t</span> ppsLen;<br>&#125;;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>...<br><br><span class="hljs-keyword">union</span> <span class="hljs-title class_">VideoCodecUnion</span> &#123;<br>  VideoCodecVP8 VP8;<br>  VideoCodecVP9 VP9;<br>  VideoCodecH264 H264;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>  VideoCodecH265 H265;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br><br>...<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RTC_EXPORT</span> VideoCodec &#123;<br> <span class="hljs-keyword">public</span>:<br>    ...<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>  <span class="hljs-function">VideoCodecH265* <span class="hljs-title">H265</span><span class="hljs-params">()</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">const</span> VideoCodecH265&amp; <span class="hljs-title">H265</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> </span><br> <span class="hljs-keyword">private</span>:<br>  <span class="hljs-comment">// TODO(hta): Consider replacing the union with a pointer type.</span><br>  <span class="hljs-comment">// This will allow removing the VideoCodec* types from this file.</span><br>  VideoCodecUnion codec_specific_;<br>&#125;;   <br></code></pre></td></tr></table></figure>

<ul>
<li>解码器降级支持：</li>
</ul>
<figure class="highlight c++"><figcaption><span>api/video_codecs/video_decoder_software_fallback_wrapper.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">VideoDecoderSoftwareFallbackWrapper::UpdateFallbackDecoderHistograms</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">switch</span> (codec_settings_.codecType) &#123;<br><br>    ...<br><br>    <span class="hljs-keyword">case</span> kVideoCodecH264:<br>      <span class="hljs-built_in">RTC_HISTOGRAM_COUNTS_100000</span>(kFallbackHistogramsUmaPrefix + <span class="hljs-string">&quot;H264&quot;</span>,<br>                                  hw_decoded_frames_since_last_fallback_);<br>      <span class="hljs-keyword">break</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>    <span class="hljs-keyword">case</span> kVideoCodecH265:<br>      <span class="hljs-built_in">RTC_HISTOGRAM_COUNTS_100000</span>(kFallbackHistogramsUmaPrefix + <span class="hljs-string">&quot;H265&quot;</span>,<br>                                  hw_decoded_frames_since_last_fallback_);<br>      <span class="hljs-keyword">break</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-keyword">case</span> kVideoCodecMultiplex:<br>      <span class="hljs-built_in">RTC_HISTOGRAM_COUNTS_100000</span>(kFallbackHistogramsUmaPrefix + <span class="hljs-string">&quot;Multiplex&quot;</span>,<br>                                  hw_decoded_frames_since_last_fallback_);<br>      <span class="hljs-keyword">break</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>编码器配置：</li>
</ul>
<figure class="highlight c++"><figcaption><span>api/video_codecs/video_encoder_config.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">void</span> VideoEncoderConfig::EncoderSpecificSettings::<span class="hljs-built_in">FillEncoderSpecificSettings</span>(<br>    VideoCodec* codec) <span class="hljs-type">const</span> &#123;<br>  <span class="hljs-keyword">if</span> (codec-&gt;codecType == kVideoCodecH264) &#123;<br>    <span class="hljs-built_in">FillVideoCodecH264</span>(codec-&gt;<span class="hljs-built_in">H264</span>());<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (codec-&gt;codecType == kVideoCodecVP8) &#123;<br>    <span class="hljs-built_in">FillVideoCodecVp8</span>(codec-&gt;<span class="hljs-built_in">VP8</span>());<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (codec-&gt;codecType == kVideoCodecVP9) &#123;<br>    <span class="hljs-built_in">FillVideoCodecVp9</span>(codec-&gt;<span class="hljs-built_in">VP9</span>());<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (codec-&gt;codecType == kVideoCodecH265) &#123;<br>    <span class="hljs-built_in">FillVideoCodecH265</span>(codec-&gt;<span class="hljs-built_in">H265</span>());<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">RTC_NOTREACHED</span>() &lt;&lt; <span class="hljs-string">&quot;Encoder specifics set/used for unknown codec type.&quot;</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br><span class="hljs-type">void</span> VideoEncoderConfig::EncoderSpecificSettings::<span class="hljs-built_in">FillVideoCodecH265</span>(<br>    VideoCodecH265* h265_settings) <span class="hljs-type">const</span> &#123;<br>  <span class="hljs-built_in">RTC_NOTREACHED</span>();<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>VideoEncoderConfig::H265EncoderSpecificSettings::<span class="hljs-built_in">H265EncoderSpecificSettings</span>(<br>    <span class="hljs-type">const</span> VideoCodecH265&amp; specifics)<br>    : <span class="hljs-built_in">specifics_</span>(specifics) &#123;&#125;<br><br><span class="hljs-type">void</span> VideoEncoderConfig::H265EncoderSpecificSettings::<span class="hljs-built_in">FillVideoCodecH265</span>(<br>    VideoCodecH265* h265_settings) <span class="hljs-type">const</span> &#123;<br>  *h265_settings = specifics_;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>api/video_codecs/video_encoder_config.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c++">  <span class="hljs-keyword">class</span> <span class="hljs-title class_">EncoderSpecificSettings</span> : <span class="hljs-keyword">public</span> rtc::RefCountInterface &#123;<br>   <span class="hljs-keyword">public</span>:<br>  ...<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">FillVideoCodecH264</span><span class="hljs-params">(VideoCodecH264* h264_settings)</span> <span class="hljs-type">const</span></span>;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">FillVideoCodecH265</span><span class="hljs-params">(VideoCodecH265* h265_settings)</span> <span class="hljs-type">const</span></span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>   <span class="hljs-keyword">private</span>:<br>    ~<span class="hljs-built_in">EncoderSpecificSettings</span>() <span class="hljs-keyword">override</span> &#123;&#125;<br>    <span class="hljs-keyword">friend</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VideoEncoderConfig</span>;<br>  &#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>  <span class="hljs-keyword">class</span> <span class="hljs-title class_">H265EncoderSpecificSettings</span> : <span class="hljs-keyword">public</span> EncoderSpecificSettings &#123;<br>   <span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">H265EncoderSpecificSettings</span><span class="hljs-params">(<span class="hljs-type">const</span> VideoCodecH265&amp; specifics)</span></span>;<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FillVideoCodecH265</span><span class="hljs-params">(VideoCodecH265* h265_settings)</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span>;<br><br>   <span class="hljs-keyword">private</span>:<br>    VideoCodecH265 specifics_;<br>  &#125;;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>api/video_codecs/video_encoder.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br><span class="hljs-function">VideoCodecH265 <span class="hljs-title">VideoEncoder::GetDefaultH265Settings</span><span class="hljs-params">()</span> </span>&#123;<br>  VideoCodecH265 h265_settings;<br>  <span class="hljs-built_in">memset</span>(&amp;h265_settings, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(h265_settings));<br><br>  <span class="hljs-comment">// h265_settings.profile = kProfileBase;</span><br>  h265_settings.frameDroppingOn = <span class="hljs-literal">true</span>;<br>  h265_settings.keyFrameInterval = <span class="hljs-number">3000</span>;<br>  h265_settings.spsData = <span class="hljs-literal">nullptr</span>;<br>  h265_settings.spsLen = <span class="hljs-number">0</span>;<br>  h265_settings.ppsData = <span class="hljs-literal">nullptr</span>;<br>  h265_settings.ppsLen = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-keyword">return</span> h265_settings;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>api/video_codecs/video_encoder.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++">  <span class="hljs-function"><span class="hljs-type">static</span> VideoCodecH264 <span class="hljs-title">GetDefaultH264Settings</span><span class="hljs-params">()</span></span>;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>  <span class="hljs-function"><span class="hljs-type">static</span> VideoCodecH265 <span class="hljs-title">GetDefaultH265Settings</span><span class="hljs-params">()</span></span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<ul>
<li>载荷配置：</li>
</ul>
<figure class="highlight c++"><figcaption><span>call/rtp_payload_params.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PopulateRtpWithCodecSpecifics</span><span class="hljs-params">(<span class="hljs-type">const</span> CodecSpecificInfo&amp; info,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   absl::optional&lt;<span class="hljs-type">int</span>&gt; spatial_index,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   RTPVideoHeader* rtp)</span> </span>&#123;<br> <span class="hljs-keyword">switch</span> (info.codecType) &#123;<br>    ...<br>    <span class="hljs-keyword">case</span> kVideoCodecH264: &#123;<br>      <span class="hljs-keyword">auto</span>&amp; h264_header = rtp-&gt;video_type_header.<span class="hljs-built_in">emplace</span>&lt;RTPVideoHeaderH264&gt;();<br>      h264_header.packetization_mode =<br>          info.codecSpecific.H264.packetization_mode;<br>      rtp-&gt;simulcastIdx = spatial_index.<span class="hljs-built_in">value_or</span>(<span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>    <span class="hljs-keyword">case</span> kVideoCodecH265: &#123;<br>      <span class="hljs-keyword">auto</span> h265_header = rtp-&gt;video_type_header.<span class="hljs-built_in">emplace</span>&lt;RTPVideoHeaderH265&gt;();<br>      h265_header.packetization_mode =<br>          info.codecSpecific.H265.packetization_mode;<br>    &#125;<br>    <span class="hljs-keyword">return</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>...<br> &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RtpPayloadParams::SetGeneric</span><span class="hljs-params">(<span class="hljs-type">const</span> CodecSpecificInfo* codec_specific_info,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-type">int64_t</span> frame_id,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-type">bool</span> is_keyframe,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  RTPVideoHeader* rtp_video_header)</span> </span>&#123;<br><br>...<br><br>  <span class="hljs-keyword">switch</span> (rtp_video_header-&gt;codec) &#123;<br>    ...<br>    <span class="hljs-keyword">case</span> VideoCodecType::kVideoCodecH264:<br>      <span class="hljs-keyword">if</span> (codec_specific_info) &#123;<br>        <span class="hljs-built_in">H264ToGeneric</span>(codec_specific_info-&gt;codecSpecific.H264, frame_id,<br>                      is_keyframe, rtp_video_header);<br>      &#125;<br>      <span class="hljs-keyword">return</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>    <span class="hljs-keyword">case</span> VideoCodecType::kVideoCodecH265:<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-keyword">case</span> VideoCodecType::kVideoCodecMultiplex:<br>      <span class="hljs-keyword">return</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="rtp信息解析配置"><a href="#rtp信息解析配置" class="headerlink" title="rtp信息解析配置"></a>rtp信息解析配置</h4><ul>
<li>在<strong>common_video</strong>中新增h265文件夹：</li>
</ul>
<figure class="highlight c++"><figcaption><span>common_video/h265/h265_bitstream_parser.cc >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_bitstream_parser.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdint&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_common.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/bit_buffer.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/logging.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> &#123;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> kMaxAbsQpDeltaValue = <span class="hljs-number">51</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> kMinQpValue = <span class="hljs-number">0</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> kMaxQpValue = <span class="hljs-number">51</span>;<br><br>&#125;  <span class="hljs-comment">// namespace</span><br><br><span class="hljs-keyword">namespace</span> webrtc &#123;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RETURN_ON_FAIL(x, res)            \</span><br><span class="hljs-meta">  <span class="hljs-keyword">if</span> (!(x)) &#123;                             \</span><br><span class="hljs-meta">    RTC_LOG_F(LS_ERROR) &lt;&lt; <span class="hljs-string">&quot;FAILED: &quot;</span> #x; \</span><br><span class="hljs-meta">    return res;                           \</span><br><span class="hljs-meta">  &#125;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RETURN_INV_ON_FAIL(x) RETURN_ON_FAIL(x, kInvalidStream)</span><br><br>H265BitstreamParser::<span class="hljs-built_in">H265BitstreamParser</span>() &#123;&#125;<br>H265BitstreamParser::~<span class="hljs-built_in">H265BitstreamParser</span>() &#123;&#125;<br><br><span class="hljs-function">H265BitstreamParser::Result <span class="hljs-title">H265BitstreamParser::ParseNonParameterSetNalu</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* source,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">size_t</span> source_length,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">uint8_t</span> nalu_type)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (!sps_ || !pps_)<br>    <span class="hljs-keyword">return</span> kInvalidStream;<br><br>  last_slice_qp_delta_ = absl::<span class="hljs-literal">nullopt</span>;<br>  <span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">uint8_t</span>&gt; slice_rbsp =<br>      H265::<span class="hljs-built_in">ParseRbsp</span>(source, source_length);<br>  <span class="hljs-keyword">if</span> (slice_rbsp.<span class="hljs-built_in">size</span>() &lt; H265::kNaluTypeSize)<br>    <span class="hljs-keyword">return</span> kInvalidStream;<br><br>  <span class="hljs-function">rtc::BitBuffer <span class="hljs-title">slice_reader</span><span class="hljs-params">(slice_rbsp.data() + H265::kNaluTypeSize,</span></span><br><span class="hljs-params"><span class="hljs-function">                              slice_rbsp.size() - H265::kNaluTypeSize)</span></span>;<br>  <span class="hljs-comment">// Check to see if this is an IDR slice, which has an extra field to parse</span><br>  <span class="hljs-comment">// out.</span><br>  <span class="hljs-comment">//bool is_idr = (source[0] &amp; 0x0F) == H265::NaluType::kIdr;</span><br>  <span class="hljs-comment">//uint8_t nal_ref_idc = (source[0] &amp; 0x60) &gt;&gt; 5;</span><br>  <span class="hljs-type">uint32_t</span> golomb_tmp;<br>  <span class="hljs-type">uint32_t</span> bits_tmp;<br><br>  <span class="hljs-comment">// first_slice_segment_in_pic_flag: u(1)</span><br>  <span class="hljs-type">uint32_t</span> first_slice_segment_in_pic_flag = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;first_slice_segment_in_pic_flag, <span class="hljs-number">1</span>));<br>  <span class="hljs-keyword">if</span> (H265::NaluType::kBlaWLp &lt;= nalu_type &amp;&amp;<br>      nalu_type &lt;= H265::NaluType::kRsvIrapVcl23) &#123;<br>    <span class="hljs-comment">// no_output_of_prior_pics_flag: u(1)</span><br>    <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, <span class="hljs-number">1</span>));<br>  &#125;<br>  <span class="hljs-comment">// slice_pic_parameter_set_id: ue(v)</span><br>  <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;golomb_tmp));<br>  <span class="hljs-type">uint32_t</span> dependent_slice_segment_flag = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> (first_slice_segment_in_pic_flag == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">if</span> (pps_-&gt;dependent_slice_segments_enabled_flag) &#123;<br>      <span class="hljs-comment">// dependent_slice_segment_flag: u(1)</span><br>      <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;dependent_slice_segment_flag, <span class="hljs-number">1</span>));<br>    &#125;<br><br>    <span class="hljs-comment">// slice_segment_address: u(v)</span><br>    <span class="hljs-type">int32_t</span> log2_ctb_size_y = sps_-&gt;log2_min_luma_coding_block_size_minus3 + <span class="hljs-number">3</span> + sps_-&gt;log2_diff_max_min_luma_coding_block_size;<br>    <span class="hljs-type">uint32_t</span> ctb_size_y = <span class="hljs-number">1</span> &lt;&lt; log2_ctb_size_y;<br>    <span class="hljs-type">uint32_t</span> pic_width_in_ctbs_y = sps_-&gt;pic_width_in_luma_samples / ctb_size_y;<br>    <span class="hljs-keyword">if</span>(sps_-&gt;pic_width_in_luma_samples % ctb_size_y)<br>      pic_width_in_ctbs_y++;<br><br>    <span class="hljs-type">uint32_t</span> pic_height_in_ctbs_y = sps_-&gt;pic_height_in_luma_samples / ctb_size_y;<br>    <span class="hljs-keyword">if</span>(sps_-&gt;pic_height_in_luma_samples % ctb_size_y)<br>      pic_height_in_ctbs_y++;<br><br>    <span class="hljs-type">uint32_t</span> slice_segment_address_bits = H265::<span class="hljs-built_in">Log2</span>(pic_height_in_ctbs_y * pic_width_in_ctbs_y);<br>    <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, slice_segment_address_bits));<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (dependent_slice_segment_flag == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; pps_-&gt;num_extra_slice_header_bits; i++) &#123;<br>      <span class="hljs-comment">// slice_reserved_flag: u(1)</span><br>      <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, <span class="hljs-number">1</span>));<br>    &#125;<br>    <span class="hljs-comment">// slice_type: ue(v)</span><br>    <span class="hljs-type">uint32_t</span> slice_type = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;slice_type));<br>    <span class="hljs-keyword">if</span> (pps_-&gt;output_flag_present_flag) &#123;<br>      <span class="hljs-comment">// pic_output_flag: u(1)</span><br>      <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, <span class="hljs-number">1</span>));<br>    &#125;<br>    <span class="hljs-keyword">if</span> (sps_-&gt;separate_colour_plane_flag) &#123;<br>      <span class="hljs-comment">// colour_plane_id: u(2)</span><br>      <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, <span class="hljs-number">2</span>));<br>    &#125;<br>    <span class="hljs-type">uint32_t</span> num_long_term_sps = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> num_long_term_pics = <span class="hljs-number">0</span>;<br>    std::vector&lt;<span class="hljs-type">uint32_t</span>&gt; lt_idx_sps;<br>    std::vector&lt;<span class="hljs-type">uint32_t</span>&gt; used_by_curr_pic_lt_flag;<br>    <span class="hljs-type">uint32_t</span> short_term_ref_pic_set_sps_flag = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> short_term_ref_pic_set_idx = <span class="hljs-number">0</span>;<br>    H265SpsParser::ShortTermRefPicSet short_term_ref_pic_set;<br>    <span class="hljs-type">uint32_t</span> slice_temporal_mvp_enabled_flag = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (nalu_type != H265::NaluType::kIdrWRadl &amp;&amp; nalu_type != H265::NaluType::kIdrNLp) &#123;<br>      <span class="hljs-comment">// slice_pic_order_cnt_lsb: u(v)</span><br>      <span class="hljs-type">uint32_t</span> slice_pic_order_cnt_lsb_bits = sps_-&gt;log2_max_pic_order_cnt_lsb_minus4 + <span class="hljs-number">4</span>;<br>      <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, slice_pic_order_cnt_lsb_bits));<br>      <span class="hljs-comment">// short_term_ref_pic_set_sps_flag: u(1)</span><br>      <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;short_term_ref_pic_set_sps_flag, <span class="hljs-number">1</span>));<br>      <span class="hljs-keyword">if</span> (!short_term_ref_pic_set_sps_flag) &#123;<br>        absl::optional&lt;H265SpsParser::ShortTermRefPicSet&gt; ref_pic_set<br>          = H265SpsParser::<span class="hljs-built_in">ParseShortTermRefPicSet</span>(sps_-&gt;num_short_term_ref_pic_sets,<br>            sps_-&gt;num_short_term_ref_pic_sets, sps_-&gt;short_term_ref_pic_set, *sps_, &amp;slice_reader);<br>        <span class="hljs-keyword">if</span> (ref_pic_set) &#123;<br>          short_term_ref_pic_set = *ref_pic_set;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">return</span> kInvalidStream;<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sps_-&gt;num_short_term_ref_pic_sets &gt; <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-comment">// short_term_ref_pic_set_idx: u(v)</span><br>        <span class="hljs-type">uint32_t</span> short_term_ref_pic_set_idx_bits = H265::<span class="hljs-built_in">Log2</span>(sps_-&gt;num_short_term_ref_pic_sets);<br>        <span class="hljs-keyword">if</span> ((<span class="hljs-type">uint32_t</span>)(<span class="hljs-number">1</span> &lt;&lt; short_term_ref_pic_set_idx_bits) &lt; sps_-&gt;num_short_term_ref_pic_sets) &#123;<br>          short_term_ref_pic_set_idx_bits++;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (short_term_ref_pic_set_idx_bits &gt; <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;short_term_ref_pic_set_idx, short_term_ref_pic_set_idx_bits));<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (sps_-&gt;long_term_ref_pics_present_flag) &#123;<br>        <span class="hljs-keyword">if</span> (sps_-&gt;num_long_term_ref_pics_sps &gt; <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-comment">// num_long_term_sps: ue(v)</span><br>          <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;num_long_term_sps));<br>        &#125;<br>        <span class="hljs-comment">// num_long_term_sps: ue(v)</span><br>        <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;num_long_term_pics));<br>        lt_idx_sps.<span class="hljs-built_in">resize</span>(num_long_term_sps + num_long_term_pics, <span class="hljs-number">0</span>);<br>        used_by_curr_pic_lt_flag.<span class="hljs-built_in">resize</span>(num_long_term_sps + num_long_term_pics, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; num_long_term_sps + num_long_term_pics; i++) &#123;<br>          <span class="hljs-keyword">if</span> (i &lt; num_long_term_sps) &#123;<br>            <span class="hljs-keyword">if</span> (sps_-&gt;num_long_term_ref_pics_sps &gt; <span class="hljs-number">1</span>) &#123;<br>              <span class="hljs-comment">// lt_idx_sps: u(v)</span><br>              <span class="hljs-type">uint32_t</span> lt_idx_sps_bits = H265::<span class="hljs-built_in">Log2</span>(sps_-&gt;num_long_term_ref_pics_sps);<br>              <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;lt_idx_sps[i], lt_idx_sps_bits));<br>            &#125;<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// poc_lsb_lt: u(v)</span><br>            <span class="hljs-type">uint32_t</span> poc_lsb_lt_bits = sps_-&gt;log2_max_pic_order_cnt_lsb_minus4 + <span class="hljs-number">4</span>;<br>            <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, poc_lsb_lt_bits));<br>            <span class="hljs-comment">// used_by_curr_pic_lt_flag: u(1)</span><br>            <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;used_by_curr_pic_lt_flag[i], <span class="hljs-number">1</span>));<br>          &#125;<br>          <span class="hljs-comment">// delta_poc_msb_present_flag: u(1)</span><br>          <span class="hljs-type">uint32_t</span> delta_poc_msb_present_flag = <span class="hljs-number">0</span>;<br>          <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;delta_poc_msb_present_flag, <span class="hljs-number">1</span>));<br>          <span class="hljs-keyword">if</span> (delta_poc_msb_present_flag) &#123;<br>            <span class="hljs-comment">// delta_poc_msb_cycle_lt: ue(v)</span><br>            <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;golomb_tmp));<br>          &#125;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (sps_-&gt;sps_temporal_mvp_enabled_flag) &#123;<br>        <span class="hljs-comment">// slice_temporal_mvp_enabled_flag: u(1)</span><br>        <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;slice_temporal_mvp_enabled_flag, <span class="hljs-number">1</span>));<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (sps_-&gt;sample_adaptive_offset_enabled_flag) &#123;<br>      <span class="hljs-comment">// slice_sao_luma_flag: u(1)</span><br>      <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, <span class="hljs-number">1</span>));<br>      <span class="hljs-type">uint32_t</span> chroma_array_type = sps_-&gt;separate_colour_plane_flag == <span class="hljs-number">0</span> ? sps_-&gt;chroma_format_idc : <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">if</span> (chroma_array_type != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// slice_sao_chroma_flag: u(1)</span><br>        <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, <span class="hljs-number">1</span>));<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (slice_type == H265::SliceType::kP || slice_type == H265::SliceType::kB) &#123;<br>      <span class="hljs-comment">// num_ref_idx_active_override_flag: u(1)</span><br>      <span class="hljs-type">uint32_t</span> num_ref_idx_active_override_flag = <span class="hljs-number">0</span>;<br>      <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;num_ref_idx_active_override_flag, <span class="hljs-number">1</span>));<br>      <span class="hljs-type">uint32_t</span> num_ref_idx_l0_active_minus1 = pps_-&gt;num_ref_idx_l0_default_active_minus1;<br>      <span class="hljs-type">uint32_t</span> num_ref_idx_l1_active_minus1 = pps_-&gt;num_ref_idx_l1_default_active_minus1;<br>      <span class="hljs-keyword">if</span> (num_ref_idx_active_override_flag) &#123;<br>        <span class="hljs-comment">// num_ref_idx_l0_active_minus1: ue(v)</span><br>        <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;num_ref_idx_l0_active_minus1));<br>        <span class="hljs-keyword">if</span> (slice_type == H265::SliceType::kB) &#123;<br>          <span class="hljs-comment">// num_ref_idx_l1_active_minus1: ue(v)</span><br>          <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;num_ref_idx_l1_active_minus1));<br>        &#125;<br>      &#125;<br>      <span class="hljs-type">uint32_t</span> num_pic_total_curr = <span class="hljs-built_in">CalcNumPocTotalCurr</span>(<br>          num_long_term_sps, num_long_term_pics, lt_idx_sps,<br>          used_by_curr_pic_lt_flag, short_term_ref_pic_set_sps_flag,<br>          short_term_ref_pic_set_idx, short_term_ref_pic_set);<br>      <span class="hljs-keyword">if</span> (pps_-&gt;lists_modification_present_flag &amp;&amp; num_pic_total_curr &gt; <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-comment">// ref_pic_lists_modification()</span><br>        <span class="hljs-type">uint32_t</span> list_entry_bits = H265::<span class="hljs-built_in">Log2</span>(num_pic_total_curr);<br>        <span class="hljs-keyword">if</span> ((<span class="hljs-type">uint32_t</span>)(<span class="hljs-number">1</span> &lt;&lt; list_entry_bits) &lt; num_pic_total_curr) &#123;<br>          list_entry_bits++;<br>        &#125;<br>        <span class="hljs-comment">// ref_pic_list_modification_flag_l0: u(1)</span><br>        <span class="hljs-type">uint32_t</span> ref_pic_list_modification_flag_l0 = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;ref_pic_list_modification_flag_l0, <span class="hljs-number">1</span>));<br>        <span class="hljs-keyword">if</span> (ref_pic_list_modification_flag_l0) &#123;<br>          <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; num_ref_idx_l0_active_minus1; i++) &#123;<br>            <span class="hljs-comment">// list_entry_l0: u(v)</span><br>            <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, list_entry_bits));<br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (slice_type == H265::SliceType::kB) &#123;<br>          <span class="hljs-comment">// ref_pic_list_modification_flag_l1: u(1)</span><br>          <span class="hljs-type">uint32_t</span> ref_pic_list_modification_flag_l1 = <span class="hljs-number">0</span>;<br>          <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;ref_pic_list_modification_flag_l1, <span class="hljs-number">1</span>));<br>          <span class="hljs-keyword">if</span> (ref_pic_list_modification_flag_l1) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; num_ref_idx_l1_active_minus1; i++) &#123;<br>              <span class="hljs-comment">// list_entry_l1: u(v)</span><br>              <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, list_entry_bits));<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (slice_type == H265::SliceType::kB) &#123;<br>        <span class="hljs-comment">// mvd_l1_zero_flag: u(1)</span><br>        <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, <span class="hljs-number">1</span>));<br>      &#125;<br>      <span class="hljs-keyword">if</span> (pps_-&gt;cabac_init_present_flag) &#123;<br>        <span class="hljs-comment">// cabac_init_flag: u(1)</span><br>        <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, <span class="hljs-number">1</span>));<br>      &#125;<br>      <span class="hljs-keyword">if</span> (slice_temporal_mvp_enabled_flag) &#123;<br>        <span class="hljs-type">uint32_t</span> collocated_from_l0_flag = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (slice_type == H265::SliceType::kB) &#123;<br>          <span class="hljs-comment">// collocated_from_l0_flag: u(1)</span><br>          <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;collocated_from_l0_flag, <span class="hljs-number">1</span>));<br>        &#125;<br>        <span class="hljs-keyword">if</span> ((collocated_from_l0_flag &amp;&amp; num_ref_idx_l0_active_minus1 &gt; <span class="hljs-number">0</span>)<br>          || (!collocated_from_l0_flag &amp;&amp; num_ref_idx_l1_active_minus1 &gt; <span class="hljs-number">0</span>)) &#123;<br>          <span class="hljs-comment">// collocated_ref_idx: ue(v)</span><br>          <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;golomb_tmp));<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> ((pps_-&gt;weighted_pred_flag &amp;&amp; slice_type == H265::SliceType::kP)<br>          || (pps_-&gt;weighted_bipred_flag &amp;&amp; slice_type == H265::SliceType::kB)) &#123;<br>        <span class="hljs-comment">// pred_weight_table()</span><br>        <span class="hljs-comment">// TODO(piasy): Do we need support for pred_weight_table()?</span><br>        <span class="hljs-built_in">RTC_LOG</span>(LS_ERROR) &lt;&lt; <span class="hljs-string">&quot;Streams with pred_weight_table unsupported.&quot;</span>;<br>        <span class="hljs-keyword">return</span> kUnsupportedStream;<br>      &#125;<br>      <span class="hljs-comment">// five_minus_max_num_merge_cand: ue(v)</span><br>      <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;golomb_tmp));<br>      <span class="hljs-comment">// TODO(piasy): motion_vector_resolution_control_idc?</span><br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// slice_qp_delta: se(v)</span><br>  <span class="hljs-type">int32_t</span> last_slice_qp_delta;<br>  <span class="hljs-built_in">RETURN_INV_ON_FAIL</span>(<br>      slice_reader.<span class="hljs-built_in">ReadSignedExponentialGolomb</span>(&amp;last_slice_qp_delta));<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">abs</span>(last_slice_qp_delta) &gt; kMaxAbsQpDeltaValue) &#123;<br>    <span class="hljs-comment">// Something has gone wrong, and the parsed value is invalid.</span><br>    <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="hljs-string">&quot;Parsed QP value out of range.&quot;</span>;<br>    <span class="hljs-keyword">return</span> kInvalidStream;<br>  &#125;<br><br>  last_slice_qp_delta_ = last_slice_qp_delta;<br><br>  <span class="hljs-keyword">return</span> kOk;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">uint32_t</span> <span class="hljs-title">H265BitstreamParser::CalcNumPocTotalCurr</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">uint32_t</span> num_long_term_sps, <span class="hljs-type">uint32_t</span> num_long_term_pics,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">uint32_t</span>&gt; lt_idx_sps,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">uint32_t</span>&gt; used_by_curr_pic_lt_flag,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">uint32_t</span> short_term_ref_pic_set_sps_flag,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">uint32_t</span> short_term_ref_pic_set_idx,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> H265SpsParser::ShortTermRefPicSet&amp; short_term_ref_pic_set)</span> </span>&#123;<br>  <span class="hljs-type">uint32_t</span> num_poc_total_curr = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">uint32_t</span> curr_sps_idx;<br><br>  <span class="hljs-type">bool</span> used_by_curr_pic_lt[<span class="hljs-number">16</span>];<br>  <span class="hljs-type">uint32_t</span> num_long_term = num_long_term_sps + num_long_term_pics;<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; num_long_term; i++) &#123;<br>    <span class="hljs-keyword">if</span> (i &lt; num_long_term_sps) &#123;<br>      used_by_curr_pic_lt[i] = sps_-&gt;used_by_curr_pic_lt_sps_flag[lt_idx_sps[i]];<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      used_by_curr_pic_lt[i] = used_by_curr_pic_lt_flag[i];<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (short_term_ref_pic_set_sps_flag) &#123;<br>    curr_sps_idx = short_term_ref_pic_set_idx;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    curr_sps_idx = sps_-&gt;num_short_term_ref_pic_sets;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (sps_-&gt;short_term_ref_pic_set.<span class="hljs-built_in">size</span>() &lt;= curr_sps_idx) &#123;<br>    <span class="hljs-keyword">if</span> (curr_sps_idx != <span class="hljs-number">0</span> || short_term_ref_pic_set_sps_flag) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-type">const</span> H265SpsParser::ShortTermRefPicSet* ref_pic_set;<br>  <span class="hljs-keyword">if</span> (curr_sps_idx &lt; sps_-&gt;short_term_ref_pic_set.<span class="hljs-built_in">size</span>()) &#123;<br>    ref_pic_set = &amp;(sps_-&gt;short_term_ref_pic_set[curr_sps_idx]);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    ref_pic_set = &amp;short_term_ref_pic_set;<br>  &#125;<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; ref_pic_set-&gt;num_negative_pics; i++) &#123;<br>    <span class="hljs-keyword">if</span> (ref_pic_set-&gt;used_by_curr_pic_s0_flag[i]) &#123;<br>      num_poc_total_curr++;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; ref_pic_set-&gt;num_positive_pics; i++) &#123;<br>    <span class="hljs-keyword">if</span> (ref_pic_set-&gt;used_by_curr_pic_s1_flag[i]) &#123;<br>      num_poc_total_curr++;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; num_long_term_sps + num_long_term_pics; i++) &#123;<br>    <span class="hljs-keyword">if</span> (used_by_curr_pic_lt[i]) &#123;<br>      num_poc_total_curr++;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> num_poc_total_curr;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">H265BitstreamParser::ParseSlice</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* slice, <span class="hljs-type">size_t</span> length)</span> </span>&#123;<br>  H265::NaluType nalu_type = H265::<span class="hljs-built_in">ParseNaluType</span>(slice[<span class="hljs-number">0</span>]);<br>  <span class="hljs-keyword">if</span> (nalu_type == H265::NaluType::kSps) &#123;<br>      sps_ = H265SpsParser::<span class="hljs-built_in">ParseSps</span>(slice + H265::kNaluTypeSize,<br>                                     length - H265::kNaluTypeSize);<br>      <span class="hljs-keyword">if</span> (!sps_) &#123;<br>        <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="hljs-string">&quot;Unable to parse SPS from H265 bitstream.&quot;</span>;<br>      &#125;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nalu_type == H265::NaluType::kPps) &#123;<br>      pps_ = H265PpsParser::<span class="hljs-built_in">ParsePps</span>(slice + H265::kNaluTypeSize,<br>                                     length - H265::kNaluTypeSize);<br>      <span class="hljs-keyword">if</span> (!pps_) &#123;<br>        <span class="hljs-built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="hljs-string">&quot;Unable to parse PPS from H265 bitstream.&quot;</span>;<br>      &#125;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nalu_type &lt;= H265::NaluType::kRsvIrapVcl23) &#123;<br>      Result res = <span class="hljs-built_in">ParseNonParameterSetNalu</span>(slice, length, nalu_type);<br>      <span class="hljs-keyword">if</span> (res != kOk) &#123;<br>        <span class="hljs-built_in">RTC_LOG</span>(LS_INFO) &lt;&lt; <span class="hljs-string">&quot;Failed to parse bitstream. Error: &quot;</span> &lt;&lt; res;<br>      &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">H265BitstreamParser::ParseBitstream</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* bitstream,</span></span><br><span class="hljs-params"><span class="hljs-function">                                         <span class="hljs-type">size_t</span> length)</span> </span>&#123;<br>  std::vector&lt;H265::NaluIndex&gt; nalu_indices =<br>      H265::<span class="hljs-built_in">FindNaluIndices</span>(bitstream, length);<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> H265::NaluIndex&amp; index : nalu_indices)<br>    <span class="hljs-built_in">ParseSlice</span>(&amp;bitstream[index.payload_start_offset], index.payload_size);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">H265BitstreamParser::GetLastSliceQp</span><span class="hljs-params">(<span class="hljs-type">int</span>* qp)</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (!last_slice_qp_delta_ || !pps_) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br>  <span class="hljs-type">const</span> <span class="hljs-type">int</span> parsed_qp = <span class="hljs-number">26</span> + pps_-&gt;pic_init_qp_minus26 + *last_slice_qp_delta_;<br>  <span class="hljs-keyword">if</span> (parsed_qp &lt; kMinQpValue || parsed_qp &gt; kMaxQpValue) &#123;<br>    <span class="hljs-built_in">RTC_LOG</span>(LS_ERROR) &lt;&lt; <span class="hljs-string">&quot;Parsed invalid QP from bitstream.&quot;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br>  *qp = parsed_qp;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">H265BitstreamParser::ParseBitstream</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    rtc::ArrayView&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>&gt; bitstream)</span> </span>&#123;<br>  <span class="hljs-built_in">ParseBitstream</span>(bitstream.<span class="hljs-built_in">data</span>(), bitstream.<span class="hljs-built_in">size</span>());<br>&#125;<br><br><span class="hljs-function">absl::optional&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">H265BitstreamParser::GetLastSliceQp</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-type">int</span> qp;<br>  <span class="hljs-type">bool</span> success = <span class="hljs-built_in">GetLastSliceQp</span>(&amp;qp);<br>  <span class="hljs-keyword">return</span> success ? absl::<span class="hljs-built_in">optional</span>&lt;<span class="hljs-type">int</span>&gt;(qp) : absl::<span class="hljs-literal">nullopt</span>;<br>&#125;<br><br>&#125;  <span class="hljs-comment">// namespace webrtc</span><br><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>common_video/h265/h265_bitstream_parser.h >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> COMMON_VIDEO_H265_H265_BITSTREAM_PARSER_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMON_VIDEO_H265_H265_BITSTREAM_PARSER_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;absl/types/optional.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;api/video_codecs/bitstream_parser.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_pps_parser.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_sps_parser.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> webrtc &#123;<br><br><span class="hljs-comment">// Stateful H265 bitstream parser (due to SPS/PPS). Used to parse out QP values</span><br><span class="hljs-comment">// from the bitstream.</span><br><span class="hljs-comment">// TODO(pbos): Unify with RTP SPS parsing and only use one H265 parser.</span><br><span class="hljs-comment">// TODO(pbos): If/when this gets used on the receiver side CHECKs must be</span><br><span class="hljs-comment">// removed and gracefully abort as we have no control over receive-side</span><br><span class="hljs-comment">// bitstreams.</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">H265BitstreamParser</span> : <span class="hljs-keyword">public</span> BitstreamParser &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">H265BitstreamParser</span>();<br>  ~<span class="hljs-built_in">H265BitstreamParser</span>() <span class="hljs-keyword">override</span>;<br><br>  <span class="hljs-comment">// These are here for backwards-compatability for the time being.</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ParseBitstream</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* bitstream, <span class="hljs-type">size_t</span> length)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">GetLastSliceQp</span><span class="hljs-params">(<span class="hljs-type">int</span>* qp)</span> <span class="hljs-type">const</span></span>;<br><br>  <span class="hljs-comment">// New interface.</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ParseBitstream</span><span class="hljs-params">(rtc::ArrayView&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>&gt; bitstream)</span> <span class="hljs-keyword">override</span></span>;<br>  <span class="hljs-function">absl::optional&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">GetLastSliceQp</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span>;<br><br> <span class="hljs-keyword">protected</span>:<br>  <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Result</span> &#123;<br>    kOk,<br>    kInvalidStream,<br>    kUnsupportedStream,<br>  &#125;;<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ParseSlice</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* slice, <span class="hljs-type">size_t</span> length)</span></span>;<br>  <span class="hljs-function">Result <span class="hljs-title">ParseNonParameterSetNalu</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* source,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-type">size_t</span> source_length,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-type">uint8_t</span> nalu_type)</span></span>;<br><br>  <span class="hljs-function"><span class="hljs-type">uint32_t</span> <span class="hljs-title">CalcNumPocTotalCurr</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> num_long_term_sps,</span></span><br><span class="hljs-params"><span class="hljs-function">                               <span class="hljs-type">uint32_t</span> num_long_term_pics,</span></span><br><span class="hljs-params"><span class="hljs-function">                               <span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">uint32_t</span>&gt; lt_idx_sps,</span></span><br><span class="hljs-params"><span class="hljs-function">                               <span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">uint32_t</span>&gt; used_by_curr_pic_lt_flag,</span></span><br><span class="hljs-params"><span class="hljs-function">                               <span class="hljs-type">uint32_t</span> short_term_ref_pic_set_sps_flag,</span></span><br><span class="hljs-params"><span class="hljs-function">                               <span class="hljs-type">uint32_t</span> short_term_ref_pic_set_idx,</span></span><br><span class="hljs-params"><span class="hljs-function">                               <span class="hljs-type">const</span> H265SpsParser::ShortTermRefPicSet&amp; short_term_ref_pic_set)</span></span>;<br><br>  <span class="hljs-comment">// SPS/PPS state, updated when parsing new SPS/PPS, used to parse slices.</span><br>  absl::optional&lt;H265SpsParser::SpsState&gt; sps_;<br>  absl::optional&lt;H265PpsParser::PpsState&gt; pps_;<br><br>  <span class="hljs-comment">// Last parsed slice QP.</span><br>  absl::optional&lt;<span class="hljs-type">int32_t</span>&gt; last_slice_qp_delta_;<br>&#125;;<br><br>&#125;  <span class="hljs-comment">// namespace webrtc</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>  <span class="hljs-comment">// COMMON_VIDEO_H265_H265_BITSTREAM_PARSER_H_</span></span><br><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>common_video/h265/h265_common.cc >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_common.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h264/h264_common.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> webrtc &#123;<br><span class="hljs-keyword">namespace</span> H265 &#123;<br><br><span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> kNaluTypeMask = <span class="hljs-number">0x7E</span>;<br><br><span class="hljs-function">std::vector&lt;NaluIndex&gt; <span class="hljs-title">FindNaluIndices</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* buffer,</span></span><br><span class="hljs-params"><span class="hljs-function">                                       <span class="hljs-type">size_t</span> buffer_size)</span> </span>&#123;<br>  std::vector&lt;H264::NaluIndex&gt; indices = H264::<span class="hljs-built_in">FindNaluIndices</span>(buffer, buffer_size);<br>  std::vector&lt;NaluIndex&gt; results;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; index : indices) &#123;<br>    results.<span class="hljs-built_in">push_back</span>(&#123;index.start_offset, index.payload_start_offset, index.payload_size&#125;);<br>  &#125;<br>  <span class="hljs-keyword">return</span> results;<br>&#125;<br><br><span class="hljs-function">NaluType <span class="hljs-title">ParseNaluType</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> data)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">static_cast</span>&lt;NaluType&gt;((data &amp; kNaluTypeMask) &gt;&gt; <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-function">std::vector&lt;<span class="hljs-type">uint8_t</span>&gt; <span class="hljs-title">ParseRbsp</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* data, <span class="hljs-type">size_t</span> length)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> H264::<span class="hljs-built_in">ParseRbsp</span>(data, length);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">WriteRbsp</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* bytes, <span class="hljs-type">size_t</span> length, rtc::Buffer* destination)</span> </span>&#123;<br>  H264::<span class="hljs-built_in">WriteRbsp</span>(bytes, length, destination);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">uint32_t</span> <span class="hljs-title">Log2</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> value)</span> </span>&#123;<br>  <span class="hljs-type">uint32_t</span> result = <span class="hljs-number">0</span>;<br>  <span class="hljs-comment">// If value is not a power of two an additional bit is required</span><br>  <span class="hljs-comment">// to account for the ceil() of log2() below.</span><br>  <span class="hljs-keyword">if</span> ((value &amp; (value - <span class="hljs-number">1</span>)) != <span class="hljs-number">0</span>) &#123;<br>    ++result;<br>  &#125;<br>  <span class="hljs-keyword">while</span> (value &gt; <span class="hljs-number">0</span>) &#123;<br>    value &gt;&gt;= <span class="hljs-number">1</span>;<br>    ++result;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br><br>&#125;  <span class="hljs-comment">// namespace H265</span><br>&#125;  <span class="hljs-comment">// namespace webrtc</span><br><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>common_video/h265/h265_common.h >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> COMMON_VIDEO_H265_H265_COMMON_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMON_VIDEO_H265_H265_COMMON_H_</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/buffer.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> webrtc &#123;<br><br><span class="hljs-keyword">namespace</span> H265 &#123;<br><span class="hljs-comment">// The size of a full NALU start sequence &#123;0 0 0 1&#125;, used for the first NALU</span><br><span class="hljs-comment">// of an access unit, and for SPS and PPS blocks.</span><br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> kNaluLongStartSequenceSize = <span class="hljs-number">4</span>;<br><br><span class="hljs-comment">// The size of a shortened NALU start sequence &#123;0 0 1&#125;, that may be used if</span><br><span class="hljs-comment">// not the first NALU of an access unit or an SPS or PPS block.</span><br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> kNaluShortStartSequenceSize = <span class="hljs-number">3</span>;<br><br><span class="hljs-comment">// The size of the NALU type byte (2).</span><br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> kNaluTypeSize = <span class="hljs-number">2</span>;<br><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">NaluType</span> : <span class="hljs-type">uint8_t</span> &#123;<br>  kTrailN = <span class="hljs-number">0</span>,<br>  kTrailR = <span class="hljs-number">1</span>,<br>  kTsaN = <span class="hljs-number">2</span>,<br>  kTsaR = <span class="hljs-number">3</span>,<br>  kStsaN = <span class="hljs-number">4</span>,<br>  kStsaR = <span class="hljs-number">5</span>,<br>  kRadlN = <span class="hljs-number">6</span>,<br>  kRadlR = <span class="hljs-number">7</span>,<br>  kBlaWLp = <span class="hljs-number">16</span>,<br>  kBlaWRadl = <span class="hljs-number">17</span>,<br>  kBlaNLp = <span class="hljs-number">18</span>,<br>  kIdrWRadl = <span class="hljs-number">19</span>,<br>  kIdrNLp = <span class="hljs-number">20</span>,<br>  kCra = <span class="hljs-number">21</span>,<br>  kRsvIrapVcl23 = <span class="hljs-number">23</span>,<br>  kVps = <span class="hljs-number">32</span>,<br>  kSps = <span class="hljs-number">33</span>,<br>  kPps = <span class="hljs-number">34</span>,<br>  kAud = <span class="hljs-number">35</span>,<br>  kPrefixSei = <span class="hljs-number">39</span>,<br>  kSuffixSei = <span class="hljs-number">40</span>,<br>  kAP = <span class="hljs-number">48</span>,<br>  kFU = <span class="hljs-number">49</span><br>&#125;;<br><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">SliceType</span> : <span class="hljs-type">uint8_t</span> &#123; kB = <span class="hljs-number">0</span>, kP = <span class="hljs-number">1</span>, kI = <span class="hljs-number">2</span> &#125;;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">NaluIndex</span> &#123;<br>  <span class="hljs-comment">// Start index of NALU, including start sequence.</span><br>  <span class="hljs-type">size_t</span> start_offset;<br>  <span class="hljs-comment">// Start index of NALU payload, typically type header.</span><br>  <span class="hljs-type">size_t</span> payload_start_offset;<br>  <span class="hljs-comment">// Length of NALU payload, in bytes, counting from payload_start_offset.</span><br>  <span class="hljs-type">size_t</span> payload_size;<br>&#125;;<br><br><span class="hljs-comment">// Returns a vector of the NALU indices in the given buffer.</span><br><span class="hljs-function">std::vector&lt;NaluIndex&gt; <span class="hljs-title">FindNaluIndices</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* buffer,</span></span><br><span class="hljs-params"><span class="hljs-function">                                       <span class="hljs-type">size_t</span> buffer_size)</span></span>;<br><br><span class="hljs-comment">// Get the NAL type from the header byte immediately following start sequence.</span><br><span class="hljs-function">NaluType <span class="hljs-title">ParseNaluType</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> data)</span></span>;<br><br><span class="hljs-comment">// Methods for parsing and writing RBSP. See section 7.4.2 of the H265 spec.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// The following sequences are illegal, and need to be escaped when encoding:</span><br><span class="hljs-comment">// 00 00 00 -&gt; 00 00 03 00</span><br><span class="hljs-comment">// 00 00 01 -&gt; 00 00 03 01</span><br><span class="hljs-comment">// 00 00 02 -&gt; 00 00 03 02</span><br><span class="hljs-comment">// And things in the source that look like the emulation byte pattern (00 00 03)</span><br><span class="hljs-comment">// need to have an extra emulation byte added, so it&#x27;s removed when decoding:</span><br><span class="hljs-comment">// 00 00 03 -&gt; 00 00 03 03</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Decoding is simply a matter of finding any 00 00 03 sequence and removing</span><br><span class="hljs-comment">// the 03 emulation byte.</span><br><br><span class="hljs-comment">// Parse the given data and remove any emulation byte escaping.</span><br><span class="hljs-function">std::vector&lt;<span class="hljs-type">uint8_t</span>&gt; <span class="hljs-title">ParseRbsp</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* data, <span class="hljs-type">size_t</span> length)</span></span>;<br><br><span class="hljs-comment">// Write the given data to the destination buffer, inserting and emulation</span><br><span class="hljs-comment">// bytes in order to escape any data the could be interpreted as a start</span><br><span class="hljs-comment">// sequence.</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">WriteRbsp</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* bytes, <span class="hljs-type">size_t</span> length, rtc::Buffer* destination)</span></span>;<br><br><span class="hljs-function"><span class="hljs-type">uint32_t</span> <span class="hljs-title">Log2</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> value)</span></span>;<br>&#125;  <span class="hljs-comment">// namespace H265</span><br>&#125;  <span class="hljs-comment">// namespace webrtc</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>  <span class="hljs-comment">// COMMON_VIDEO_H265_H265_COMMON_H_</span></span><br><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>common_video/h265/h265_pps_parser.cc >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_pps_parser.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_common.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_sps_parser.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/bit_buffer.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/logging.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RETURN_EMPTY_ON_FAIL(x) \</span><br><span class="hljs-meta">  <span class="hljs-keyword">if</span> (!(x)) &#123;                   \</span><br><span class="hljs-meta">    return absl::nullopt;        \</span><br><span class="hljs-meta">  &#125;</span><br><br><span class="hljs-keyword">namespace</span> &#123;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> kMaxPicInitQpDeltaValue = <span class="hljs-number">25</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> kMinPicInitQpDeltaValue = <span class="hljs-number">-26</span>;<br>&#125;  <span class="hljs-comment">// namespace</span><br><br><span class="hljs-keyword">namespace</span> webrtc &#123;<br><br><span class="hljs-comment">// General note: this is based off the 06/2019 version of the H.265 standard.</span><br><span class="hljs-comment">// You can find it on this page:</span><br><span class="hljs-comment">// http://www.itu.int/rec/T-REC-H.265</span><br><br><span class="hljs-function">absl::optional&lt;H265PpsParser::PpsState&gt; <span class="hljs-title">H265PpsParser::ParsePps</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* data,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">size_t</span> length)</span> </span>&#123;<br>  <span class="hljs-comment">// First, parse out rbsp, which is basically the source buffer minus emulation</span><br>  <span class="hljs-comment">// bytes (the last byte of a 0x00 0x00 0x03 sequence). RBSP is defined in</span><br>  <span class="hljs-comment">// section 7.3.1.1 of the H.265 standard.</span><br>  std::vector&lt;<span class="hljs-type">uint8_t</span>&gt; unpacked_buffer = H265::<span class="hljs-built_in">ParseRbsp</span>(data, length);<br>  <span class="hljs-function">rtc::BitBuffer <span class="hljs-title">bit_buffer</span><span class="hljs-params">(unpacked_buffer.data(), unpacked_buffer.size())</span></span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">ParseInternal</span>(&amp;bit_buffer);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">H265PpsParser::ParsePpsIds</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* data,</span></span><br><span class="hljs-params"><span class="hljs-function">                                <span class="hljs-type">size_t</span> length,</span></span><br><span class="hljs-params"><span class="hljs-function">                                <span class="hljs-type">uint32_t</span>* pps_id,</span></span><br><span class="hljs-params"><span class="hljs-function">                                <span class="hljs-type">uint32_t</span>* sps_id)</span> </span>&#123;<br>  <span class="hljs-built_in">RTC_DCHECK</span>(pps_id);<br>  <span class="hljs-built_in">RTC_DCHECK</span>(sps_id);<br>  <span class="hljs-comment">// First, parse out rbsp, which is basically the source buffer minus emulation</span><br>  <span class="hljs-comment">// bytes (the last byte of a 0x00 0x00 0x03 sequence). RBSP is defined in</span><br>  <span class="hljs-comment">// section 7.3.1.1 of the H.265 standard.</span><br>  std::vector&lt;<span class="hljs-type">uint8_t</span>&gt; unpacked_buffer = H265::<span class="hljs-built_in">ParseRbsp</span>(data, length);<br>  <span class="hljs-function">rtc::BitBuffer <span class="hljs-title">bit_buffer</span><span class="hljs-params">(unpacked_buffer.data(), unpacked_buffer.size())</span></span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">ParsePpsIdsInternal</span>(&amp;bit_buffer, pps_id, sps_id);<br>&#125;<br><br><span class="hljs-function">absl::optional&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">H265PpsParser::ParsePpsIdFromSliceSegmentLayerRbsp</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* data,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">size_t</span> length,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">uint8_t</span> nalu_type)</span> </span>&#123;<br>  <span class="hljs-function">rtc::BitBuffer <span class="hljs-title">slice_reader</span><span class="hljs-params">(data, length)</span></span>;<br><br>  <span class="hljs-comment">// first_slice_segment_in_pic_flag: u(1)</span><br>  <span class="hljs-type">uint32_t</span> first_slice_segment_in_pic_flag = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(<br>      slice_reader.<span class="hljs-built_in">ReadBits</span>(&amp;first_slice_segment_in_pic_flag, <span class="hljs-number">1</span>));<br><br>  <span class="hljs-keyword">if</span> (nalu_type &gt;= H265::NaluType::kBlaWLp &amp;&amp;<br>      nalu_type &lt;= H265::NaluType::kRsvIrapVcl23) &#123;<br>    <span class="hljs-comment">// no_output_of_prior_pics_flag: u(1)</span><br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(slice_reader.<span class="hljs-built_in">ConsumeBits</span>(<span class="hljs-number">1</span>));<br>  &#125;<br><br>  <span class="hljs-comment">// slice_pic_parameter_set_id: ue(v)</span><br>  <span class="hljs-type">uint32_t</span> slice_pic_parameter_set_id = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> (!slice_reader.<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;slice_pic_parameter_set_id))<br>    <span class="hljs-keyword">return</span> absl::<span class="hljs-literal">nullopt</span>;<br><br>  <span class="hljs-keyword">return</span> slice_pic_parameter_set_id;<br>&#125;<br><br><span class="hljs-function">absl::optional&lt;H265PpsParser::PpsState&gt; <span class="hljs-title">H265PpsParser::ParseInternal</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    rtc::BitBuffer* bit_buffer)</span> </span>&#123;<br>  PpsState pps;<br><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(<span class="hljs-built_in">ParsePpsIdsInternal</span>(bit_buffer, &amp;pps.id, &amp;pps.sps_id));<br><br>  <span class="hljs-type">uint32_t</span> bits_tmp;<br>  <span class="hljs-type">uint32_t</span> golomb_ignored;<br>  <span class="hljs-type">int32_t</span> signed_golomb_ignored;<br>  <span class="hljs-comment">// dependent_slice_segments_enabled_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;pps.dependent_slice_segments_enabled_flag, <span class="hljs-number">1</span>));<br>  <span class="hljs-comment">// output_flag_present_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;pps.output_flag_present_flag, <span class="hljs-number">1</span>));<br>  <span class="hljs-comment">// num_extra_slice_header_bits: u(3)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;pps.num_extra_slice_header_bits, <span class="hljs-number">3</span>));<br>  <span class="hljs-comment">// sign_data_hiding_enabled_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, <span class="hljs-number">1</span>));<br>  <span class="hljs-comment">// cabac_init_present_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;pps.cabac_init_present_flag, <span class="hljs-number">1</span>));<br>  <span class="hljs-comment">// num_ref_idx_l0_default_active_minus1: ue(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;pps.num_ref_idx_l0_default_active_minus1));<br>  <span class="hljs-comment">// num_ref_idx_l1_default_active_minus1: ue(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;pps.num_ref_idx_l1_default_active_minus1));<br>  <span class="hljs-comment">// init_qp_minus26: se(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadSignedExponentialGolomb</span>(&amp;pps.pic_init_qp_minus26));<br>  <span class="hljs-comment">// Sanity-check parsed value</span><br>  <span class="hljs-keyword">if</span> (pps.pic_init_qp_minus26 &gt; kMaxPicInitQpDeltaValue ||<br>      pps.pic_init_qp_minus26 &lt; kMinPicInitQpDeltaValue) &#123;<br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(<span class="hljs-literal">false</span>);<br>  &#125;<br>  <span class="hljs-comment">// constrained_intra_pred_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, <span class="hljs-number">1</span>));<br>  <span class="hljs-comment">// transform_skip_enabled_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, <span class="hljs-number">1</span>));<br>  <span class="hljs-comment">// cu_qp_delta_enabled_flag: u(1)</span><br>  <span class="hljs-type">uint32_t</span> cu_qp_delta_enabled_flag = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;cu_qp_delta_enabled_flag, <span class="hljs-number">1</span>));<br>  <span class="hljs-keyword">if</span> (cu_qp_delta_enabled_flag) &#123;<br>    <span class="hljs-comment">// diff_cu_qp_delta_depth: ue(v)</span><br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;golomb_ignored));<br>  &#125;<br>  <span class="hljs-comment">// pps_cb_qp_offset: se(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadSignedExponentialGolomb</span>(&amp;signed_golomb_ignored));<br>  <span class="hljs-comment">// pps_cr_qp_offset: se(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadSignedExponentialGolomb</span>(&amp;signed_golomb_ignored));<br>  <span class="hljs-comment">// pps_slice_chroma_qp_offsets_present_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, <span class="hljs-number">1</span>));<br>  <span class="hljs-comment">// weighted_pred_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;pps.weighted_pred_flag, <span class="hljs-number">1</span>));<br>  <span class="hljs-comment">// weighted_bipred_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;pps.weighted_bipred_flag, <span class="hljs-number">1</span>));<br>  <span class="hljs-comment">// transquant_bypass_enabled_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, <span class="hljs-number">1</span>));<br>  <span class="hljs-comment">// tiles_enabled_flag: u(1)</span><br>  <span class="hljs-type">uint32_t</span> tiles_enabled_flag = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;tiles_enabled_flag, <span class="hljs-number">1</span>));<br>  <span class="hljs-comment">// entropy_coding_sync_enabled_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, <span class="hljs-number">1</span>));<br>  <span class="hljs-keyword">if</span> (tiles_enabled_flag) &#123;<br>    <span class="hljs-comment">// num_tile_columns_minus1: ue(v)</span><br>    <span class="hljs-type">uint32_t</span> num_tile_columns_minus1 = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;num_tile_columns_minus1));<br>    <span class="hljs-comment">// num_tile_rows_minus1: ue(v)</span><br>    <span class="hljs-type">uint32_t</span> num_tile_rows_minus1 = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;num_tile_rows_minus1));<br>    <span class="hljs-comment">// uniform_spacing_flag: u(1)</span><br>    <span class="hljs-type">uint32_t</span> uniform_spacing_flag = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;uniform_spacing_flag, <span class="hljs-number">1</span>));<br>    <span class="hljs-keyword">if</span> (!uniform_spacing_flag) &#123;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; num_tile_columns_minus1; i++) &#123;<br>        <span class="hljs-comment">// column_width_minus1: ue(v)</span><br>        <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;golomb_ignored));<br>      &#125;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; num_tile_rows_minus1; i++) &#123;<br>        <span class="hljs-comment">// row_height_minus1: ue(v)</span><br>        <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;golomb_ignored));<br>      &#125;<br>      <span class="hljs-comment">// loop_filter_across_tiles_enabled_flag: u(1)</span><br>      <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, <span class="hljs-number">1</span>));<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// pps_loop_filter_across_slices_enabled_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, <span class="hljs-number">1</span>));<br>  <span class="hljs-comment">// deblocking_filter_control_present_flag: u(1)</span><br>  <span class="hljs-type">uint32_t</span> deblocking_filter_control_present_flag = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;deblocking_filter_control_present_flag, <span class="hljs-number">1</span>));<br>  <span class="hljs-keyword">if</span> (deblocking_filter_control_present_flag) &#123;<br>    <span class="hljs-comment">// deblocking_filter_override_enabled_flag: u(1)</span><br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, <span class="hljs-number">1</span>));<br>    <span class="hljs-comment">// pps_deblocking_filter_disabled_flag: u(1)</span><br>    <span class="hljs-type">uint32_t</span> pps_deblocking_filter_disabled_flag = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;pps_deblocking_filter_disabled_flag, <span class="hljs-number">1</span>));<br>    <span class="hljs-keyword">if</span> (!pps_deblocking_filter_disabled_flag) &#123;<br>      <span class="hljs-comment">// pps_beta_offset_div2: se(v)</span><br>      <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadSignedExponentialGolomb</span>(&amp;signed_golomb_ignored));<br>      <span class="hljs-comment">// pps_tc_offset_div2: se(v)</span><br>      <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadSignedExponentialGolomb</span>(&amp;signed_golomb_ignored));<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// pps_scaling_list_data_present_flag: u(1)</span><br>  <span class="hljs-type">uint32_t</span> pps_scaling_list_data_present_flag = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;pps_scaling_list_data_present_flag, <span class="hljs-number">1</span>));<br>  <span class="hljs-keyword">if</span> (pps_scaling_list_data_present_flag) &#123;<br>    <span class="hljs-comment">// scaling_list_data()</span><br>    <span class="hljs-keyword">if</span> (!H265SpsParser::<span class="hljs-built_in">ParseScalingListData</span>(bit_buffer)) &#123;<br>      <span class="hljs-keyword">return</span> absl::<span class="hljs-literal">nullopt</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// lists_modification_present_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;pps.lists_modification_present_flag, <span class="hljs-number">1</span>));<br>  <span class="hljs-comment">// log2_parallel_merge_level_minus2: ue(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;golomb_ignored));<br>  <span class="hljs-comment">// slice_segment_header_extension_present_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(bit_buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;bits_tmp, <span class="hljs-number">1</span>));<br><br>  <span class="hljs-keyword">return</span> pps;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">H265PpsParser::ParsePpsIdsInternal</span><span class="hljs-params">(rtc::BitBuffer* bit_buffer,</span></span><br><span class="hljs-params"><span class="hljs-function">                                        <span class="hljs-type">uint32_t</span>* pps_id,</span></span><br><span class="hljs-params"><span class="hljs-function">                                        <span class="hljs-type">uint32_t</span>* sps_id)</span> </span>&#123;<br>  <span class="hljs-comment">// pic_parameter_set_id: ue(v)</span><br>  <span class="hljs-keyword">if</span> (!bit_buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(pps_id))<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  <span class="hljs-comment">// seq_parameter_set_id: ue(v)</span><br>  <span class="hljs-keyword">if</span> (!bit_buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(sps_id))<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br>&#125;  <span class="hljs-comment">// namespace webrtc</span><br><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>common_video/h265/h265_pps_parser.h >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> COMMON_VIDEO_H265_PPS_PARSER_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMON_VIDEO_H265_PPS_PARSER_H_</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;absl/types/optional.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> rtc &#123;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BitBuffer</span>;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> webrtc &#123;<br><br><span class="hljs-comment">// A class for parsing out picture parameter set (PPS) data from a H265 NALU.</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">H265PpsParser</span> &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-comment">// The parsed state of the PPS. Only some select values are stored.</span><br>  <span class="hljs-comment">// Add more as they are actually needed.</span><br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">PpsState</span> &#123;<br>    <span class="hljs-built_in">PpsState</span>() = <span class="hljs-keyword">default</span>;<br><br>    <span class="hljs-type">uint32_t</span> dependent_slice_segments_enabled_flag = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> cabac_init_present_flag = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> output_flag_present_flag = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> num_extra_slice_header_bits = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> num_ref_idx_l0_default_active_minus1 = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> num_ref_idx_l1_default_active_minus1 = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int32_t</span> pic_init_qp_minus26 = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> weighted_pred_flag = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> weighted_bipred_flag = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> lists_modification_present_flag = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> id = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> sps_id = <span class="hljs-number">0</span>;<br>  &#125;;<br><br>  <span class="hljs-comment">// Unpack RBSP and parse PPS state from the supplied buffer.</span><br>  <span class="hljs-function"><span class="hljs-type">static</span> absl::optional&lt;PpsState&gt; <span class="hljs-title">ParsePps</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* data, <span class="hljs-type">size_t</span> length)</span></span>;<br><br>  <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">ParsePpsIds</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* data,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-type">size_t</span> length,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-type">uint32_t</span>* pps_id,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-type">uint32_t</span>* sps_id)</span></span>;<br><br>  <span class="hljs-function"><span class="hljs-type">static</span> absl::optional&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">ParsePpsIdFromSliceSegmentLayerRbsp</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">      <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* data,</span></span><br><span class="hljs-params"><span class="hljs-function">      <span class="hljs-type">size_t</span> length,</span></span><br><span class="hljs-params"><span class="hljs-function">      <span class="hljs-type">uint8_t</span> nalu_type)</span></span>;<br><br> <span class="hljs-keyword">protected</span>:<br>  <span class="hljs-comment">// Parse the PPS state, for a bit buffer where RBSP decoding has already been</span><br>  <span class="hljs-comment">// performed.</span><br>  <span class="hljs-function"><span class="hljs-type">static</span> absl::optional&lt;PpsState&gt; <span class="hljs-title">ParseInternal</span><span class="hljs-params">(rtc::BitBuffer* bit_buffer)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">ParsePpsIdsInternal</span><span class="hljs-params">(rtc::BitBuffer* bit_buffer,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-type">uint32_t</span>* pps_id,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-type">uint32_t</span>* sps_id)</span></span>;<br>&#125;;<br><br>&#125;  <span class="hljs-comment">// namespace webrtc</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>  <span class="hljs-comment">// COMMON_VIDEO_H265_PPS_PARSER_H_</span></span><br><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>common_video/h265/h265_sps_parser.cc >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_common.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_sps_parser.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/bit_buffer.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/logging.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> &#123;<br><span class="hljs-keyword">typedef</span> absl::optional&lt;webrtc::H265SpsParser::SpsState&gt; OptionalSps;<br><span class="hljs-keyword">typedef</span> absl::optional&lt;webrtc::H265SpsParser::ShortTermRefPicSet&gt; OptionalShortTermRefPicSet;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RETURN_EMPTY_ON_FAIL(x) \</span><br><span class="hljs-meta">  <span class="hljs-keyword">if</span> (!(x)) &#123;                   \</span><br><span class="hljs-meta">    return OptionalSps();       \</span><br><span class="hljs-meta">  &#125;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RETURN_FALSE_ON_FAIL(x) \</span><br><span class="hljs-meta">  <span class="hljs-keyword">if</span> (!(x)) &#123;                   \</span><br><span class="hljs-meta">    return false;               \</span><br><span class="hljs-meta">  &#125;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RETURN_EMPTY2_ON_FAIL(x)                \</span><br><span class="hljs-meta">  <span class="hljs-keyword">if</span> (!(x)) &#123;                                   \</span><br><span class="hljs-meta">    return OptionalShortTermRefPicSet();        \</span><br><span class="hljs-meta">  &#125;</span><br>&#125;  <span class="hljs-comment">// namespace</span><br><br><span class="hljs-keyword">namespace</span> webrtc &#123;<br><br>H265SpsParser::SpsState::<span class="hljs-built_in">SpsState</span>() = <span class="hljs-keyword">default</span>;<br><br>H265SpsParser::ShortTermRefPicSet::<span class="hljs-built_in">ShortTermRefPicSet</span>() = <span class="hljs-keyword">default</span>;<br><br><span class="hljs-comment">// General note: this is based off the 06/2019 version of the H.265 standard.</span><br><span class="hljs-comment">// You can find it on this page:</span><br><span class="hljs-comment">// http://www.itu.int/rec/T-REC-H.265</span><br><br><span class="hljs-comment">// Unpack RBSP and parse SPS state from the supplied buffer.</span><br><span class="hljs-function">absl::optional&lt;H265SpsParser::SpsState&gt; <span class="hljs-title">H265SpsParser::ParseSps</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* data,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">size_t</span> length)</span> </span>&#123;<br>  std::vector&lt;<span class="hljs-type">uint8_t</span>&gt; unpacked_buffer = H265::<span class="hljs-built_in">ParseRbsp</span>(data, length);<br>  <span class="hljs-function">rtc::BitBuffer <span class="hljs-title">bit_buffer</span><span class="hljs-params">(unpacked_buffer.data(), unpacked_buffer.size())</span></span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">ParseSpsInternal</span>(&amp;bit_buffer);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">H265SpsParser::ParseScalingListData</span><span class="hljs-params">(rtc::BitBuffer* buffer)</span> </span>&#123;<br>  <span class="hljs-type">uint32_t</span> scaling_list_pred_mode_flag[<span class="hljs-number">4</span>][<span class="hljs-number">6</span>];<br>  <span class="hljs-type">uint32_t</span> scaling_list_pred_matrix_id_delta[<span class="hljs-number">4</span>][<span class="hljs-number">6</span>];<br>  <span class="hljs-type">int32_t</span> scaling_list_dc_coef_minus8[<span class="hljs-number">4</span>][<span class="hljs-number">6</span>];<br>  <span class="hljs-type">int32_t</span> scaling_list[<span class="hljs-number">4</span>][<span class="hljs-number">6</span>][<span class="hljs-number">64</span>];<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> size_id = <span class="hljs-number">0</span>; size_id &lt; <span class="hljs-number">4</span>; size_id++) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> matrix_id = <span class="hljs-number">0</span>; matrix_id &lt; <span class="hljs-number">6</span>; matrix_id += (size_id == <span class="hljs-number">3</span>) ? <span class="hljs-number">3</span> : <span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-comment">// scaling_list_pred_mode_flag: u(1)</span><br>      <span class="hljs-built_in">RETURN_FALSE_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;scaling_list_pred_mode_flag[size_id][matrix_id], <span class="hljs-number">1</span>));<br>      <span class="hljs-keyword">if</span> (!scaling_list_pred_mode_flag[size_id][matrix_id]) &#123;<br>        <span class="hljs-comment">// scaling_list_pred_matrix_id_delta: ue(v)</span><br>        <span class="hljs-built_in">RETURN_FALSE_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;scaling_list_pred_matrix_id_delta[size_id][matrix_id]));<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">int32_t</span> next_coef = <span class="hljs-number">8</span>;<br>        <span class="hljs-type">uint32_t</span> coef_num = std::<span class="hljs-built_in">min</span>(<span class="hljs-number">64</span>, <span class="hljs-number">1</span> &lt;&lt; (<span class="hljs-number">4</span> + (size_id &lt;&lt; <span class="hljs-number">1</span>)));<br>        <span class="hljs-keyword">if</span> (size_id &gt; <span class="hljs-number">1</span>) &#123;<br>          <span class="hljs-comment">// scaling_list_dc_coef_minus8: se(v)</span><br>          <span class="hljs-built_in">RETURN_FALSE_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadSignedExponentialGolomb</span>(&amp;scaling_list_dc_coef_minus8[size_id - <span class="hljs-number">2</span>][matrix_id]));<br>          next_coef = scaling_list_dc_coef_minus8[size_id - <span class="hljs-number">2</span>][matrix_id];<br>        &#125;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; coef_num; i++) &#123;<br>          <span class="hljs-comment">// scaling_list_delta_coef: se(v)</span><br>          <span class="hljs-type">int32_t</span> scaling_list_delta_coef = <span class="hljs-number">0</span>;<br>          <span class="hljs-built_in">RETURN_FALSE_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadSignedExponentialGolomb</span>(&amp;scaling_list_delta_coef));<br>          next_coef = (next_coef + scaling_list_delta_coef + <span class="hljs-number">256</span>) % <span class="hljs-number">256</span>;<br>          scaling_list[size_id][matrix_id][i] = next_coef;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-function">absl::optional&lt;H265SpsParser::ShortTermRefPicSet&gt; <span class="hljs-title">H265SpsParser::ParseShortTermRefPicSet</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-type">uint32_t</span> st_rps_idx, <span class="hljs-type">uint32_t</span> num_short_term_ref_pic_sets,</span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-type">const</span> std::vector&lt;H265SpsParser::ShortTermRefPicSet&gt;&amp; short_term_ref_pic_set,</span></span><br><span class="hljs-params"><span class="hljs-function">        H265SpsParser::SpsState&amp; sps, rtc::BitBuffer* buffer)</span> </span>&#123;<br>  H265SpsParser::ShortTermRefPicSet ref_pic_set;<br><br>  <span class="hljs-type">uint32_t</span> inter_ref_pic_set_prediction_flag = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> (st_rps_idx != <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">// inter_ref_pic_set_prediction_flag: u(1)</span><br>    <span class="hljs-built_in">RETURN_EMPTY2_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;inter_ref_pic_set_prediction_flag, <span class="hljs-number">1</span>));<br>  &#125;<br>  <span class="hljs-keyword">if</span> (inter_ref_pic_set_prediction_flag) &#123;<br>    <span class="hljs-type">uint32_t</span> delta_idx_minus1 = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (st_rps_idx == num_short_term_ref_pic_sets) &#123;<br>      <span class="hljs-comment">// delta_idx_minus1: ue(v)</span><br>      <span class="hljs-built_in">RETURN_EMPTY2_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;delta_idx_minus1));<br>    &#125;<br>    <span class="hljs-comment">// delta_rps_sign: u(1)</span><br>    <span class="hljs-type">uint32_t</span> delta_rps_sign = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">RETURN_EMPTY2_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;delta_rps_sign, <span class="hljs-number">1</span>));<br>    <span class="hljs-comment">// abs_delta_rps_minus1: ue(v)</span><br>    <span class="hljs-type">uint32_t</span> abs_delta_rps_minus1 = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">RETURN_EMPTY2_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;abs_delta_rps_minus1));<br>    <span class="hljs-type">uint32_t</span> ref_rps_idx = st_rps_idx - (delta_idx_minus1 + <span class="hljs-number">1</span>);<br>    <span class="hljs-type">uint32_t</span> num_delta_pocs = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (short_term_ref_pic_set[ref_rps_idx].inter_ref_pic_set_prediction_flag) &#123;<br>      <span class="hljs-keyword">auto</span>&amp; used_by_curr_pic_flag = short_term_ref_pic_set[ref_rps_idx].used_by_curr_pic_flag;<br>      <span class="hljs-keyword">auto</span>&amp; use_delta_flag = short_term_ref_pic_set[ref_rps_idx].use_delta_flag;<br>      <span class="hljs-keyword">if</span> (used_by_curr_pic_flag.<span class="hljs-built_in">size</span>() != use_delta_flag.<span class="hljs-built_in">size</span>()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">OptionalShortTermRefPicSet</span>();<br>      &#125;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; used_by_curr_pic_flag.<span class="hljs-built_in">size</span>(); i++) &#123;<br>        <span class="hljs-keyword">if</span> (used_by_curr_pic_flag[i] || use_delta_flag[i]) &#123;<br>          num_delta_pocs++;<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      num_delta_pocs = short_term_ref_pic_set[ref_rps_idx].num_negative_pics + short_term_ref_pic_set[ref_rps_idx].num_positive_pics;<br>    &#125;<br>    ref_pic_set.used_by_curr_pic_flag.<span class="hljs-built_in">resize</span>(num_delta_pocs + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>    ref_pic_set.use_delta_flag.<span class="hljs-built_in">resize</span>(num_delta_pocs + <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> j = <span class="hljs-number">0</span>; j &lt;= num_delta_pocs; j++) &#123;<br>      <span class="hljs-comment">// used_by_curr_pic_flag: u(1)</span><br>      <span class="hljs-built_in">RETURN_EMPTY2_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;ref_pic_set.used_by_curr_pic_flag[j], <span class="hljs-number">1</span>));<br>      <span class="hljs-keyword">if</span> (!ref_pic_set.used_by_curr_pic_flag[j]) &#123;<br>        <span class="hljs-comment">// use_delta_flag: u(1)</span><br>        <span class="hljs-built_in">RETURN_EMPTY2_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;ref_pic_set.use_delta_flag[j], <span class="hljs-number">1</span>));<br>      &#125;<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// num_negative_pics: ue(v)</span><br>    <span class="hljs-built_in">RETURN_EMPTY2_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;ref_pic_set.num_negative_pics));<br>    <span class="hljs-comment">// num_positive_pics: ue(v)</span><br>    <span class="hljs-built_in">RETURN_EMPTY2_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;ref_pic_set.num_positive_pics));<br><br>    ref_pic_set.delta_poc_s0_minus1.<span class="hljs-built_in">resize</span>(ref_pic_set.num_negative_pics, <span class="hljs-number">0</span>);<br>    ref_pic_set.used_by_curr_pic_s0_flag.<span class="hljs-built_in">resize</span>(ref_pic_set.num_negative_pics, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; ref_pic_set.num_negative_pics; i++) &#123;<br>      <span class="hljs-comment">// delta_poc_s0_minus1: ue(v)</span><br>      <span class="hljs-built_in">RETURN_EMPTY2_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;ref_pic_set.delta_poc_s0_minus1[i]));<br>      <span class="hljs-comment">// used_by_curr_pic_s0_flag: u(1)</span><br>      <span class="hljs-built_in">RETURN_EMPTY2_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;ref_pic_set.used_by_curr_pic_s0_flag[i], <span class="hljs-number">1</span>));<br>    &#125;<br>    ref_pic_set.delta_poc_s1_minus1.<span class="hljs-built_in">resize</span>(ref_pic_set.num_positive_pics, <span class="hljs-number">0</span>);<br>    ref_pic_set.used_by_curr_pic_s1_flag.<span class="hljs-built_in">resize</span>(ref_pic_set.num_positive_pics, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; ref_pic_set.num_positive_pics; i++) &#123;<br>      <span class="hljs-comment">// delta_poc_s1_minus1: ue(v)</span><br>      <span class="hljs-built_in">RETURN_EMPTY2_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;ref_pic_set.delta_poc_s1_minus1[i]));<br>      <span class="hljs-comment">// used_by_curr_pic_s1_flag: u(1)</span><br>      <span class="hljs-built_in">RETURN_EMPTY2_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;ref_pic_set.used_by_curr_pic_s1_flag[i], <span class="hljs-number">1</span>));<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">OptionalShortTermRefPicSet</span>(ref_pic_set);<br>&#125;<br><br><span class="hljs-function">absl::optional&lt;H265SpsParser::SpsState&gt; <span class="hljs-title">H265SpsParser::ParseSpsInternal</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    rtc::BitBuffer* buffer)</span> </span>&#123;<br>  <span class="hljs-comment">// Now, we need to use a bit buffer to parse through the actual HEVC SPS</span><br>  <span class="hljs-comment">// format. See Section 7.3.2.2.1 (&quot;General sequence parameter set data</span><br>  <span class="hljs-comment">// syntax&quot;) of the H.265 standard for a complete description.</span><br>  <span class="hljs-comment">// Since we only care about resolution, we ignore the majority of fields, but</span><br>  <span class="hljs-comment">// we still have to actively parse through a lot of the data, since many of</span><br>  <span class="hljs-comment">// the fields have variable size.</span><br>  <span class="hljs-comment">// We&#x27;re particularly interested in:</span><br>  <span class="hljs-comment">// chroma_format_idc -&gt; affects crop units</span><br>  <span class="hljs-comment">// pic_&#123;width,height&#125;_* -&gt; resolution of the frame in macroblocks (16x16).</span><br>  <span class="hljs-comment">// frame_crop_*_offset -&gt; crop information</span><br><br>  SpsState sps;<br><br>  <span class="hljs-comment">// The golomb values we have to read, not just consume.</span><br>  <span class="hljs-type">uint32_t</span> golomb_ignored;<br><br>  <span class="hljs-comment">// sps_video_parameter_set_id: u(4)</span><br>  <span class="hljs-type">uint32_t</span> sps_video_parameter_set_id = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;sps_video_parameter_set_id, <span class="hljs-number">4</span>));<br>  <span class="hljs-comment">// sps_max_sub_layers_minus1: u(3)</span><br>  <span class="hljs-type">uint32_t</span> sps_max_sub_layers_minus1 = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;sps_max_sub_layers_minus1, <span class="hljs-number">3</span>));<br>  sps.sps_max_sub_layers_minus1 = sps_max_sub_layers_minus1;<br>  sps.sps_max_dec_pic_buffering_minus1.<span class="hljs-built_in">resize</span>(sps_max_sub_layers_minus1 + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-comment">// sps_temporal_id_nesting_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ConsumeBits</span>(<span class="hljs-number">1</span>));<br>  <span class="hljs-comment">// profile_tier_level(1, sps_max_sub_layers_minus1). We are acutally not</span><br>  <span class="hljs-comment">// using them, so read/skip over it.</span><br>  <span class="hljs-comment">// general_profile_space+general_tier_flag+general_prfile_idc: u(8)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ConsumeBytes</span>(<span class="hljs-number">1</span>));<br>  <span class="hljs-comment">// general_profile_compatabilitiy_flag[32]</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ConsumeBytes</span>(<span class="hljs-number">4</span>));<br>  <span class="hljs-comment">// general_progressive_source_flag + interlaced_source_flag+</span><br>  <span class="hljs-comment">// non-packed_constraint flag + frame_only_constraint_flag: u(4)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ConsumeBits</span>(<span class="hljs-number">4</span>));<br>  <span class="hljs-comment">// general_profile_idc decided flags or reserved.  u(43)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ConsumeBits</span>(<span class="hljs-number">43</span>));<br>  <span class="hljs-comment">// general_inbld_flag or reserved 0: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ConsumeBits</span>(<span class="hljs-number">1</span>));<br>  <span class="hljs-comment">// general_level_idc: u(8)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ConsumeBytes</span>(<span class="hljs-number">1</span>));<br>  <span class="hljs-comment">// if max_sub_layers_minus1 &gt;=1, read the sublayer profile information</span><br>  std::vector&lt;<span class="hljs-type">uint32_t</span>&gt; sub_layer_profile_present_flags;<br>  std::vector&lt;<span class="hljs-type">uint32_t</span>&gt; sub_layer_level_present_flags;<br>  <span class="hljs-type">uint32_t</span> sub_layer_profile_present = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">uint32_t</span> sub_layer_level_present = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; sps_max_sub_layers_minus1; i++) &#123;<br>    <span class="hljs-comment">// sublayer_profile_present_flag and sublayer_level_presnet_flag:  u(2)</span><br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;sub_layer_profile_present, <span class="hljs-number">1</span>));<br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;sub_layer_level_present, <span class="hljs-number">1</span>));<br>    sub_layer_profile_present_flags.<span class="hljs-built_in">push_back</span>(sub_layer_profile_present);<br>    sub_layer_level_present_flags.<span class="hljs-built_in">push_back</span>(sub_layer_level_present);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (sps_max_sub_layers_minus1 &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> j = sps_max_sub_layers_minus1; j &lt; <span class="hljs-number">8</span>; j++) &#123;<br>      <span class="hljs-comment">// reserved 2 bits: u(2)</span><br>      <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ConsumeBits</span>(<span class="hljs-number">2</span>));<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> k = <span class="hljs-number">0</span>; k &lt; sps_max_sub_layers_minus1; k++) &#123;<br>    <span class="hljs-keyword">if</span> (sub_layer_profile_present_flags[k]) &#123;  <span class="hljs-comment">//</span><br>      <span class="hljs-comment">// sub_layer profile_space/tier_flag/profile_idc. ignored. u(8)</span><br>      <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ConsumeBytes</span>(<span class="hljs-number">1</span>));<br>      <span class="hljs-comment">// profile_compatability_flag:  u(32)</span><br>      <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ConsumeBytes</span>(<span class="hljs-number">4</span>));<br>      <span class="hljs-comment">// sub_layer progressive_source_flag/interlaced_source_flag/</span><br>      <span class="hljs-comment">// non_packed_constraint_flag/frame_only_constraint_flag: u(4)</span><br>      <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ConsumeBits</span>(<span class="hljs-number">4</span>));<br>      <span class="hljs-comment">// following 43-bits are profile_idc specific. We simply read/skip it.</span><br>      <span class="hljs-comment">// u(43)</span><br>      <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ConsumeBits</span>(<span class="hljs-number">43</span>));<br>      <span class="hljs-comment">// 1-bit profile_idc specific inbld flag.  We simply read/skip it. u(1)</span><br>      <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ConsumeBits</span>(<span class="hljs-number">1</span>));<br>    &#125;<br>    <span class="hljs-keyword">if</span> (sub_layer_level_present_flags[k]) &#123;<br>      <span class="hljs-comment">// sub_layer_level_idc: u(8)</span><br>      <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ConsumeBytes</span>(<span class="hljs-number">1</span>));<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// sps_seq_parameter_set_id: ue(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;sps.id));<br>  <span class="hljs-comment">// chrome_format_idc: ue(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;sps.chroma_format_idc));<br>  <span class="hljs-keyword">if</span> (sps.chroma_format_idc == <span class="hljs-number">3</span>) &#123;<br>    <span class="hljs-comment">// seperate_colour_plane_flag: u(1)</span><br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;sps.separate_colour_plane_flag, <span class="hljs-number">1</span>));<br>  &#125;<br>  <span class="hljs-type">uint32_t</span> pic_width_in_luma_samples = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">uint32_t</span> pic_height_in_luma_samples = <span class="hljs-number">0</span>;<br>  <span class="hljs-comment">// pic_width_in_luma_samples: ue(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(<br>      buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;pic_width_in_luma_samples));<br>  <span class="hljs-comment">// pic_height_in_luma_samples: ue(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(<br>      buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;pic_height_in_luma_samples));<br>  <span class="hljs-comment">// conformance_window_flag: u(1)</span><br>  <span class="hljs-type">uint32_t</span> conformance_window_flag = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;conformance_window_flag, <span class="hljs-number">1</span>));<br><br>  <span class="hljs-type">uint32_t</span> conf_win_left_offset = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">uint32_t</span> conf_win_right_offset = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">uint32_t</span> conf_win_top_offset = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">uint32_t</span> conf_win_bottom_offset = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> (conformance_window_flag) &#123;<br>    <span class="hljs-comment">// conf_win_left_offset: ue(v)</span><br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;conf_win_left_offset));<br>    <span class="hljs-comment">// conf_win_right_offset: ue(v)</span><br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;conf_win_right_offset));<br>    <span class="hljs-comment">// conf_win_top_offset: ue(v)</span><br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;conf_win_top_offset));<br>    <span class="hljs-comment">// conf_win_bottom_offset: ue(v)</span><br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(<br>        buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;conf_win_bottom_offset));<br>  &#125;<br><br>  <span class="hljs-comment">// bit_depth_luma_minus8: ue(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;golomb_ignored));<br>  <span class="hljs-comment">// bit_depth_chroma_minus8: ue(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;golomb_ignored));<br>  <span class="hljs-comment">// log2_max_pic_order_cnt_lsb_minus4: ue(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;sps.log2_max_pic_order_cnt_lsb_minus4));<br>  <span class="hljs-type">uint32_t</span> sps_sub_layer_ordering_info_present_flag = <span class="hljs-number">0</span>;<br>  <span class="hljs-comment">// sps_sub_layer_ordering_info_present_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;sps_sub_layer_ordering_info_present_flag, <span class="hljs-number">1</span>));<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = (sps_sub_layer_ordering_info_present_flag != <span class="hljs-number">0</span>) ? <span class="hljs-number">0</span> : sps_max_sub_layers_minus1;<br>       i &lt;= sps_max_sub_layers_minus1; i++) &#123;<br>    <span class="hljs-comment">// sps_max_dec_pic_buffering_minus1: ue(v)</span><br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;sps.sps_max_dec_pic_buffering_minus1[i]));<br>    <span class="hljs-comment">// sps_max_num_reorder_pics: ue(v)</span><br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;golomb_ignored));<br>    <span class="hljs-comment">// sps_max_latency_increase_plus1: ue(v)</span><br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;golomb_ignored));<br>  &#125;<br>  <span class="hljs-comment">// log2_min_luma_coding_block_size_minus3: ue(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;sps.log2_min_luma_coding_block_size_minus3));<br>  <span class="hljs-comment">// log2_diff_max_min_luma_coding_block_size: ue(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;sps.log2_diff_max_min_luma_coding_block_size));<br>  <span class="hljs-comment">// log2_min_luma_transform_block_size_minus2: ue(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;golomb_ignored));<br>  <span class="hljs-comment">// log2_diff_max_min_luma_transform_block_size: ue(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;golomb_ignored));<br>  <span class="hljs-comment">// max_transform_hierarchy_depth_inter: ue(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;golomb_ignored));<br>  <span class="hljs-comment">// max_transform_hierarchy_depth_intra: ue(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;golomb_ignored));<br>  <span class="hljs-comment">// scaling_list_enabled_flag: u(1)</span><br>  <span class="hljs-type">uint32_t</span> scaling_list_enabled_flag = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;scaling_list_enabled_flag, <span class="hljs-number">1</span>));<br>  <span class="hljs-keyword">if</span> (scaling_list_enabled_flag) &#123;<br>    <span class="hljs-comment">// sps_scaling_list_data_present_flag: u(1)</span><br>    <span class="hljs-type">uint32_t</span> sps_scaling_list_data_present_flag = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;sps_scaling_list_data_present_flag, <span class="hljs-number">1</span>));<br>    <span class="hljs-keyword">if</span> (sps_scaling_list_data_present_flag) &#123;<br>      <span class="hljs-comment">// scaling_list_data()</span><br>      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ParseScalingListData</span>(buffer)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">OptionalSps</span>();<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// amp_enabled_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ConsumeBits</span>(<span class="hljs-number">1</span>));<br>  <span class="hljs-comment">// sample_adaptive_offset_enabled_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;sps.sample_adaptive_offset_enabled_flag, <span class="hljs-number">1</span>));<br>  <span class="hljs-comment">// pcm_enabled_flag: u(1)</span><br>  <span class="hljs-type">uint32_t</span> pcm_enabled_flag = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;pcm_enabled_flag, <span class="hljs-number">1</span>));<br>  <span class="hljs-keyword">if</span> (pcm_enabled_flag) &#123;<br>    <span class="hljs-comment">// pcm_sample_bit_depth_luma_minus1: u(4)</span><br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ConsumeBits</span>(<span class="hljs-number">4</span>));<br>    <span class="hljs-comment">// pcm_sample_bit_depth_chroma_minus1: u(4)</span><br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ConsumeBits</span>(<span class="hljs-number">4</span>));<br>    <span class="hljs-comment">// log2_min_pcm_luma_coding_block_size_minus3: ue(v)</span><br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;golomb_ignored));<br>    <span class="hljs-comment">// log2_diff_max_min_pcm_luma_coding_block_size: ue(v)</span><br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;golomb_ignored));<br>    <span class="hljs-comment">// pcm_loop_filter_disabled_flag: u(1)</span><br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ConsumeBits</span>(<span class="hljs-number">1</span>));<br>  &#125;<br><br>  <span class="hljs-comment">// num_short_term_ref_pic_sets: ue(v)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;sps.num_short_term_ref_pic_sets));<br>  sps.short_term_ref_pic_set.<span class="hljs-built_in">resize</span>(sps.num_short_term_ref_pic_sets);<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> st_rps_idx = <span class="hljs-number">0</span>; st_rps_idx &lt; sps.num_short_term_ref_pic_sets; st_rps_idx++) &#123;<br>    <span class="hljs-comment">// st_ref_pic_set()</span><br>    OptionalShortTermRefPicSet ref_pic_set = <span class="hljs-built_in">ParseShortTermRefPicSet</span>(<br>        st_rps_idx, sps.num_short_term_ref_pic_sets, sps.short_term_ref_pic_set, sps, buffer);<br>    <span class="hljs-keyword">if</span> (ref_pic_set) &#123;<br>      sps.short_term_ref_pic_set[st_rps_idx] = *ref_pic_set;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">OptionalSps</span>();<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// long_term_ref_pics_present_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;sps.long_term_ref_pics_present_flag, <span class="hljs-number">1</span>));<br>  <span class="hljs-keyword">if</span> (sps.long_term_ref_pics_present_flag) &#123;<br>    <span class="hljs-comment">// num_long_term_ref_pics_sps: ue(v)</span><br>    <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadExponentialGolomb</span>(&amp;sps.num_long_term_ref_pics_sps));<br>    sps.used_by_curr_pic_lt_sps_flag.<span class="hljs-built_in">resize</span>(sps.num_long_term_ref_pics_sps, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; sps.num_long_term_ref_pics_sps; i++) &#123;<br>      <span class="hljs-comment">// lt_ref_pic_poc_lsb_sps: u(v)</span><br>      <span class="hljs-type">uint32_t</span> lt_ref_pic_poc_lsb_sps_bits = sps.log2_max_pic_order_cnt_lsb_minus4 + <span class="hljs-number">4</span>;<br>      <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ConsumeBits</span>(lt_ref_pic_poc_lsb_sps_bits));<br>      <span class="hljs-comment">// used_by_curr_pic_lt_sps_flag: u(1)</span><br>      <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;sps.used_by_curr_pic_lt_sps_flag[i], <span class="hljs-number">1</span>));<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// sps_temporal_mvp_enabled_flag: u(1)</span><br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;sps.sps_temporal_mvp_enabled_flag, <span class="hljs-number">1</span>));<br><br>  <span class="hljs-comment">// Far enough! We don&#x27;t use the rest of the SPS.</span><br><br>  sps.vps_id = sps_video_parameter_set_id;<br><br>  sps.pic_width_in_luma_samples = pic_width_in_luma_samples;<br>  sps.pic_height_in_luma_samples = pic_height_in_luma_samples;<br><br>  <span class="hljs-comment">// Start with the resolution determined by the pic_width/pic_height fields.</span><br>  sps.width = pic_width_in_luma_samples;<br>  sps.height = pic_height_in_luma_samples;<br><br>  <span class="hljs-keyword">if</span> (conformance_window_flag) &#123;<br>    <span class="hljs-type">int</span> sub_width_c = ((<span class="hljs-number">1</span> == sps.chroma_format_idc) || (<span class="hljs-number">2</span> == sps.chroma_format_idc)) &amp;&amp;<br>                              (<span class="hljs-number">0</span> == sps.separate_colour_plane_flag)<br>                          ? <span class="hljs-number">2</span><br>                          : <span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> sub_height_c =<br>        (<span class="hljs-number">1</span> == sps.chroma_format_idc) &amp;&amp; (<span class="hljs-number">0</span> == sps.separate_colour_plane_flag) ? <span class="hljs-number">2</span> : <span class="hljs-number">1</span>;<br>    <span class="hljs-comment">// the offset includes the pixel within conformance window. so don&#x27;t need to</span><br>    <span class="hljs-comment">// +1 as per spec</span><br>    sps.width -= sub_width_c * (conf_win_right_offset + conf_win_left_offset);<br>    sps.height -= sub_height_c * (conf_win_top_offset + conf_win_bottom_offset);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">OptionalSps</span>(sps);<br>&#125;<br><br>&#125;  <span class="hljs-comment">// namespace webrtc</span><br><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>common_video/h265/h265_sps_parser.h  >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> COMMON_VIDEO_H265_H265_SPS_PARSER_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMON_VIDEO_H265_H265_SPS_PARSER_H_</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;absl/types/optional.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> rtc &#123;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BitBuffer</span>;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> webrtc &#123;<br><br><span class="hljs-comment">// A class for parsing out sequence parameter set (SPS) data from an H265 NALU.</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">H265SpsParser</span> &#123;<br> <span class="hljs-keyword">public</span>:<br><br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ShortTermRefPicSet</span> &#123;<br>    <span class="hljs-built_in">ShortTermRefPicSet</span>();<br><br>    <span class="hljs-type">uint32_t</span> inter_ref_pic_set_prediction_flag = <span class="hljs-number">0</span>;<br>    std::vector&lt;<span class="hljs-type">uint32_t</span>&gt; used_by_curr_pic_flag;<br>    std::vector&lt;<span class="hljs-type">uint32_t</span>&gt; use_delta_flag;<br>    <span class="hljs-type">uint32_t</span> num_negative_pics = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> num_positive_pics = <span class="hljs-number">0</span>;<br>    std::vector&lt;<span class="hljs-type">uint32_t</span>&gt; delta_poc_s0_minus1;<br>    std::vector&lt;<span class="hljs-type">uint32_t</span>&gt; used_by_curr_pic_s0_flag;<br>    std::vector&lt;<span class="hljs-type">uint32_t</span>&gt; delta_poc_s1_minus1;<br>    std::vector&lt;<span class="hljs-type">uint32_t</span>&gt; used_by_curr_pic_s1_flag;<br>  &#125;;<br><br>  <span class="hljs-comment">// The parsed state of the SPS. Only some select values are stored.</span><br>  <span class="hljs-comment">// Add more as they are actually needed.</span><br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">SpsState</span> &#123;<br>    <span class="hljs-built_in">SpsState</span>();<br><br>    <span class="hljs-type">uint32_t</span> sps_max_sub_layers_minus1;<br>    <span class="hljs-type">uint32_t</span> chroma_format_idc = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> separate_colour_plane_flag = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> pic_width_in_luma_samples = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> pic_height_in_luma_samples = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> log2_max_pic_order_cnt_lsb_minus4 = <span class="hljs-number">0</span>;<br>    std::vector&lt;<span class="hljs-type">uint32_t</span>&gt; sps_max_dec_pic_buffering_minus1;<br>    <span class="hljs-type">uint32_t</span> log2_min_luma_coding_block_size_minus3 = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> log2_diff_max_min_luma_coding_block_size = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> sample_adaptive_offset_enabled_flag = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> num_short_term_ref_pic_sets = <span class="hljs-number">0</span>;<br>    std::vector&lt;H265SpsParser::ShortTermRefPicSet&gt; short_term_ref_pic_set;<br>    <span class="hljs-type">uint32_t</span> long_term_ref_pics_present_flag = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> num_long_term_ref_pics_sps = <span class="hljs-number">0</span>;<br>    std::vector&lt;<span class="hljs-type">uint32_t</span>&gt; used_by_curr_pic_lt_sps_flag;<br>    <span class="hljs-type">uint32_t</span> sps_temporal_mvp_enabled_flag = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> width = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> height = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> id = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> vps_id = <span class="hljs-number">0</span>;<br>  &#125;;<br><br>  <span class="hljs-comment">// Unpack RBSP and parse SPS state from the supplied buffer.</span><br>  <span class="hljs-function"><span class="hljs-type">static</span> absl::optional&lt;SpsState&gt; <span class="hljs-title">ParseSps</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* data, <span class="hljs-type">size_t</span> length)</span></span>;<br><br>  <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">ParseScalingListData</span><span class="hljs-params">(rtc::BitBuffer* buffer)</span></span>;<br><br>  <span class="hljs-function"><span class="hljs-type">static</span> absl::optional&lt;ShortTermRefPicSet&gt; <span class="hljs-title">ParseShortTermRefPicSet</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-type">uint32_t</span> st_rps_idx, <span class="hljs-type">uint32_t</span> num_short_term_ref_pic_sets,</span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-type">const</span> std::vector&lt;ShortTermRefPicSet&gt;&amp; ref_pic_sets,</span></span><br><span class="hljs-params"><span class="hljs-function">        SpsState&amp; sps, rtc::BitBuffer* buffer)</span></span>;<br><br> <span class="hljs-keyword">protected</span>:<br> <span class="hljs-comment">// Parse the SPS state, for a bit buffer where RBSP decoding has already been</span><br> <span class="hljs-comment">// performed.</span><br>  <span class="hljs-function"><span class="hljs-type">static</span> absl::optional&lt;SpsState&gt; <span class="hljs-title">ParseSpsInternal</span><span class="hljs-params">(rtc::BitBuffer* buffer)</span></span>;<br>&#125;;<br><br>&#125;  <span class="hljs-comment">// namespace webrtc</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>  <span class="hljs-comment">// COMMON_VIDEO_H265_H265_SPS_PARSER_H_</span></span><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>common_video/h265/h265_vps_parser.cc >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_common.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;common_video/h265/h265_vps_parser.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/bit_buffer.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rtc_base/logging.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> &#123;<br><span class="hljs-keyword">typedef</span> absl::optional&lt;webrtc::H265VpsParser::VpsState&gt; OptionalVps;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RETURN_EMPTY_ON_FAIL(x) \</span><br><span class="hljs-meta">  <span class="hljs-keyword">if</span> (!(x)) &#123;                   \</span><br><span class="hljs-meta">    return OptionalVps();       \</span><br><span class="hljs-meta">  &#125;</span><br>&#125;  <span class="hljs-comment">// namespace</span><br><br><span class="hljs-keyword">namespace</span> webrtc &#123;<br><br>H265VpsParser::VpsState::<span class="hljs-built_in">VpsState</span>() = <span class="hljs-keyword">default</span>;<br><br><span class="hljs-comment">// General note: this is based off the 06/2019 version of the H.265 standard.</span><br><span class="hljs-comment">// You can find it on this page:</span><br><span class="hljs-comment">// http://www.itu.int/rec/T-REC-H.265</span><br><br><span class="hljs-comment">// Unpack RBSP and parse SPS state from the supplied buffer.</span><br><span class="hljs-function">absl::optional&lt;H265VpsParser::VpsState&gt; <span class="hljs-title">H265VpsParser::ParseVps</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* data,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">size_t</span> length)</span> </span>&#123;<br>  std::vector&lt;<span class="hljs-type">uint8_t</span>&gt; unpacked_buffer = H265::<span class="hljs-built_in">ParseRbsp</span>(data, length);<br>  <span class="hljs-function">rtc::BitBuffer <span class="hljs-title">bit_buffer</span><span class="hljs-params">(unpacked_buffer.data(), unpacked_buffer.size())</span></span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">ParseInternal</span>(&amp;bit_buffer);<br>&#125;<br><br><span class="hljs-function">absl::optional&lt;H265VpsParser::VpsState&gt; <span class="hljs-title">H265VpsParser::ParseInternal</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    rtc::BitBuffer* buffer)</span> </span>&#123;<br>  <span class="hljs-comment">// Now, we need to use a bit buffer to parse through the actual HEVC VPS</span><br>  <span class="hljs-comment">// format. See Section 7.3.2.1 (&quot;Video parameter set RBSP syntax&quot;) of the</span><br>  <span class="hljs-comment">// H.265 standard for a complete description.</span><br><br>  VpsState vps;<br><br>  <span class="hljs-comment">// vps_video_parameter_set_id: u(4)</span><br>  vps.id = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">RETURN_EMPTY_ON_FAIL</span>(buffer-&gt;<span class="hljs-built_in">ReadBits</span>(&amp;vps.id, <span class="hljs-number">4</span>));<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">OptionalVps</span>(vps);<br>&#125;<br><br>&#125;  <span class="hljs-comment">// namespace webrtc</span><br><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>common_video/h265/h265_vps_parser.h >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> COMMON_VIDEO_H265_H265_VPS_PARSER_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMON_VIDEO_H265_H265_VPS_PARSER_H_</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;absl/types/optional.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> rtc &#123;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BitBuffer</span>;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> webrtc &#123;<br><br><span class="hljs-comment">// A class for parsing out sequence parameter set (VPS) data from an H265 NALU.</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">H265VpsParser</span> &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-comment">// The parsed state of the VPS. Only some select values are stored.</span><br>  <span class="hljs-comment">// Add more as they are actually needed.</span><br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">VpsState</span> &#123;<br>    <span class="hljs-built_in">VpsState</span>();<br><br>    <span class="hljs-type">uint32_t</span> id = <span class="hljs-number">0</span>;<br>  &#125;;<br><br>  <span class="hljs-comment">// Unpack RBSP and parse VPS state from the supplied buffer.</span><br>  <span class="hljs-function"><span class="hljs-type">static</span> absl::optional&lt;VpsState&gt; <span class="hljs-title">ParseVps</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* data, <span class="hljs-type">size_t</span> length)</span></span>;<br><br> <span class="hljs-keyword">protected</span>:<br>  <span class="hljs-comment">// Parse the VPS state, for a bit buffer where RBSP decoding has already been</span><br>  <span class="hljs-comment">// performed.</span><br>  <span class="hljs-function"><span class="hljs-type">static</span> absl::optional&lt;VpsState&gt; <span class="hljs-title">ParseInternal</span><span class="hljs-params">(rtc::BitBuffer* bit_buffer)</span></span>;<br>&#125;;<br><br>&#125;  <span class="hljs-comment">// namespace webrtc</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>  <span class="hljs-comment">// COMMON_VIDEO_H265_H265_VPS_PARSER_H_</span></span><br><br></code></pre></td></tr></table></figure>

<ul>
<li>将新增文件添加到ninja中参与构建：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">if</span> (rtc_use_h265) &#123;<br>  sources += [<br>    <span class="hljs-string">&quot;h265/h265_bitstream_parser.cc&quot;</span>,<br>    <span class="hljs-string">&quot;h265/h265_bitstream_parser.h&quot;</span>,<br>    <span class="hljs-string">&quot;h265/h265_common.cc&quot;</span>,<br>    <span class="hljs-string">&quot;h265/h265_common.h&quot;</span>,<br>    <span class="hljs-string">&quot;h265/h265_pps_parser.cc&quot;</span>,<br>    <span class="hljs-string">&quot;h265/h265_pps_parser.h&quot;</span>,<br>    <span class="hljs-string">&quot;h265/h265_sps_parser.cc&quot;</span>,<br>    <span class="hljs-string">&quot;h265/h265_sps_parser.h&quot;</span>,<br>    <span class="hljs-string">&quot;h265/h265_vps_parser.cc&quot;</span>,<br>    <span class="hljs-string">&quot;h265/h265_vps_parser.h&quot;</span>,<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="部分配置修改"><a href="#部分配置修改" class="headerlink" title="部分配置修改"></a>部分配置修改</h4><ul>
<li>log配置：</li>
</ul>
<figure class="highlight c++"><figcaption><span>logging/rtc_event_log/encoder/rtc_event_log_encoder_new_format.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c++">rtclog2::<span class="hljs-function">FrameDecodedEvents::Codec <span class="hljs-title">ConvertToProtoFormat</span><span class="hljs-params">(VideoCodecType codec)</span> </span>&#123;<br>  <span class="hljs-keyword">switch</span> (codec) &#123;<br>    ...<br>    <span class="hljs-keyword">case</span> VideoCodecType::kVideoCodecH264:<br>      <span class="hljs-keyword">return</span> rtclog2::FrameDecodedEvents::CODEC_H264;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>    <span class="hljs-keyword">case</span> VideoCodecType::kVideoCodecH265:<br>      <span class="hljs-keyword">return</span> rtclog2::FrameDecodedEvents::CODEC_H265;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-keyword">case</span> VideoCodecType::kVideoCodecMultiplex:<br>      <span class="hljs-comment">// This codec type is afaik not used.</span><br>      <span class="hljs-keyword">return</span> rtclog2::FrameDecodedEvents::CODEC_UNKNOWN;<br>  &#125;<br>  <span class="hljs-built_in">RTC_NOTREACHED</span>();<br>  <span class="hljs-keyword">return</span> rtclog2::FrameDecodedEvents::CODEC_UNKNOWN;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>logging/rtc_event_log/rtc_event_log2.proto</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c++">message FrameDecodedEvents &#123;<br>  <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Codec</span> &#123;<br>    CODEC_UNKNOWN = <span class="hljs-number">0</span>;<br>    CODEC_GENERIC = <span class="hljs-number">1</span>;<br>    CODEC_VP8 = <span class="hljs-number">2</span>;<br>    CODEC_VP9 = <span class="hljs-number">3</span>;<br>    CODEC_AV1 = <span class="hljs-number">4</span>;<br>    CODEC_H264 = <span class="hljs-number">5</span>;<br>    CODEC_H265 = <span class="hljs-number">6</span>;<br>  &#125;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>相关常量</li>
</ul>
<figure class="highlight c++"><figcaption><span>media/base/media_constants.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">const</span> <span class="hljs-type">char</span> kHEVCCodecName[] = <span class="hljs-string">&quot;H265X&quot;</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> kH265CodecName[] = <span class="hljs-string">&quot;H265&quot;</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">// RFC 6184 RTP Payload Format for H.264 video</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> kH264FmtpProfileLevelId[] = <span class="hljs-string">&quot;profile-level-id&quot;</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> kH264FmtpLevelAsymmetryAllowed[] = <span class="hljs-string">&quot;level-asymmetry-allowed&quot;</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> kH264FmtpPacketizationMode[] = <span class="hljs-string">&quot;packetization-mode&quot;</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> kH264FmtpSpropParameterSets[] = <span class="hljs-string">&quot;sprop-parameter-sets&quot;</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> kH264FmtpSpsPpsIdrInKeyframe[] = <span class="hljs-string">&quot;sps-pps-idr-in-keyframe&quot;</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> kH264ProfileLevelConstrainedBaseline[] = <span class="hljs-string">&quot;42e01f&quot;</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> kH264ProfileLevelConstrainedHigh[] = <span class="hljs-string">&quot;640c1f&quot;</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br><span class="hljs-comment">// RFC 7798 RTP Payload Format for H.265 video</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> kH265FmtpProfileSpace[] = <span class="hljs-string">&quot;profile-space&quot;</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> kH265FmtpProfileId[] = <span class="hljs-string">&quot;profile-id&quot;</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> kH265FmtpTierFlag[] = <span class="hljs-string">&quot;tier-flag&quot;</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> kH265FmtpLevelId[] = <span class="hljs-string">&quot;level-id&quot;</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>media/base/media_constants.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c++">RTC_EXPORT <span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> kHEVCCodecName[];<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br>RTC_EXPORT <span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> kH265CodecName[];<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">// RFC 6184 RTP Payload Format for H.264 video</span><br>RTC_EXPORT <span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> kH264FmtpProfileLevelId[];<br>RTC_EXPORT <span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> kH264FmtpLevelAsymmetryAllowed[];<br>RTC_EXPORT <span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> kH264FmtpPacketizationMode[];<br><span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> kH264FmtpSpropParameterSets[];<br><span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> kH264FmtpSpsPpsIdrInKeyframe[];<br><span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> kH264ProfileLevelConstrainedBaseline[];<br><span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> kH264ProfileLevelConstrainedHigh[];<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DISABLE_H265</span><br><span class="hljs-comment">// RFC 7798 RTP Payload Format for H.265 video</span><br>RTC_EXPORT <span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> kH265FmtpProfileSpace[];<br>RTC_EXPORT <span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> kH265FmtpProfileId[];<br>RTC_EXPORT <span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> kH265FmtpTierFlag[];<br>RTC_EXPORT <span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> kH265FmtpLevelId[];<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-type">int</span> kDefaultVideoMaxFramerate;<br></code></pre></td></tr></table></figure>
<h4 id="最后打开H265开关"><a href="#最后打开H265开关" class="headerlink" title="最后打开H265开关"></a>最后打开H265开关</h4><figure class="highlight c++"><figcaption><span>BUILD.gn</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">config</span>(<span class="hljs-string">&quot;common_inherited_config&quot;</span>) &#123;<br>...<br><br>  <span class="hljs-keyword">if</span> (!rtc_use_h265) &#123;<br>    defines += [ <span class="hljs-string">&quot;DISABLE_H265&quot;</span> ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>build_overrides/build.gni</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">if</span> (is_win || is_ios || is_android) &#123;<br>  rtc_use_h265 = <span class="hljs-literal">true</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  rtc_use_h265 = <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="end"><a href="#end" class="headerlink" title="end"></a>end</h4><p>漫长的修改后，WebRTC将支持H265，笔者在测试H265与H264的区别时，发现JitterBufferCache 减少140ms，果然是更复杂的算法、更高的压缩率。</p>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/open-webrtc-toolkit/owt-deps-webrtc">owt-deps-webrtc</a></li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>Android平台WebRTC开启H265编解码</p><p><a href="http://hanniballol.github.io/2022/09/29/Android平台WebRTC开启H265编解码/">http://hanniballol.github.io/2022/09/29/Android平台WebRTC开启H265编解码/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>8MilesRD</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022-09-29</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022-09-30</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Android/">Android</a><a class="link-muted mr-2" rel="tag" href="/tags/shell/">shell</a><a class="link-muted mr-2" rel="tag" href="/tags/C-C/">C/C++</a></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/images/aliPay.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/images/wechatPay.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/09/28/Android%E5%B9%B3%E5%8F%B0WebRTC%E5%BC%80%E5%90%AFH264%E8%BD%AF%E7%BC%96%E8%A7%A3%E7%A0%81/"><span class="level-item">Android平台WebRTC开启H264软编解码</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'http://hanniballol.github.io/2022/09/29/Android%E5%B9%B3%E5%8F%B0WebRTC%E5%BC%80%E5%90%AFH265%E7%BC%96%E8%A7%A3%E7%A0%81/';
            this.page.identifier = '2022/09/29/Android平台WebRTC开启H265编解码/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'hexo-blog-10' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/images/avatar.png" alt="Hanniballol"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Hanniballol</p><p class="is-size-6 is-block">取之不尽，用之不竭</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>ChangSha</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">32</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">10</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">19</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Hanniballol" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Hanniballol"><i class="fab fa-github"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Android/"><span class="level-start"><span class="level-item">Android</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/categories/Flutter/"><span class="level-start"><span class="level-item">Flutter</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Kotlin/"><span class="level-start"><span class="level-item">Kotlin</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/MediaPipe/"><span class="level-start"><span class="level-item">MediaPipe</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Tools/"><span class="level-start"><span class="level-item">Tools</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/WebRTC/"><span class="level-start"><span class="level-item">WebRTC</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/iOS/"><span class="level-start"><span class="level-item">iOS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/life/"><span class="level-start"><span class="level-item">life</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/openGL/"><span class="level-start"><span class="level-item">openGL</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E9%9A%8F%E7%AC%94/"><span class="level-start"><span class="level-item">随笔</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-09-29T03:41:08.000Z">2022-09-29</time></p><p class="title"><a href="/2022/09/29/Android%E5%B9%B3%E5%8F%B0WebRTC%E5%BC%80%E5%90%AFH265%E7%BC%96%E8%A7%A3%E7%A0%81/">Android平台WebRTC开启H265编解码</a></p><p class="categories"><a href="/categories/WebRTC/">WebRTC</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-09-28T08:33:01.000Z">2022-09-28</time></p><p class="title"><a href="/2022/09/28/Android%E5%B9%B3%E5%8F%B0WebRTC%E5%BC%80%E5%90%AFH264%E8%BD%AF%E7%BC%96%E8%A7%A3%E7%A0%81/">Android平台WebRTC开启H264软编解码</a></p><p class="categories"><a href="/categories/WebRTC/">WebRTC</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-25T06:19:43.000Z">2022-07-25</time></p><p class="title"><a href="/2022/07/25/Filament%E5%AE%9E%E7%8E%B0%E7%AE%80%E6%98%93Animoji/">Filament实现简易Animoji</a></p><p class="categories"><a href="/categories/openGL/">openGL</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-28T09:34:03.000Z">2021-04-28</time></p><p class="title"><a href="/2021/04/28/MediaPipe%E5%9C%A8Android%E5%B9%B3%E5%8F%B0%E4%B8%8A%E6%9E%84%E5%BB%BAAAR/">MediaPipe在Android平台上构建AAR</a></p><p class="categories"><a href="/categories/MediaPipe/">MediaPipe</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-09-19T01:41:56.000Z">2020-09-19</time></p><p class="title"><a href="/2020/09/19/%E5%B0%86Flutter%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%B7%B2%E6%9C%89%E7%9A%84%E9%A1%B9%E7%9B%AE%E4%B8%AD/">将Flutter添加到已有的项目中</a></p><p class="categories"><a href="/categories/Flutter/">Flutter</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/09/"><span class="level-start"><span class="level-item">九月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">一月 2020</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">十一月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">七月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">三月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/10/"><span class="level-start"><span class="level-item">十月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">六月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/05/"><span class="level-start"><span class="level-item">五月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">三月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/11/"><span class="level-start"><span class="level-item">十一月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android-Studio/"><span class="tag">Android Studio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/C-C/"><span class="tag">C/C++</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Flutter/"><span class="tag">Flutter</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kotlin/"><span class="tag">Kotlin</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Tensorflow/"><span class="tag">Tensorflow</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Test-automation/"><span class="tag">Test automation</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/View/"><span class="tag">View</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/adb/"><span class="tag">adb</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cocoaPods/"><span class="tag">cocoaPods</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dart/"><span class="tag">dart</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">git</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gradle/"><span class="tag">gradle</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/life/"><span class="tag">life</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/shell/"><span class="tag">shell</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/syntactic-sugar/"><span class="tag">syntactic sugar</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/system/"><span class="tag">system</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><span class="tag">设计模式</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9A%8F%E6%84%8F/"><span class="tag">随意</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="card widget" data-type="adsense"><div class="card-content"><div class="menu"><h3 class="menu-label">广告</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1027133152234043" data-ad-slot="5899645396" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/favicon.ico" alt="Hanniballol&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 8MilesRD</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>